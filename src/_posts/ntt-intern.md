---
caterory: activity
tags:
    - intern
    - ntt
    - network
    - srv6
date: 2021-03-10
title: NTTコミュニケーションズの職場体験型インターンシップに参加しました
description: 2/15~2/26で開催されたNTTコミュニケーションズさんの職場体験型インターンシップに参加しました．二週間でSRv6を用いたネットワーク検証を行いました．
---

こんにちは．最近は呪術廻戦をアニメで見て漫画を全巻揃えてしまいました．いつになってもバトル漫画は良いものです．今回はNTTコミュニケーションズさんにより開催されたインターンシップに参加して二週間ネットワークをゴニョゴニョしてきました．

## 参加まで

### 応募
本インターンシップの存在は友人に教えられて知りました．インターンシップの内容が非常に興味深いものばかりだったためどのポストに応募するか非常に悩みましたが**次世代キャリアネットワーク(Autonomous Network)開発エンジニア**というポストに応募することにしました．業務内容はSegment Routingを用いたネットワーク構築や制御の検証/開発というものでした．

### 選考
選考はエントリーシートを提出してから何回かの面接・面談を経て合格の連絡をいただきました．
Segment Routingなどルーティングプロトコルに関して完全に素人なのに選んでいただきありがたかったです．

### 本番まで
インターンシップ本番までにインターンシップで使用するMacと大量のお菓子と飲み物が届きました．残念ながら写真を撮り忘れてしまいましたが非常に美味しくいただきました．

## 取り組んだこと
上述しましたが僕が今回参加させていただいたポストは次世代キャリアネットワーク(Autonomous Network)開発エンジニアです．
業務内容は次世代商用インフラを想定した検証ネットワークの構築というものでした．SRv6という新しい経路制御技術を用いてネットワークを構築・経路制御を検証しました．

### 背景
背景としてコストがあります．サービスや目的ごとに個別のネットワークを所有することは運用コストや設備コストがかかります．複数のネットワークを統一して構築・運用することでコストを削減することができると考えられます．そこで有用だと考えられる技術がSRv6です．SRv6は既存のIPv6網を使用して構築することができ，シンプルなネットワーク構成を保つことができます．また，Function機能などを有しており拡張性などにも優れています．そのため，今回のインターンシップではSRv6を用いたネットワークの検証を行いました．

### SRv6
軽くSRv6という技術について触れます．SRv6に関して僕は有識者ではないためここは資料を参考に概要程度に留めます．詳細は参考資料を参照ください．

#### 概要
SRv6とはSegment Routing IPv6の略です．名前の通りセグメントルーティングを実現する技術で，その基盤にIPv6を使用します．
セグメントルーティングでは事前に設定したルーティングポリシーをパケットに格納して転送することでより柔軟な経路制御を実現することができます．
セグメントルーティングを実現する手法としてMPLSを利用するSR-MPLSとIPv6を利用するSRv6があります．今回SR-MPLSについては触れません(詳しくないので)．
SRv6ではIPv6の拡張ヘッダを用いてSRH(SR Header)を付与します．SRHに経路ポリシーを定義することでSRv6を解釈できるネットワーク内で柔軟に経路制御を行うことができます．
また，SRv6においてパケットの処理方法を識別する識別子(SID)はIPv6アドレスを使用します．

SRv6 SIDには
- *Locator*: セグメントをペアレントノードへRouteするためのビット
- *Function*: ペアレントノードにおいて取られるActionを示すビット
- *Argument(Optional)*: 最後のビットはFunctionで参照される引数

の三つのフィールドがあります．
ここで僕が驚いたことはIPv6アドレス自体にfunctionなどの役割を持たせていることです．アドレスにアドレス以外の役割を持たせることに慣れるのに時間がかかりました．
Functionフィールドにパケットが到着したノードが行うべき処理を定義することで様々な機能を実現しています．

#### 特徴
SRv6の特徴をいくつか紹介します．
- データプレーンにIPv6を使用
	- SRv6に対応していないIPv6ネットワークをそのまま土管として使用することができる
	- IPv6アドレスをSIDとして使用
- SRHの付与方法にはEncapulationモードとInsert(Inline)モードがある
	- EncapモードはIPv4などに対応可能
	- Insertモードはパケット長を削減可能
- SRv6 functionによる高い拡張性
	- Well known functionがいくつか定義されている
	- 任意の機能を追加可能

#### SRv6のユースケース
##### Traffic Engineering
Traffic Engineeringはポリシーに従い経路を柔軟に制御する技術のことを指します．SRv6を用いてトラフィックエンジニアリングを実現することで目的に合わせたネットワークの運用が可能になります．

##### Service Function Chaining
Service Function Chainingはネットワーク上の機器を特定の順番で繋ぎ，サービスとして提供する技術です．特定のソースからのパケットに対して飲みファイアウォールを通したいというような状況で有効です．

#### 参考資料
- [セグメントルーティングとは？ | NTTデータ先端技術株式会社](https://www.intellilink.co.jp/article/column/5G-SR01.html)
- [高速ソフトウェアPCルーター「Kamuee」を用いたSRv6の実証実験に成功](https://www.ntt.com/about-us/press-releases/news/article/2019/0614.html)
- [JANOG40_SR_Tutorial](https://www.janog.gr.jp/meeting/janog40/application/files/2415/0051/7614/janog40-sr-kamata-takeda-00.pdf)

### 検証
今回検証したのは以下についてです．
- End.DT6というSRv6 Functionを使用したIPv6 over IPv6のL3VPNの実現
- End.DX4を使用したIPv4 over IPv6のL3VPNの実現
- SRv6を用いた柔軟な経路制御
- End.ATを使用したService Function ChainingとそのXDP実装の検証

それぞれを軽く紹介します．
#### End.DT6というSRv6 Functionを使用したIPv6 over IPv6のL3VPNの実現
今回の検証では図のようなネットワークを検証に用いました．
![ntt-fig1](/img/ntt-fig1.png)
検証ネットワークではTenant-AとTenant-Bという二つのテナントが用意されていて，二つのテナントは同一のSR domain(SRv6が有効なネットワーク)に接続されています．Tenant-A, BはそれぞれRouter-1, 4でVRF A, Bにそれぞれ属しており経路制御がなされています．
今回は`End.DT6`というFunctionを用いて属するVRFに応じて任意に異なる経路を選択できるように設定し疎通を検証しました．
SRv6の設定追加に関してはLinuxの`iproute2`を使用します．詳細は割愛しますがいくつかのSRv6 Functionに対応しています．

`End.Dt6`はIPv6 over IPv6 L3VPNを実現するFunctionでSR domainの入り口に到着したIPv6パケットに対して宛先を見てSRHを付加(Encap or Insert)して予め定義されたポリシーに従って次のノードに向けて送出します．各ノードはSRHを参照し次のノードを判別し転送し，出口ノードに到達するとSRHをDecapして転送します．

##### 結果
`End.DT6`を使用したL3VPNは問題なく実現することができました．
例として
VRF Aに属するノードに対しては
```
hostA-1 -> router-1 -> router-2 -> router-4 -> hostA-2
```
VRF Bに属するノードに対しては
```
hostB-1 -> router-1 -> router-3 -> router-4 -> hostB-2
```
というルーティグを設定して正常に疎通しました．検証では`ping`と`tcpdump`を使用して確認しました．
一方で，`End.DT6`にはEncapモードとInsertモードがあります．今回使用した`iproute2`ではEncapモードは正常に動作しますが，Insertモードは実装が完全ではなくInsert自体は行われますが，出口で正常にDecapが行われないということが判明しました．

#### End.DX4を使用したIPv4 over IPv6のL3VPNの実現
検証ネットワークとして図のようなネットワークのTenant-Cを使用しました．
![ntt-fig2](/img/ntt-fig2.png)
`End.DX4`はIPv4 over IPv6の L3VPN Per-CEを実現するFunctionです．SR domainの入り口ノードに到着したIPv4パケットに対して入り口ノードは経路表を参照しSRHを付加します．その後はEnd.DT6の際と同様に転送し，出口ノードにてDecapし，予め設定されているNext Hopのアドレスに対して転送します．

##### 結果
こちらも同様に問題なく動作しました．

#### SRv6を用いた柔軟な経路制御
こちらでは上で作成したEnd.DT6, End.DX4の設定を施したネットワークに対して様々な経路を定義して定義通りに転送されるかを検証しました．

##### ループを作ってみる
経路定義にてループを定義してみました．通常のネットワークではループを定義することはできないのでこのような定義ができるのはSRならではと言えます．
具体的には
```
hostA-1 -> router-1 -> router-2 -> router-3 -> router-1 -> router-2 -> router-4 -> hostA-2
```
のような経路を定義して疎通が確認できました．

##### SR domain内のあるノードに対してSRを無効化しても正常に転送される
SRv6の特徴にIPv6ネットワークをバックボーンのネットワークとして使用できることがあります．これはSR domain内でSRv6が有効でないノードが存在していたとしてもSRv6は正常にパケットを転送できるように設計されているためです．
SR domain内においてSRv6が有効な各ノードはパケットを次の宛先に転送する際にIPv6の宛先アドレスを書き換えながら転送されます．従って，次の宛先ノードとの間にSRv6が有効でないノードがあったとしても正常に転送できるようになっています．
具体的にrouter-2に対してSRv6を無効化して
```
hostA-1 -> router-1 -> router-4 -> hostA-2
```
のようなSRv6の経路を設定してもrouter-1, router-4間のバックボーンネットワークで最短経路としてrouter-2を経由するように定義されているためパケットは
```
hostA-1 -> router-1 -> (router-2) -> router-4 -> hostA-2
```
という風に転送されました．

#### End.ATを使用したService Function ChainingとそのXDP実装の検証
Service Function Chainingを実現するためのFunctionとして`End.AT`が提案されています．こちらは`iproute2`には実装されていないため，NTTコミュニケーションズのedenさんが作成されたXDPを用いた実装を使用して検証しました．
リポジトリはこちら [edenden/end.ac](https://github.com/edenden/end.ac)
検証ネットワークはEnd.DX4で使用したネットワークを使用しました．
router-5で`End.AT`のプログラムを動作させて検証します．
`End.AT`はService Function Chainingを実現するためにSR domain外で動作するFunction(サービス)にパケットを転送する機能を提供します．そのために`End.AT`では一度SRHをDecapしてFunctionにパケットを渡します．この時，Functionから帰ってくるパケットに対してもう一度SRHを適切に付加する必要があるためSRHをキャッシュしておきDecapしたIPv4パケットのTOSフィールドに識別値を埋め込んで送出します．帰ってきたパケットのTOSフィールドを確認して対応するSRHをもう一度付加することで正常な転送を実現しています．

##### 結果
XDPを使用するプログラムを動作させることは特別な設定が必要だったり特定用途に限定して実装してるため動作させることに少し苦労しましたが社員の方々にサポートしていただきながらなんとか検証することができました．
実際にService Function Chainingが動作していることを確認できてよかったです．
また，XDPのプログラムを自分で変更して動作させることに挑戦しましたがタイムアップとなってしまいました．残念です．

## まとめ
今回はSRv6という新しい技術で自分自身前提となる知識もほとんどない技術に挑戦させていただく機会をいただきました．
新しい技術を学ぶことはいつでも楽しいものです．
今回のインターンシップを通してネットワークやパケット処理に対して興味が深まりました．
貴重な機会をいただいたNTTコミュニケーションズ様に感謝します．
また，メンターの方をはじめとした社員の方々には全日程リモート開催にもかかわらず懇親会やLT会など期間中様々な企画を開催していただきありがとうございました．

最後に本ブログを執筆するために資料の使用を快く許諾していただきましてありがとうございます．非常に楽しいインターンシップでした．

