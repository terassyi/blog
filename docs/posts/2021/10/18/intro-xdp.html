<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>XDP入門 | terassyi</title>
    <meta name="description" content="XDPに入門します">
    <meta name="generator" content="VuePress 1.4.0">
    <meta property="article:published_time" content="2021-10-18T00:00:00.000Z"><meta property="article:modified_time" content="2021-11-17T10:47:46.000Z"><meta property="og:site_name" content="terassyi"><meta property="og:title" content="XDP入門"><meta property="og:description" content="XDPに入門します"><meta property="og:type" content="website"><meta property="og:url" content="/posts/2021/10/18/intro-xdp.html"><meta name="twitter:title" content="XDP入門"><meta name="twitter:description" content="XDPに入門します"><meta name="twitter:url" content="/posts/2021/10/18/intro-xdp.html"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:label2" content="Filed under"><meta name="twitter:data2" content="xdp, ebpf, cilium, golang"><meta property="article:tag" content="xdp"><meta property="article:tag" content="ebpf"><meta property="article:tag" content="cilium"><meta property="article:tag" content="golang">
    <link rel="preload" href="/assets/css/0.styles.59c2fb62.css" as="style"><link rel="preload" href="/assets/js/app.cc7256d4.js" as="script"><link rel="preload" href="/assets/js/12.4d6eb347.js" as="script"><link rel="preload" href="/assets/js/6.aca649e2.js" as="script"><link rel="prefetch" href="/assets/js/1.9488b48a.js"><link rel="prefetch" href="/assets/js/10.efc9cfb5.js"><link rel="prefetch" href="/assets/js/11.5728e224.js"><link rel="prefetch" href="/assets/js/13.6db52908.js"><link rel="prefetch" href="/assets/js/14.9c9db02b.js"><link rel="prefetch" href="/assets/js/15.6dd7a565.js"><link rel="prefetch" href="/assets/js/16.6e7bb4ac.js"><link rel="prefetch" href="/assets/js/17.fc9224de.js"><link rel="prefetch" href="/assets/js/18.f8f396a1.js"><link rel="prefetch" href="/assets/js/19.fe2e9545.js"><link rel="prefetch" href="/assets/js/20.ded1df28.js"><link rel="prefetch" href="/assets/js/21.426084ae.js"><link rel="prefetch" href="/assets/js/22.70d91b7f.js"><link rel="prefetch" href="/assets/js/23.781271b7.js"><link rel="prefetch" href="/assets/js/24.b18cd5f9.js"><link rel="prefetch" href="/assets/js/25.3ee7294d.js"><link rel="prefetch" href="/assets/js/26.d0706852.js"><link rel="prefetch" href="/assets/js/27.00b96b04.js"><link rel="prefetch" href="/assets/js/28.7c1ec69c.js"><link rel="prefetch" href="/assets/js/29.8b7d274d.js"><link rel="prefetch" href="/assets/js/3.cf0885eb.js"><link rel="prefetch" href="/assets/js/30.90df9ce3.js"><link rel="prefetch" href="/assets/js/31.3817f433.js"><link rel="prefetch" href="/assets/js/32.df3f02e8.js"><link rel="prefetch" href="/assets/js/33.66ef805f.js"><link rel="prefetch" href="/assets/js/34.36451a26.js"><link rel="prefetch" href="/assets/js/35.3e9fe6f0.js"><link rel="prefetch" href="/assets/js/36.01876cc2.js"><link rel="prefetch" href="/assets/js/37.676113a0.js"><link rel="prefetch" href="/assets/js/38.970b3b22.js"><link rel="prefetch" href="/assets/js/4.59bc91a6.js"><link rel="prefetch" href="/assets/js/5.e68093aa.js"><link rel="prefetch" href="/assets/js/7.c247a24b.js"><link rel="prefetch" href="/assets/js/8.c7816519.js"><link rel="prefetch" href="/assets/js/9.8a945f7c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.59c2fb62.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-meteorlxy"><header class="header" style="background-size:cover;background-repeat:no-repeat;background-position:center;background-attachment:scroll;background-image:url(/img/bg.jpg);" data-v-7a046aea><div data-v-e4145d0a data-v-7a046aea><nav class="navbar" data-v-e4145d0a><div class="container" data-v-e4145d0a><a href="/" class="router-link-active" data-v-e4145d0a><span class="navbar-site-name" data-v-e4145d0a>
          terassyi
        </span></a> <div class="navbar-toggler" data-v-e4145d0a><svg class="icon" style="font-size:1.2em;" data-v-e4145d0a data-v-e4145d0a><title data-v-e4145d0a data-v-e4145d0a>menu</title><use xlink:href="#icon-menu" data-v-e4145d0a data-v-e4145d0a></use></svg></div> <div class="navbar-links" data-v-e4145d0a><a href="/" class="navbar-link" data-v-e4145d0a>
            Home
          </a><a href="/posts/" class="navbar-link router-link-active" data-v-e4145d0a>
            Posts
          </a><a href="/about/" class="navbar-link" data-v-e4145d0a>
            About
          </a></div></div></nav> <div class="navbar-holder" style="display:none;" data-v-e4145d0a></div></div> <div class="banner" data-v-98d6aa8c data-v-7a046aea data-v-7a046aea><div class="container" data-v-98d6aa8c><div class="center" data-v-98d6aa8c><h1 data-v-98d6aa8c data-v-7a046aea>
          XDP入門
        </h1></div></div></div></header> <div class="container clearfix show-aside" data-v-4dd605a1 data-v-4dd605a1><main class="main" data-v-4dd605a1><div class="post" data-v-4dd605a1 data-v-4dd605a1><section class="post-meta main-div" data-v-4e23451f><section class="post-date clearfix" data-v-4e23451f><span class="create-date" data-v-4e23451f>
      Created : 2021-10-18
    </span> <span class="update-date" data-v-4e23451f>
      Updated : 2021-11-17
    </span></section> <section class="post-links" data-v-4e23451f><a href="/posts/2021/10/07/use-xdpcap.html" class="post-link" data-v-4e23451f>
      Previous Post : Goのcilium/ebpfでXdpcapを使う
    </a> <!----></section></section> <article class="main-div"><div class="post-content content content__default"><p>こんにちは．閃光のハサウェイが配信開始されたので早速視聴しました．メッサーがいいですね．</p> <p>前回もXDP関連の話題でしたが，今回はXDPに入門します．
XDPを学習する際のロードマップやつまりどころの解消になればと思います．</p> <h2 id="xdp"><a href="#xdp" class="header-anchor">#</a> XDP</h2> <p>XDPとはeXpress Data Pathの略でLinuxカーネル内で動作するeBPFベースの高性能なパケット処理技術です．
制限のあるC言語で記述したプログラムをBPFバイトコードにコンパイルし，NICにアタッチすることでカーネルのプロトコルスタックより手前でパケット処理を行うことができます．
XDPには以下のようなメリットがあります．</p> <ul><li>カーネルを修正することなく柔軟にパケット処理機能を実装することができる</li> <li>特別なハードウェアを準備することなく利用することができる</li> <li>高速にパケットを処理することができる</li> <li>既存のTCP/IPスタックを置き換えることなく協調して動作させることができる</li></ul> <h2 id="ユースケース"><a href="#ユースケース" class="header-anchor">#</a> ユースケース</h2> <p>XDPのユースケースとして以下のようなものがあります．</p> <ul><li>DDos攻撃の軽減
<ul><li><a href="https://blog.cloudflare.com/l4drop-xdp-ebpf-based-ddos-mitigations/" target="_blank" rel="noopener noreferrer">Cloudflare Gatebot<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li> <li>L4ロードバランサ
<ul><li><a href="https://engineering.fb.com/2018/05/22/open-source/open-sourcing-katran-a-scalable-network-load-balancer/" target="_blank" rel="noopener noreferrer">Facebook Katran<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://speakerdeck.com/line_devday2019/software-engineering-that-supports-line-original-lbaas" target="_blank" rel="noopener noreferrer">LINE<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li> <li>NAT
<ul><li><a href="https://speakerdeck.com/mabuchin/zhuan-binagaramonetutowakuchu-li-wo-sohutoueadezi-zuo-siteikuhua" target="_blank" rel="noopener noreferrer">XFLAG<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li> <li>Packet filtering
<ul><li><a href="https://cilium.io/" target="_blank" rel="noopener noreferrer">Cilium<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li> <li>Router</li></ul> <h2 id="アーキテクチャ-仕組み"><a href="#アーキテクチャ-仕組み" class="header-anchor">#</a> アーキテクチャ(仕組み)</h2> <p>XDPプログラムはC言語として記述し，BPFバイトコードにコンパイルします．
また，BPF Verifierによりメモリアクセスやループなどを静的に検査してNICにロードします．</p> <p>プログラムがアタッチされるとパケットの着信の度にNICのデバイスドライバ内でフックされてプログラムが実行されます．
そのため<code>sk_buff</code>が生成されるより前の段階でパケットを編集することができます．
<img src="/img/xdp-packet-processing.png" alt="xdp-packet-processing"></p> <h3 id="xdp-actions"><a href="#xdp-actions" class="header-anchor">#</a> XDP Actions</h3> <p>XDPプログラムはそのXDP Actions(終了コード)によってパケットを制御します．
サポートされているXDP Actionsは以下です．</p> <ul><li>XDP_PASS
<ul><li>パケットをOSのプロトコルスタックに流す.</li></ul></li> <li>XDP_DROP
<ul><li>パケットをドロップする.</li></ul></li> <li>XDP_TX
<ul><li>パケットを受信したNICから送出する．</li></ul></li> <li>XDP_ABORTED
<ul><li>BPFのエラーを返す際に使用する．パケットはドロップする．</li></ul></li> <li>XDP_REDIRECT
<ul><li>受信したパケットを<code>DEVMAP</code>に登録されたNICから送出する．</li></ul></li></ul> <h3 id="bpf-map"><a href="#bpf-map" class="header-anchor">#</a> BPF Map</h3> <p>BPFプログラムはカーネル内にロードされます．BPFプログラム(カーネル空間)とユーザー空間でデータをやり取りする手段としてBPFマップがあります．</p> <p><img src="/img/Linux-kernel-eBPF-architecture.png" alt="Linux-kernel-eBPF-architecture"></p> <p>BPFマップは任意の型のKey-Value連想配列です．bpfシステムコールによって作成，値の追加，削除，参照などが行われます．</p> <h3 id="bpf-map-type"><a href="#bpf-map-type" class="header-anchor">#</a> BPF Map Type</h3> <p>BPFマップはその用途に対して25種類のタイプが存在します．
ユーザーは自身の用途に合わせたマップを使用することができます．
各タイプは以下のようになっています．</p> <ul><li>BPF_MAP_TYPE_UNSPEC</li> <li><strong>BPF_MAP_TYPE_HASH</strong> <ul><li>単純なハッシュ．</li></ul></li> <li><strong>BPF_MAP_TYPE_ARRAY</strong> <ul><li>単純な配列．要素の削除はできない</li></ul></li> <li><strong>BPF_MAP_TYPE_PROG_ARRAY</strong> <ul><li><code>tail_call</code>(詳しくは前エントリ(<a href="https://terassyi.net/posts/2021/10/07/use-xdpcap.html#%E6%89%8B%E6%B3%95" target="_blank" rel="noopener noreferrer">Goのcilium/ebpfでXdpcapを使う<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>))のジャンプテーブルとして使用される配列</li></ul></li> <li><strong>BPF_MAP_TYPE_PERF_EVENT_ARRAY</strong> <ul><li><code>bpf_perf_event_output()</code>の結果が保持される．ユーザースペースのプログラムはそれをpoll()してあげる．</li></ul></li> <li><strong>BPF_MAP_TYPE_PERCPU_HASH</strong> <ul><li>CPUごとに割り当てられるハッシュ．</li></ul></li> <li><strong>BPF_MAP_TYPE_PERCPU_ARRAY</strong> <ul><li>CPUごとに割り当てられた配列．</li></ul></li> <li>BPF_MAP_TYPE_STACK_TRACE</li> <li>BPF_MAP_TYPE_CGROUP_ARRAY</li> <li><strong>BPF_MAP_TYPE_LRU_HASH</strong> <ul><li>LRUハッシュ</li></ul></li> <li><strong>BPF_MAP_TYPE_LRU_PERCPU_HASH</strong> <ul><li>CPUごとのLRUハッシュ</li></ul></li> <li><em><strong>BPF_MAP_TYPE_LPM_TRIE</strong></em> <ul><li>longest-prefixマッチをサポートしたマップ．ルートテーブルなどを作る際に使用する．</li></ul></li> <li>BPF_MAP_TYPE_ARRAY_OF_MAPS</li> <li>BPF_MAP_TYPE_HASH_OF_MAPS</li> <li><em><strong>BPF_MAP_TYPE_DEVMAP</strong></em> <ul><li><code>bpf_redirect()</code>に使用する．NIC間のリダイレクト用．</li></ul></li> <li>BPF_MAP_TYPE_SOCKMAP</li> <li>BPF_MAP_TYPE_CPUMAP</li> <li>BPF_MAP_TYPE_XSKMAP</li> <li>BPF_MAP_TYPE_SOCKHASH</li> <li>BPF_MAP_TYPE_CGROUP_STORAGE</li> <li>BPF_MAP_TYPE_REUSEPORT_SOCKARRAY</li> <li>BPF_MAP_TYPE_PERCPU_CGROUP_STORAGE</li> <li>BPF_MAP_TYPE_QUEUE</li> <li>BPF_MAP_TYPE_STACK</li> <li>BPF_MAP_TYPE_SK_STORAGE</li></ul> <p>たくさんあります．
しかし，BPF(XDP)を使う際によく使うマップはそんなに種類はなく,<strong>太字</strong>にしているものくらいだと思います．</p> <ul><li><a href="https://blogs.oracle.com/linux/post/bpf-in-depth-communicating-with-userspace" target="_blank" rel="noopener noreferrer">BPF In Depth: Communicating with Userspace<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://man7.org/linux/man-pages/man2/bpf.2.html" target="_blank" rel="noopener noreferrer">bpf(2) - Linux manual page - man7.org<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h3 id="ヘルパー関数"><a href="#ヘルパー関数" class="header-anchor">#</a> ヘルパー関数</h3> <p>BPFマップの作成や参照，更新は<a href="https://man7.org/linux/man-pages/man2/bpf.2.html" target="_blank" rel="noopener noreferrer">bpfシステムコール<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>を呼び出すことで行われます．
定義は以下です．</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">bpf</span><span class="token punctuation">(</span><span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">union</span> bpf_attr <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>linux/bpf.h</code>をインクルードすると使えるとのことですが，通常の環境では定義がありません．
そのためbpfシステムコールを直で使うのは結構大変です．</p> <p>そこで，BPFマップの扱いを簡潔にする<a href="https://man7.org/linux/man-pages/man7/bpf-helpers.7.html" target="_blank" rel="noopener noreferrer">ヘルパー関数<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>が用意されています．
マップの操作に限らず様々なヘルパー関数が定義されています．
ここでは頻繁に使用する関数のみ見ていきます．他の関数が気になる方は<a href="https://man7.org/linux/man-pages/man7/bpf-helpers.7.html" target="_blank" rel="noopener noreferrer">man page<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>をのぞいてみてください．</p> <h4 id="マップ関連"><a href="#マップ関連" class="header-anchor">#</a> マップ関連</h4> <ul><li><code>void *bpf_map_lookup_elem(struct bpf_map *map, const void *key)</code> <ul><li>keyに対応するvalueを探す</li> <li>値のポインタがNULLかチェックが必要</li></ul></li> <li><code>long bpf_map_update_elem(struct bpf_map *map, const void *key, const void *value, u64 flags)</code> <ul><li>keyに対応するvalueの値を更新する</li> <li>flagsに渡す値によって値がすでに存在している場合の挙動などを指定する</li> <li><code>flags = 0</code>で新規に値を追加できる</li></ul></li> <li><code>long bpf_map_delete_elem(struct bpf_map *map, const void *key)</code> <ul><li>keyに対応するエントリを削除する</li></ul></li></ul> <h4 id="デバッグ"><a href="#デバッグ" class="header-anchor">#</a> デバッグ</h4> <ul><li><code>long bpf_trace_printk(const char *fmt, u32 fmt_size, ...)</code> <ul><li>デバッグのためにメッセージを出力する</li> <li><code>/sys/kernel/debug/tracing/trace_pipe</code>に出力されるので<code>cat</code>などで読む</li></ul></li></ul> <h4 id="xdpで使う"><a href="#xdpで使う" class="header-anchor">#</a> XDPで使う</h4> <ul><li><code>long bpf_fib_lookup(void *ctx, struct bpf_fib_lookup *params, int plen, u32 flags)</code> <ul><li>FIB(Forwarding Information Base)(ルートテーブル)を参照することができる</li> <li><a href="https://elixir.bootlin.com/linux/latest/source/include/uapi/linux/bpf.h#L5947" target="_blank" rel="noopener noreferrer">bpf_fib_lookup<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>という構造体を通してルートテーブルを参照して結果を得る</li></ul></li> <li><code>long bpf_xdp_adjust_head(struct xdp_buff *xdp_md, int delta)</code> <ul><li><code>xdp_md-&gt;data</code>で得られるパケットの先頭をずらすことができる</li> <li>encap/decapに使用する</li></ul></li></ul> <h2 id="generic-xdp"><a href="#generic-xdp" class="header-anchor">#</a> Generic XDP</h2> <p>前項までで述べたようにXDPはNICのデバイスドライバレベルでパケットを処理します．
つまり，XDPが有効なNICでなければ使用することができません．
しかし，このような制限があると気軽にXDPを試すことができません．
そこでLinux Kernelには<code>Generic XDP</code>という機能がサポートされています．
この<code>Generic XDP</code>はXDPの強みである高速さを犠牲にして<code>sk_buff</code>の生成後にXDPプログラムを実行することができるようにしています．
そのため，NICのサポートの有無を気にすることなくXDPを試すことができます．</p> <p>入門段階ではほぼすべてのケースで<code>Generic XDP</code>を使用することとなるため以降のサンプルでは<code>Generic XDP</code>を使用します．</p> <p><code>Generic XDP</code>の話題は<a href="https://yunazuno.hatenablog.com/entry/2017/06/12/094101#f-609aae5d" target="_blank" rel="noopener noreferrer">こちら<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>の記事が詳しいので背景など気になる方はご覧ください．</p> <h2 id="実験環境"><a href="#実験環境" class="header-anchor">#</a> 実験環境</h2> <p>本記事での実験環境は以下のようになっています．</p> <ul><li>AWS EC2 instance t3.large</li> <li>kernel version
<ul><li>5.11.0-1019-aws</li></ul></li> <li>architecture
<ul><li>x86_64</li></ul></li> <li>NIC
<ul><li>Elastic Network Adaptor(ENA)</li></ul></li> <li>os
<ul><li>Ubuntu 20.04.3 LTS</li></ul></li> <li>clang
<ul><li>10.0.0-4ubuntu</li></ul></li> <li>iproute2
<ul><li>iproute2-ss200127</li></ul></li> <li>go
<ul><li>go1.16.7 linux/amd64</li></ul></li></ul> <h2 id="使い方"><a href="#使い方" class="header-anchor">#</a> 使い方</h2> <p>XDPの使い方を紹介します．
XDPプログラムを実行するまでの手順は以下です．</p> <ol><li>XDPが有効なカーネルか確認し依存関係を解決する</li> <li>C言語(制限付き)でXDPプログラムを記述する</li> <li><code>clang</code>でBPFバイトコードにコンパイル</li> <li>カーネルにロードする</li></ol> <p>それぞれを詳しく見ていきましょう.</p> <h3 id="xdpが有効なカーネルであるか確認-依存関係の解決"><a href="#xdpが有効なカーネルであるか確認-依存関係の解決" class="header-anchor">#</a> XDPが有効なカーネルであるか確認, 依存関係の解決</h3> <h4 id="xdpが有効なカーネルか確認"><a href="#xdpが有効なカーネルか確認" class="header-anchor">#</a> XDPが有効なカーネルか確認</h4> <p>まずはカーネルのバージョンを確認します．
Generic XDPが使えるのは<code>4.12</code>以上です．
<div></div>
このようなツイートもあるのでできるだけ最新に近いカーネルを使うのがよいと思います．
さらにカーネルのバージョンは要件を満たしていてもXDPを有効化してビルドされたものでなければ動かせません．
以下の設定が有効になっていることを確認します．</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>CONFIG_BPF=y
CONFIG_BPF_SYSCALL=y
CONFIG_BPF_JIT=y
CONFIG_HAVE_EBPF_JIT=y
CONFIG_XDP_SOCKETS=y
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>これらの設定は以下のコマンドで確認します．</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token function">grep</span> -i CONFIG_BPF /boot/config-<span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> -r<span class="token variable">)</span></span>
$ <span class="token function">grep</span> -i CONFIG_XDP_SOCKETS /boot/config-<span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> -r<span class="token variable">)</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>その他詳しい機能のサポートバージョンなどは<a href="https://medium.com/@christina.jacob.koikara/how-to-compile-a-kernel-with-xdp-support-c245ed3460f1" target="_blank" rel="noopener noreferrer">How to compile a kernel with XDP support<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>をご覧ください．</p> <h4 id="依存関係の解決"><a href="#依存関係の解決" class="header-anchor">#</a> 依存関係の解決</h4> <p>依存関係のセットアップは<a href="https://github.com/xdp-project/xdp-tutorial/blob/master/setup_dependencies.org" target="_blank" rel="noopener noreferrer">xdp tutorialのSetup dependencies<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>をご覧ください．
各ディストリビューションのインストールについて記載されています．</p> <h3 id="nicの設定"><a href="#nicの設定" class="header-anchor">#</a> NICの設定</h3> <p><code>Generic XDP</code>を使用する場合はあまり気にする必要はないですが<code>Native XDP</code>(NICに実際にロードするXDP)を使用する場合mtuやqueueの問題でロードが失敗する可能性があります．
<a href="#%E5%AE%9F%E9%A8%93%E7%92%B0%E5%A2%83">本実験環境</a>では以下のコマンドで設定を変更することでNICにXDPをロードすることができました．</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> dev ens5 mtu <span class="token number">3498</span>
$ <span class="token function">sudo</span> <span class="token function">ethtool</span> -L ens5 combined <span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div></div> <h3 id="c言語-制限付き-でプログラムを記述する"><a href="#c言語-制限付き-でプログラムを記述する" class="header-anchor">#</a> C言語(制限付き)でプログラムを記述する</h3> <p>C言語でプログラムを記述しますがBPFのプログラムは様々な制約があります．
主な制約は以下となっています．</p> <ul><li>命令数の制限
<ul><li>カーネルバージョン5.3以上で1M</li></ul></li> <li>ループ制限
<ul><li>無限ループは禁止</li> <li>5.2から有限ループは可能</li></ul></li> <li>到達不可能な命令があってはいけない</li> <li>有効なメモリにのみアクセスできる
<ul><li>メモリが有効なものかチェックする必要がある</li></ul></li></ul> <p>実際にプログラムを書く際の作法は<a href="#bpf-xdp-%E7%94%A8c%E8%A8%80%E8%AA%9E%E3%81%AE%E3%81%8A%E4%BD%9C%E6%B3%95">実践-BPF(XDP)用C言語のお作法</a>の項に記述しています．</p> <p>BPFプログラムの制限に関する資料は以下を参照してください．</p> <ul><li><a href="https://www.slideshare.net/lcplcp1/introduction-to-ebpf-and-xdp" target="_blank" rel="noopener noreferrer">Introduction to eBPF and XDP<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.janog.gr.jp/meeting/janog45/application/files/1615/7984/1029/008_pktfwd-xdp_kusakabe_00.pdf" target="_blank" rel="noopener noreferrer">パケット処理の独自実装や高速化手法の比較と実践<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h3 id="clangでbpfバイトコードにコンパイルする"><a href="#clangでbpfバイトコードにコンパイルする" class="header-anchor">#</a> <code>clang</code>でBPFバイトコードにコンパイルする</h3> <p><code>example.c</code>を<code>example.o</code>に吐き出すコマンドは以下のような感じです．</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ clang -O2 -target bpf -c example.c -o example.o
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="カーネルにロードする"><a href="#カーネルにロードする" class="header-anchor">#</a> カーネルにロードする</h3> <p>コンパイルして生成されたELFファイルをカーネルにロードするすることによってXDPが実行されます．
ロードする方法はいくつか存在します．</p> <h4 id="iproute2"><a href="#iproute2" class="header-anchor">#</a> iproute2</h4> <p>最も気軽に利用できるロード方法は<code>iproute2</code>を利用することです．
<code>iproute2</code>を利用する場合のロードは次のようにします．</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> dev ens5 xdp obj example.o
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>ロード後にNICの情報を見てみると以下のようにxdpプログラムがロードされています．</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>2: ens5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 3498 xdp qdisc mq state UP mode DEFAULT group default qlen 1000
    link/ether 0e:66:45:0d:d9:b9 brd ff:ff:ff:ff:ff:ff
    prog/xdp id 67
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>XDPプログラムを外す場合は以下のコマンドを実行します．</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> dev ens5 xdp off
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="プログラムからロードする"><a href="#プログラムからロードする" class="header-anchor">#</a> プログラムからロードする</h4> <p>BPFマップを利用するような複雑なXDPプログラムを実行したい場合，コントロールプレーンとしてプログラムを書く必要があります．
コントロールプレーンはどの言語でも特に問題ありません．
本記事ではコントロールプレーンのプログラムにはGo言語を使用します．</p> <h2 id="実践"><a href="#実践" class="header-anchor">#</a> 実践</h2> <p>本項ではXDPプログラムを実際に書いて動かしてみます．
Go言語でXDPのコントロールプレーンを記述するパッケージがいくつかあります．</p> <ul><li><a href="https://github.com/cilium/ebpf" target="_blank" rel="noopener noreferrer">cilium/ebpf<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/dropbox/goebpf" target="_blank" rel="noopener noreferrer">dropbox/goebpf<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/iovisor/gobpf" target="_blank" rel="noopener noreferrer">iovisor/gobpf<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p>スターの数や開発状況などから見ても<code>cilium/ebpf</code>がデファクトといってよいと思います．
これからGo+XDPで開発を行うのであれば<code>cilium/ebpf</code>を使うのがよいでしょう．
一方で<code>dropbox/goebpf</code>はexamplesにxdpのサンプルがいくつかあり，基本的なプログラムを学ぶには非常によいと思います．
また，作りがシンプルなのでとっかかりやすいのではないかと思います．
<code>iovisor/gobpf</code>は使用したことがないのでわかりませんが<code>CGO</code>という話なのであまりお勧めとは言えません．</p> <p>いくつかライブラリを紹介しましたが本記事では<code>cilium/ebpf</code>を使用してプログラムを記述します．</p> <p>今回の実践編のサンプルコードは以下のリポジトリにあります．
<a href="https://github.com/terassyi/go-xdp-examples" target="_blank" rel="noopener noreferrer"><img src="https://gh-card.dev/repos/terassyi/go-xdp-examples.svg" alt="terassyi/go-xdp-examples - GitHub"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="bpf-xdp-用c言語のお作法"><a href="#bpf-xdp-用c言語のお作法" class="header-anchor">#</a> BPF(XDP)用C言語のお作法</h3> <p>BPFバイトコードにコンパイルするC言語は様々な制約があると述べました．
本項ではその制約について具体的な例を示します．</p> <h4 id="命令数の制約"><a href="#命令数の制約" class="header-anchor">#</a> 命令数の制約</h4> <p>カーネルバージョン5.3から命令数制限は1Mとなっているので現実的にこの制約が問題となることはないでしょう．
もし命令数制限を超えるBPFプログラムをロードしたいとき，複数のプログラムに分割，ロードするということになります．
これを実現するための手段として<code>bpf_tail_call()</code>, <code>BPF_MAP_TYPE_PROG_ARRAY</code>が用意されています．
詳しいドキュメントは<a href="https://docs.cilium.io/en/stable/bpf/#tail-calls" target="_blank" rel="noopener noreferrer">cilium document - tail-calls<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>をご覧ください．</p> <h4 id="無限ループ禁止"><a href="#無限ループ禁止" class="header-anchor">#</a> 無限ループ禁止</h4> <p>無限ループは禁止ですが有限ループは可能です．
XDPではパケットの改変を行うのでチェックサムの計算を行う機会も多いです．
IPチェックサムを計算する関数を例示します．
このコードは<code>bufsize</code>がいずれ必ず1以下となるので有効です．</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">inline</span> __u16 <span class="token function">checksum</span><span class="token punctuation">(</span>__u16 <span class="token operator">*</span>buf<span class="token punctuation">,</span> __u32 bufsize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	__u32 sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>bufsize <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		sum <span class="token operator">+=</span> <span class="token operator">*</span>buf<span class="token punctuation">;</span>
		buf<span class="token operator">++</span><span class="token punctuation">;</span>
		bufsize <span class="token operator">-=</span> <span class="token number">2</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>bufsize <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		sum <span class="token operator">+=</span> <span class="token operator">*</span><span class="token punctuation">(</span>__u8 <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	sum <span class="token operator">=</span> <span class="token punctuation">(</span>sum <span class="token operator">&amp;</span> <span class="token number">0xffff</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>sum <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	sum <span class="token operator">=</span> <span class="token punctuation">(</span>sum <span class="token operator">&amp;</span> <span class="token number">0xffff</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>sum <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token operator">~</span>sum<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="有効なメモリにのみアクセスする"><a href="#有効なメモリにのみアクセスする" class="header-anchor">#</a> 有効なメモリにのみアクセスする</h4> <p>BPFプログラムではアクセスしたいメモリが有効であるか明示的にチェックした後でしかアクセスできません．
頻出する有効メモリチェックを二つ示します．</p> <h5 id="パケットのパース"><a href="#パケットのパース" class="header-anchor">#</a> パケットのパース</h5> <p>ここで<code>data</code>はNICから受け取ったデータの先頭のポインタ．<code>data_end</code>は末尾のポインタです．
<code>ether</code>というethernetヘッダ用変数のポインタに<code>data</code>を代入してethernetヘッダをパースします．
このとき，ヘッダサイズが<code>data_end</code>を超えている場合無効なメモリにアクセスすることとなるので<code>data + sizeof(*ether) &gt; data_end</code>であることを明示的にチェックしなければなりません．</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token operator">*</span>data_end <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>ctx<span class="token operator">-&gt;</span>data_end<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>ctx<span class="token operator">-&gt;</span>data<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">ethhdr</span> <span class="token operator">*</span>ether <span class="token operator">=</span> data<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>ether<span class="token punctuation">)</span> <span class="token operator">&gt;</span> data_end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> XDP_ABORTED<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h5 id="bpfマップのlookup"><a href="#bpfマップのlookup" class="header-anchor">#</a> BPFマップのlookup</h5> <p>BPFマップの参照は値が存在しなかった場合NULLとなります．
そのため，参照結果がNULLでないことをチェックしてから値を使用しなければなりません．</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>__u32 <span class="token operator">*</span>val <span class="token operator">=</span> <span class="token function">bpf_map_lookup_elem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>map<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> XDP_PASS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="処理を関数に切り分けるときはinline展開する"><a href="#処理を関数に切り分けるときはinline展開する" class="header-anchor">#</a> 処理を関数に切り分けるときはinline展開する</h4> <p>XDPプログラム本体として実行される以外の自作関数はすべてinline展開される必要があります．
そのため，自作関数にはすべて<code>static inline</code>をつけましょう．
<a href="#%E7%84%A1%E9%99%90%E3%83%AB%E3%83%BC%E3%83%97%E7%A6%81%E6%AD%A2">無限ループ禁止</a>で例示したchecksum()関数を参考にしてください．</p> <h4 id="ebpf組み込み関数しか使えない"><a href="#ebpf組み込み関数しか使えない" class="header-anchor">#</a> eBPF組み込み関数しか使えない</h4> <p><code>memset()</code>, <code>memcpy()</code>といった関数はllvm組み込みの関数を使用することとなります．</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token function">__builtin_memset</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dest<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>chr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">__builtin_memcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dest<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">__builtin_memmove</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dest<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>とはいえ引数は変わらないので気を付けていれば大丈夫です．</p> <h4 id="グローバル変数が使えない"><a href="#グローバル変数が使えない" class="header-anchor">#</a> グローバル変数が使えない</h4> <p>グローバル変数は使用できません．
変わりに毎回BPFマップから値をとってくることとなります．</p> <h4 id="可変長引数を取れない"><a href="#可変長引数を取れない" class="header-anchor">#</a> 可変長引数を取れない</h4> <p>可変長引数をとる関数を作成・使用することができません．
例として<code>bpf_printk(fmt, ...)</code>を見てみます．
<code>bpf_printk()</code>は<code>bpf_trace_printk()</code>を使いやすくラップした関数です．
定義は以下です．</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">bpf_printk</span><span class="token expression"><span class="token punctuation">(</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>                                   </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">{</span>                                                           </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">char</span> ____fmt<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> fmt<span class="token punctuation">;</span>                                      </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token function">bpf_trace_printk</span><span class="token punctuation">(</span>____fmt<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>____fmt<span class="token punctuation">)</span><span class="token punctuation">,</span> </span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">}</span><span class="token punctuation">)</span></span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>以下のように文字列を含めた5つの引数をとらせてみます．</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">xdp_md</span> <span class="token operator">*</span>ctx<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">bpf_printk</span><span class="token punctuation">(</span><span class="token string">&quot;%d %d %d %d&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> XDP_PASS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ clang -O2 -target bpf -c example.c -o example.o
example.c:9:5: error: too many args to 0xb70290: i64 <span class="token operator">=</span> Constant<span class="token operator">&lt;</span><span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span>
int test<span class="token punctuation">(</span>struct xdp_md *ctx<span class="token punctuation">)</span>
    ^
<span class="token number">1</span> error generated.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>コンパイルすると<code>too many args</code>と怒られます．
これを4つ以下の引数にすると無事コンパイルは通ります．
MACアドレスなどをデバッグ出力したいときに非常に困りますが仕方ありません．気を付けましょう．</p> <p>その他制約やコンパイル方法などは次のドキュメントが詳しいです．</p> <ul><li><a href="https://docs.cilium.io/en/stable/bpf/#llvm" target="_blank" rel="noopener noreferrer">cilium docs bpf #llvm<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h3 id="チュートリアル"><a href="#チュートリアル" class="header-anchor">#</a> チュートリアル</h3> <p>この項ではチュートリアルとして<a href="https://github.com/dropbox/goebpf/tree/master/examples/xdp" target="_blank" rel="noopener noreferrer">dropbox/goebpf/examples/xdp<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>にあるサンプルを<code>cilium/ebpf</code>を用いて動かしてみるということを行います．</p> <p><code>dropbox/goebpf/examples/xdp</code>配下には</p> <ul><li>packet_counter</li> <li>xdp_dump</li> <li>basic_firewall</li> <li>bpf_redirect_map</li></ul> <p>の4つのサンプルがあります．
こちらのC言語で書かれたXDPプログラムは基本的にそのまま使用します.(一部変更しなければ動作しないものがあるため変更します．)</p> <h4 id="構成"><a href="#構成" class="header-anchor">#</a> 構成</h4> <p>まずディレクトリ構成について軽く述べます．</p> <p><a href="https://github.com/terassyi/go-xdp-examples" target="_blank" rel="noopener noreferrer"><img src="https://gh-card.dev/repos/terassyi/go-xdp-examples.svg" alt="terassyi/go-xdp-examples - GitHub"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><code>/header/</code>配下に<code>bpf.h</code>, <code>bpf_helpers.h</code>を配置しています．これはBPFプログラムを記述するためのhelper関数などが定義されたヘッダファイルで，これらを使用することでBPFプログラム記述の負担が軽減されます．
今回配置しているのは<code>dropbox/goebpf/</code>に置いてあるものになっています．
様々なBPFプロジェクトが独自のヘッダファイルを使用している場合があり，微妙に定義が異なることもあるので注意してください．</p> <p>各サンプルのディレクトリの中の<code>bpf/</code>配下にBPFプログラムを配置しています．
各サンプルのトップにはGoのプログラムが置いてあります．
ビルドなどはこのディレクトリで行います．</p> <h4 id="ビルド"><a href="#ビルド" class="header-anchor">#</a> ビルド</h4> <p>ビルドに必要なステップは二つです．</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ go generate
$ go build <span class="token builtin class-name">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><code>go generate</code>によって<code>bpf/</code>配下のC言語のコードをBPFバイトコードにコンパイルしてGoで扱うためのコードを自動生成します．
これは<code>bpf2go</code>(<a href="https://github.com/cilium/ebpf/tree/master/cmd/bpf2go" target="_blank" rel="noopener noreferrer">github.com/cilium/ebpf/cmd/bpf2go<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)というツールを使用しています．
<code>main.go</code>の中に<code>//go:generate</code>という感じで記述しておくことでコードを自動生成してくれます．
これが最初はとっつきにくいですが慣れると非常に便利です．</p> <p>後は普通にビルドすることによってシングルバイナリとしてBPFのプログラムを扱うことができます．</p> <h4 id="packet-counter"><a href="#packet-counter" class="header-anchor">#</a> packet_counter</h4> <p><code>packet_counter</code>は指定されたNICが受信したパケットをプロトコルごとにカウントするプログラムです．
<code>main.go</code>と<code>bpf/xdp.c</code>から構成されます．
それぞれに分けてみていきます．</p> <h5 id="xdp-2"><a href="#xdp-2" class="header-anchor">#</a> XDP</h5> <p>まずはXDPのコードから見ていきましょう．
最初はヘッダのインクルードと構造体の定義です．
<code>bpf_helpers.h</code>をインクルードします．
さらにパケットを表現する構造体を定義します．
しかし，これは<code>linux/if_ether.h</code>や<code>netinet/ip.h</code>などを使用してもかまいません．</p> <p>続いてBPFマップを定義します．
packet_counterでは<code>BPF_MAP_TYPE_PERCPU_ARRAY</code>を定義しています．</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// eBPF map to store IP proto counters (tcp, udp, etc)</span>
<span class="token function">BPF_MAP_DEF</span><span class="token punctuation">(</span>protocols<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>map_type <span class="token operator">=</span> BPF_MAP_TYPE_PERCPU_ARRAY<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>key_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>__u32<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>value_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>__u64<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>max_entries <span class="token operator">=</span> <span class="token number">255</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">BPF_MAP_ADD</span><span class="token punctuation">(</span>protocols<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>keyは4byte, valueは8byteで定義しています．
続いてXDP関数です．</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token function">SEC</span><span class="token punctuation">(</span><span class="token string">&quot;xdp&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">int</span> <span class="token function">packet_count</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">xdp_md</span> <span class="token operator">*</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><code>xdp</code>というセクション名を割り当てた関数がパケットの受信の度に呼び出されることとなります．
この関数は<code>xdp_md</code>という構造体を引数に取ります．
の構造体は受信したパケットなどの情報を保持したコンテキストです．
定義は<a href="https://github.com/terassyi/go-xdp-examples/blob/master/header/bpf_helpers.h" target="_blank" rel="noopener noreferrer">header/bpf_helpers.h<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>にあり，以下のようになっています．</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">xdp_md</span> <span class="token punctuation">{</span>
  __u32 data<span class="token punctuation">;</span>
  __u32 data_end<span class="token punctuation">;</span>
  __u32 data_meta<span class="token punctuation">;</span>
  <span class="token comment">/* Below access go through struct xdp_rxq_info */</span>
  __u32 ingress_ifindex<span class="token punctuation">;</span> <span class="token comment">/* rxq-&gt;dev-&gt;ifindex */</span>
  __u32 rx_queue_index<span class="token punctuation">;</span>  <span class="token comment">/* rxq-&gt;queue_index  */</span>
  __u32 egress_ifindex<span class="token punctuation">;</span>  <span class="token comment">/* txq-&gt;dev-&gt;ifindex */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><code>data</code>が受信したパケットデータの先頭のポインタ，<code>data_end</code>がそのパケットデータの末尾のポインタとなっています．</p> <p>それでは<code>packet_count</code>の中身を見ていきましょう．
パケットデータの先頭，末尾のポインタを移動させながらパケットをパースするのでそのための変数<code>data</code>, <code>data_end</code>を定義します．</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token operator">*</span>data_end <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>ctx<span class="token operator">-&gt;</span>data_end<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>ctx<span class="token operator">-&gt;</span>data<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>続いてethernetヘッダをパースします．</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">ethhdr</span> <span class="token operator">*</span>ether <span class="token operator">=</span> data<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>ether<span class="token punctuation">)</span> <span class="token operator">&gt;</span> data_end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> XDP_ABORTED<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>今回はIPv4プロトコルのみを扱うので<code>ether-&gt;h_proto</code>で分岐し，IPv4にマッチした場合のみ以下の処理を実行します．
<code>data</code>をethernetヘッダのサイズ分ずらすことでIPv4パケットの先頭にポインタを合わせてパースします．
その後，先ほど定義した<code>protocols</code>マップからIPプロトコルタイプをキーとして値を取り出しインクリメントすることでパケットをカウントします．</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>ether<span class="token operator">-&gt;</span>h_proto <span class="token operator">==</span> <span class="token number">0x08U</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// htons(ETH_P_IP) -&gt; 0x08U</span>
  data <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>ether<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">iphdr</span> <span class="token operator">*</span>ip <span class="token operator">=</span> data<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>ip<span class="token punctuation">)</span> <span class="token operator">&gt;</span> data_end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> XDP_ABORTED<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// Increase counter in &quot;protocols&quot; eBPF map</span>
  __u32 proto_index <span class="token operator">=</span> ip<span class="token operator">-&gt;</span>protocol<span class="token punctuation">;</span>
  __u64 <span class="token operator">*</span>counter <span class="token operator">=</span> <span class="token function">bpf_map_lookup_elem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>protocols<span class="token punctuation">,</span> <span class="token operator">&amp;</span>proto_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>counter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>counter<span class="token punctuation">)</span><span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>最後にパケットをカーネルに流します．</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">return</span> XDP_PASS<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="go"><a href="#go" class="header-anchor">#</a> Go</h5> <p>続いてコントロールプレーンのコードを見ていきます．
<code>main.go</code>に</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>//go:generate go run github.com/cilium/ebpf/cmd/bpf2go -cc clang XdpProg ./bpf/xdp.c -- -I../header
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>と記述することによって<code>bpf2go</code>を<code>go generate</code>で使えるようにしています．</p> <p>まずbpfプログラムとマップを保持する構造体を定義します．</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> Collect <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Prog <span class="token operator">*</span>ebpf<span class="token punctuation">.</span>Program <span class="token string">`ebpf:&quot;packet_count&quot;`</span>
	Protocols <span class="token operator">*</span>ebpf<span class="token punctuation">.</span>Map <span class="token string">`ebpf:&quot;protocols&quot;`</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>それでは<code>main</code>関数の処理を見ていきましょう．
コマンドライン引数からXDPプログラムをアタッチするインターフェース名を受け取り，そのインターフェースの情報を取得する処理を最初に行っています．
インターフェース情報の取得などは<a href="https://github.com/vishvananda/netlink" target="_blank" rel="noopener noreferrer">vishvananda/netlink<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>を使用します．</p> <p>前準備が終わると本命のXDP関連の処理となります．
<code>LoadXdpProg()</code>, <code>LoadAdnAssign()</code>は<code>bpf2go</code>から自動生成されるコードです．
自動生成されるコードについては今回は詳しく触れません．
<code>bpf2go</code>を実行する際に引数として渡す値に基づいて<code>Load&lt;Name&gt;()</code>生成されます．(今回の場合<code>XdpProg</code>という値を渡したので<code>LoadXdpProg()</code>)
この処理によってXDPのプログラムとマップをロードして<code>Collect</code>構造体にマッピングします．</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> collect <span class="token operator">=</span> <span class="token operator">&amp;</span>Collect<span class="token punctuation">{</span><span class="token punctuation">}</span>
spec<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">LoadXdpProg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> err <span class="token operator">:=</span> spec<span class="token punctuation">.</span><span class="token function">LoadAndAssign</span><span class="token punctuation">(</span>collect<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>引き続いてNICへのアタッチです．
<code>cilium/ebpf</code>にはXDPをNICにアタッチするための関数は用意されていないのでnetlink経由でアタッチします．
netlinkにはXDPをアタッチする関数として<a href="https://pkg.go.dev/github.com/vishvananda/netlink#LinkSetXdpFd" target="_blank" rel="noopener noreferrer">netlink.LinkSetXdpFd()<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>も用意されています．
今回は明示的に<code>Generic XDP</code>を指定してアタッチするために<a href="https://pkg.go.dev/github.com/vishvananda/netlink#LinkSetXdpFdWithFlags" target="_blank" rel="noopener noreferrer">netlink.LinkSetXdpFdWithFlags<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>を使用しています．
基本的には<code>netlink.LinkSetXdpFd()</code>でアタッチして問題ありません．
こちらの記事(<a href="https://yunazuno.hatenablog.com/entry/2017/06/12/094101#f-f6e9ed6b" target="_blank" rel="noopener noreferrer">Generic XDPを使えばXDP動作環境がお手軽に構築できるようになった<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)にあるようにデフォルトでは<code>Native</code>, <code>Generic</code>の順にアタッチが試行されるようです．
以前<code>XDP_REDIRECT</code>を使用する際に明示的に<code>Generic XDP</code>を指定しなければパケット転送が動作しないというバグを踏んだことがあったため念のため明示的に<code>Generic XDP</code>を指定しています．</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">if</span> err <span class="token operator">:=</span> netlink<span class="token punctuation">.</span><span class="token function">LinkSetXdpFdWithFlags</span><span class="token punctuation">(</span>link<span class="token punctuation">,</span> collect<span class="token punctuation">.</span>Prog<span class="token punctuation">.</span><span class="token function">FD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nl<span class="token punctuation">.</span>XDP_FLAGS_SKB_MODE<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	netlink<span class="token punctuation">.</span><span class="token function">LinkSetXdpFdWithFlags</span><span class="token punctuation">(</span>link<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> nl<span class="token punctuation">.</span>XDP_FLAGS_SKB_MODE<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>アタッチ関連の処理の後はXDPと連動したパケットカウント処理となります．
無限ループと<code>ticker</code>による1秒感覚の定期処理の中で以下のような処理を行います．
<code>collect.Protocols.Lookup()</code>でBPFマップから値を取り出します．
この時引数にkey, valueの変数のポインタを渡してあげる必要があります．
結果としてマップに値があれば<code>v</code>に値が格納されます．
keyに対応する値が存在していなくともerrorは返さないのでこのような記述となっています．
また，今回定義したBPFマップが<code>BPF_MAP_TYPE_PERCPU_ARRAY</code>なので<code>v</code>は<code>[]uint64</code>型です．
CPUごとにインデックスされて値が格納されるため，今回の実験環境では要素2のスライスとして値が格納されるのでこのような記述となっています．</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> v <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint64</span>
<span class="token keyword">var</span> i <span class="token builtin">uint32</span>
<span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">32</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> collect<span class="token punctuation">.</span>Protocols<span class="token punctuation">.</span><span class="token function">Lookup</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>i<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s : %v&quot;</span><span class="token punctuation">,</span> <span class="token function">getProtoName</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s : %v&quot;</span><span class="token punctuation">,</span> <span class="token function">getProtoName</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>以上で<code>packet_counter</code>は完成です．
パケットをカウントする単純な処理しかしていませんが基本的なXDPのアタッチやマップの定義，参照などは他のプロジェクトでも大体同じ感じです．</p> <h5 id="実行"><a href="#実行" class="header-anchor">#</a> 実行</h5> <p>ビルドして実行してみます．
実験環境は<code>netns.sh</code>を使用して作成します．
ネットワーク構成は以下のような感じです．</p> <p><img src="/img/xdp-example-network-1.png" alt="xdp-example-network-1"></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token function">sudo</span> ./netns.sh build
$ go generate
$ go build <span class="token builtin class-name">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>では動かしてみましょう．
XDPプログラムは<code>node1</code>のnetnsで動かします．</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> node1 ./packet_counter -iface veth1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>コンソールが返ってこなければ正常に起動しているはずです．
別のターミナルを起動して<code>veth1</code>のアドレス<code>192.168.0.2</code>に対して<code>ping</code>を飛ばしてみましょう．</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token function">ping</span> -c <span class="token number">3</span> <span class="token number">192.168</span>.0.2
PING <span class="token number">192.168</span>.0.2 <span class="token punctuation">(</span><span class="token number">192.168</span>.0.2<span class="token punctuation">)</span> <span class="token number">56</span><span class="token punctuation">(</span><span class="token number">84</span><span class="token punctuation">)</span> bytes of data.
<span class="token number">64</span> bytes from <span class="token number">192.168</span>.0.2: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.052</span> ms
<span class="token number">64</span> bytes from <span class="token number">192.168</span>.0.2: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.050</span> ms
<span class="token number">64</span> bytes from <span class="token number">192.168</span>.0.2: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">3</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.049</span> ms
--- <span class="token number">192.168</span>.0.2 <span class="token function">ping</span> statistics ---
<span class="token number">3</span> packets transmitted, <span class="token number">3</span> received, <span class="token number">0</span>% packet loss, <span class="token function">time</span> 2033ms
rtt min/avg/max/mdev <span class="token operator">=</span> <span class="token number">0.049</span>/0.050/0.052/0.001 ms
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>このように応答がかえってくるはずです．
では<code>packet_counter</code>の画面をみてみます．</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>IPPROTO_ICMP : 3
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>このようにICMPパケットが3つカウントされていることがわかります．
プロトコルごとにカウントするのでTCPやUDPでも試してみてください．</p> <p>実験が終了したらnetnsの後片付けをしておきましょう．</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token function">sudo</span> ./netns.sh clean
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="xdp-dump"><a href="#xdp-dump" class="header-anchor">#</a> xdp_dump</h4> <p><code>xdp_dump</code>はTCPパケットをキャプチャしてダンプするプログラムです．
<code>main.go</code>と<code>bpf/xdp_dump.c</code>から構成されます．
先ほどと同様にXDPとGoに分けてみていきましょう．</p> <h5 id="xdp-3"><a href="#xdp-3" class="header-anchor">#</a> XDP</h5> <p>まずはXDPからです．
ヘッダのインクルードや構造体定義のやり方は<a href="#xdp-2">packet_counter</a>と同様です．
今回は<code>BPF_MAP_TYPE_PERF_EVENT_ARRAY</code>を使用します．</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token function">BPF_MAP_DEF</span><span class="token punctuation">(</span>perfmap<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>map_type <span class="token operator">=</span> BPF_MAP_TYPE_PERF_EVENT_ARRAY<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>max_entries <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">BPF_MAP_ADD</span><span class="token punctuation">(</span>perfmap<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>さらに<code>perf_event_item</code>という<code>perfmap</code>に格納する構造体を定義しておきます．</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">perf_event_item</span> <span class="token punctuation">{</span>
  __u32 src_ip<span class="token punctuation">,</span> dst_ip<span class="token punctuation">;</span>
  __u16 src_port<span class="token punctuation">,</span> dst_port<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>続いてXDP関数の処理を見ていきます．
<code>xdp_dump</code>という名前で定義しています．
EthernetヘッダやIPv4ヘッダのパースは<a href="#xdp-2">packet_counter</a>と同様です．
今回はTCPヘッダもパースするのでその処理を以下に抜粋します．
基本的にやり方は変わりませんが，IPv4ヘッダは可変長なので<code>ip-&gt;ihl * 4</code>でヘッダ長を計算して加算してあげる必要があります．</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>data <span class="token operator">+=</span> ip<span class="token operator">-&gt;</span>ihl <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">tcphdr</span> <span class="token operator">*</span>tcp <span class="token operator">=</span> data<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>tcp<span class="token punctuation">)</span> <span class="token operator">&gt;</span> data_end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> XDP_ABORTED<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>その後は<code>SYN</code>フラグがついたパケットのみを対象としてperf eventを発火させます．
<code>packet_size</code>はあらかじめ<code>data - data_end</code>で求めています．
プログラム中のコメントにある通り，<code>flags</code>にはCPUのIDと<code>ctx(xdp_md struct)</code>の使用する範囲を指定した値をいれています．</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>tcp<span class="token operator">-&gt;</span>syn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">perf_event_item</span> evt <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>src_ip <span class="token operator">=</span> ip<span class="token operator">-&gt;</span>saddr<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>dst_ip <span class="token operator">=</span> ip<span class="token operator">-&gt;</span>daddr<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>src_port <span class="token operator">=</span> tcp<span class="token operator">-&gt;</span>source<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>dst_port <span class="token operator">=</span> tcp<span class="token operator">-&gt;</span>dest<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// flags for bpf_perf_event_output() actually contain 2 parts (each 32bit long):</span>
  <span class="token comment">//</span>
  <span class="token comment">// bits 0-31: either</span>
  <span class="token comment">// - Just index in eBPF map</span>
  <span class="token comment">// or</span>
  <span class="token comment">// - &quot;BPF_F_CURRENT_CPU&quot; kernel will use current CPU_ID as eBPF map index</span>
  <span class="token comment">//</span>
  <span class="token comment">// bits 32-63: may be used to tell kernel to amend first N bytes</span>
  <span class="token comment">// of original packet (ctx) to the end of the data.</span>
  <span class="token comment">// So total perf event length will be sizeof(evt) + packet_size</span>
  __u64 flags <span class="token operator">=</span> BPF_F_CURRENT_CPU <span class="token operator">|</span> <span class="token punctuation">(</span>packet_size <span class="token operator">&lt;&lt;</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">bpf_perf_event_output</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>perfmap<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> <span class="token operator">&amp;</span>evt<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>evt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>その後は<code>XDP_PASS</code>して終了です．</p> <h5 id="go-2"><a href="#go-2" class="header-anchor">#</a> Go</h5> <p>続いてGoのプログラムを見ていきます．
コマンドライン引数のパース，XDPプログラムやマップのロード，アタッチは<a href="#xdp-2">packet_counter</a>と変わらないので省略して<code>perf event</code>の取り扱いを見ていきます．
XDP側で定義したものと同じフィールドを持つ<code>perfEventItem</code>構造体を定義しておきます．</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> perfEventItem <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	SrcIp <span class="token builtin">uint32</span>
	DstIp <span class="token builtin">uint32</span>
	SrcPort <span class="token builtin">uint16</span>
	DstPort <span class="token builtin">uint16</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>次に<code>perf event</code>を読むためのReaderを生成します．</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>perfEvent<span class="token punctuation">,</span> err <span class="token operator">:=</span> perf<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>collect<span class="token punctuation">.</span>PerfMap<span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>goroutine</code>で起動している部分が<code>perf event</code>をハンドリングする処理部です．
<code>perfEvent.Read()</code>でeventをpollして読み込みます．
無事読み込みが終了した場合<code>event.RawSample</code>に格納されたバイト列を<code>binary.Read()</code>で<code>perfEventItem</code>構造体にパースします．
さらに，<code>event.RawSample</code>が<code>perfEventItem</code>の大きさ(METADATA_SIZE = 12として定義している)よりも大きければパケットデータをダンプしてあげています．</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> event perfEventItem
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		evnt<span class="token punctuation">,</span> err <span class="token operator">:=</span> perfEvent<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> errors<span class="token punctuation">.</span><span class="token function">Unwrap</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">==</span> perf<span class="token punctuation">.</span>ErrClosed <span class="token punctuation">{</span>
				<span class="token keyword">break</span>
			<span class="token punctuation">}</span>
			<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		reader <span class="token operator">:=</span> bytes<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>evnt<span class="token punctuation">.</span>RawSample<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> binary<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>reader<span class="token punctuation">,</span> binary<span class="token punctuation">.</span>LittleEndian<span class="token punctuation">,</span> <span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;TCP: %v:%d -&gt; %v:%d\n&quot;</span><span class="token punctuation">,</span>
			<span class="token function">intToIpv4</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>SrcIp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>SrcPort<span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token function">intToIpv4</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>DstIp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>DstPort<span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>evnt<span class="token punctuation">.</span>RawSample<span class="token punctuation">)</span> <span class="token operator">-</span> METADATA_SIZE <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>hex<span class="token punctuation">.</span><span class="token function">Dump</span><span class="token punctuation">(</span>evnt<span class="token punctuation">.</span>RawSample<span class="token punctuation">[</span>METADATA_SIZE<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		received <span class="token operator">+=</span> <span class="token function">len</span><span class="token punctuation">(</span>evnt<span class="token punctuation">.</span>RawSample<span class="token punctuation">)</span>
		lost <span class="token operator">+=</span> <span class="token function">int</span><span class="token punctuation">(</span>evnt<span class="token punctuation">.</span>LostSamples<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p><code>xdp_dump</code>では<code>perf event</code>を使用したためイベント駆動で処理することができました．</p> <h5 id="実行-2"><a href="#実行-2" class="header-anchor">#</a> 実行</h5> <p>それでは動かしてみます．
今回も<code>netns.sh</code>で実験環境を作ってプログラムをビルドします．</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ go generate
$ go build <span class="token builtin class-name">.</span>
$ <span class="token function">sudo</span> ./netns.sh build
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>続いて<code>node1</code>の中で<code>xdp_dump</code>を起動しましょう．
起動すると以下のようにTCPのSYNパケットを待ちます．</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> node1 ./xdp_dump -iface veth1
All new TCP connection requests <span class="token punctuation">(</span>SYN<span class="token punctuation">)</span> coming to this <span class="token function">host</span> will be dumped here.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>今回はTCPパケットを扱うので別のターミナルでpythonをつかってHTTPサーバを起動してそこにアクセスしてみます．</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> node1 python3 -m http.server <span class="token number">8888</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>もう一つターミナルを開いて<code>curl</code>でHTTPサーバにアクセスしてみましょう．</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token function">curl</span> http://192.168.0.2:8888
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>通常通りレスポンスが返ってくると思います．
また，<code>xdp_dump</code>を動かしているターミナルではTCP(SYN)パケットがダンプされていると思います．</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>All new TCP connection requests <span class="token punctuation">(</span>SYN<span class="token punctuation">)</span> coming to this <span class="token function">host</span> will be dumped here.
TCP: <span class="token number">192.168</span>.0.3:43910 -<span class="token operator">&gt;</span> <span class="token number">192.168</span>.0.2:8888
00000000  e2 f7 <span class="token number">28</span> <span class="token function">dc</span> a0 <span class="token number">65</span> <span class="token number">12</span> 4b  fe 5b <span class="token number">64</span> <span class="token number">20</span> 08 00 <span class="token number">45</span> 00  <span class="token operator">|</span><span class="token punctuation">..</span><span class="token punctuation">(</span><span class="token punctuation">..</span>e.K.<span class="token punctuation">[</span>d <span class="token punctuation">..</span>E.<span class="token operator">|</span>
00000010  00 3c <span class="token number">93</span> c9 <span class="token number">40</span> 00 <span class="token number">40</span> 06  <span class="token number">25</span> 9d c0 a8 00 03 c0 a8  <span class="token operator">|</span>.<span class="token operator">&lt;</span><span class="token punctuation">..</span>@.@.%<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.<span class="token operator">|</span>
00000020  00 02 ab <span class="token number">86</span> <span class="token number">22</span> b8 9c <span class="token number">36</span>  ba <span class="token number">88</span> 00 00 00 00 a0 02  <span class="token operator">|</span><span class="token punctuation">..</span><span class="token punctuation">..</span>&quot;<span class="token punctuation">..</span><span class="token number">6</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token operator">|</span>
00000030  fa f0 <span class="token number">81</span> <span class="token number">84</span> 00 00 02 04  05 b4 04 02 08 0a f4 c8  <span class="token operator">|</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token operator">|</span>
00000040  ac 0b 00 00 00 00 01 03  03 07 00 00 00 00 00 00  <span class="token operator">|</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token operator">|</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>実験が終わったらnetnsを削除しておきましょう．</p> <h4 id="basic-firewall"><a href="#basic-firewall" class="header-anchor">#</a> basic_firewall</h4> <p>3つめのサンプルは<code>basic_firewall</code>です．
IPv4ネットワークを入力として与えることで該当した宛先からのパケットをドロップします．
<code>basic_firewall</code>配下の<code>main.go</code>と<code>bpf/xdp_fw.c</code>から構成されます．
これまでと同様にXDPとGoに分けて見ていきましょう．</p> <h5 id="xdp-4"><a href="#xdp-4" class="header-anchor">#</a> XDP</h5> <p>これまでのサンプルと同様にヘッダのインクルードと構造体の定義を行います．
その後BPFマップの定義を行います．
今回はふたつのマップを定義します．タイプはそれぞれ<code>BPF_MAP_TYPE_PERCPU_ARRAY</code>, <code>BPF_MAP_TYPE_LPM_TRIE</code>です．</p> <p><code>matches</code>は通常のArrayです．
入力したルール(IPv4ネットワーク)にマッチしたパケットをカウントするためのマップです．</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token function">BPF_MAP_DEF</span><span class="token punctuation">(</span>matches<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>map_type <span class="token operator">=</span> BPF_MAP_TYPE_PERCPU_ARRAY<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>key_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>__u32<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>value_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>__u64<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>max_entries <span class="token operator">=</span> MAX_RULES<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">BPF_MAP_ADD</span><span class="token punctuation">(</span>matches<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><code>blacklist</code>は入力されたルールを保持するマップです．
<code>lpm trie</code>という特殊なマップとして定義します．
<code>lpm trie</code>は<a href="https://www.lewuathe.com/longest-prefix-match-with-trie-tree.html" target="_blank" rel="noopener noreferrer">Longest Prefix Match with Trie Tree<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>を意味しています．
ルートテーブルなどを作成する際に使用します．
IPv4アドレスとプレフィックスをキー，任意の値をバリューとして保存して使用します．</p> <p>今回マップの定義にて<code>BPF_F_NO_PREALLOC</code>を指定しています．
<code>BPF_F_NO_PREALLOC</code>はプリアロケーションによるオーバーヘッドを削減するためのフラグです．
詳細は以下のリンクを参照してください．</p> <ul><li><a href="https://pingcap.com/blog/tips-and-tricks-for-writing-linux-bpf-applications-with-libbpf#reduce-pre-allocation-overhead" target="_blank" rel="noopener noreferrer">Reduce pre-allocation overhead<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p>今回のサンプルではこのフラグを指定しなければBPFマップ作成が<code>Invalid argument</code>で失敗してしまいました．
これは<a href="https://github.com/dropbox/goebpf/blob/master/examples/xdp/basic_firewall/ebpf_prog/xdp_fw.c#L46" target="_blank" rel="noopener noreferrer">dropbox/goebpfのサンプル<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>では指定されなくても動作していました．
一方今回<code>cilium/ebpf</code>を使用した際は与える必要がありました．
同様のエラーに遭遇した方は参考にしてください．</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token function">BPF_MAP_DEF</span><span class="token punctuation">(</span>blacklist<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>map_type <span class="token operator">=</span> BPF_MAP_TYPE_LPM_TRIE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>key_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>__u64<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>value_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>__u32<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>max_entries <span class="token operator">=</span> MAX_RULES<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>map_flags <span class="token operator">=</span> BPF_F_NO_PREALLOC<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">BPF_MAP_ADD</span><span class="token punctuation">(</span>blacklist<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>さて，マップの定義が終わったのでXDP関数の処理を見ていきます．今回は<code>firewall</code>という関数名です．
まずはこれまで通りEthernet, IPv4パケットのパースを行います．</p> <p>その後，<code>blacklist</code>を参照するための<code>key</code>を作成します．
<code>key</code>はプレフィックスとアドレスのフィールドを持っています．</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token punctuation">{</span>
  __u32 prefixlen<span class="token punctuation">;</span>
  __u32 saddr<span class="token punctuation">;</span>
<span class="token punctuation">}</span> key<span class="token punctuation">;</span>
key<span class="token punctuation">.</span>prefixlen <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span>
key<span class="token punctuation">.</span>saddr <span class="token operator">=</span> ip<span class="token operator">-&gt;</span>saddr<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>以下がメインの処理部です．
先ほど用意した<code>key</code>で<code>blacklist</code>をlookupしてルールにマッチした場合<code>matches</code>からもカウンタを取り出してインクリメントしています．
その後，<code>XDP_DROP</code>を返すことでパケットをドロップします．
マッチしなかった場合は単に<code>XDP_PASS</code>を返します．</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>__u64 <span class="token operator">*</span>rule_idx <span class="token operator">=</span> <span class="token function">bpf_map_lookup_elem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>blacklist<span class="token punctuation">,</span> <span class="token operator">&amp;</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>rule_idx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Matched, increase match counter for matched &quot;rule&quot;</span>
  __u32 index <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>__u32<span class="token operator">*</span><span class="token punctuation">)</span>rule_idx<span class="token punctuation">;</span>  <span class="token comment">// make verifier happy</span>
  __u64 <span class="token operator">*</span>counter <span class="token operator">=</span> <span class="token function">bpf_map_lookup_elem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>matches<span class="token punctuation">,</span> <span class="token operator">&amp;</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>counter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>counter<span class="token punctuation">)</span><span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> XDP_DROP<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">return</span> XDP_PASS<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h5 id="go-3"><a href="#go-3" class="header-anchor">#</a> Go</h5> <p>次はコントロールプレーンを見ていきます．
コマンドライン引数のパースやXDPプログラムのロードとアタッチはこれまでと同様です．
今回は入力としてドロップするルールを渡します．
また，<code>lpm trie</code>を使用するので<code>lpmTrieKey</code>という型を用意しておきます．</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> lpmTrieKey <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	prefixlen <span class="token builtin">uint32</span>
	addr <span class="token builtin">uint32</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>この型を使用して入力されたドロップルールを<code>blacklist</code>に挿入します．</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">for</span> index<span class="token punctuation">,</span> ip <span class="token operator">:=</span> <span class="token keyword">range</span> ipList <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;\t%s\n&quot;</span><span class="token punctuation">,</span> ip<span class="token punctuation">)</span>
	k <span class="token operator">:=</span> <span class="token function">ipNetToUint64</span><span class="token punctuation">(</span><span class="token function">createLPMTrieKey</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> collect<span class="token punctuation">.</span>Blacklist<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> <span class="token function">uint32</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>以下はパケットのカウントを表示する部分です<code>packet_counter</code>で出てきたものとほぼ同じです．
<code>ticker</code>で定期的に処理しています．</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">for</span> <span class="token punctuation">{</span>
	<span class="token keyword">select</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ticker<span class="token punctuation">.</span>C<span class="token punctuation">:</span>
		<span class="token keyword">var</span> v <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint64</span>
		<span class="token keyword">var</span> i <span class="token builtin">uint32</span>
		<span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">uint32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>ipList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> err <span class="token operator">:=</span> collect<span class="token punctuation">.</span>Matches<span class="token punctuation">.</span><span class="token function">Lookup</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>i<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%18s\t%d\n&quot;</span><span class="token punctuation">,</span> ipList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%18s\t%d\n&quot;</span><span class="token punctuation">,</span> ipList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctrlC<span class="token punctuation">:</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;\nDetaching program and exit&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p><code>basic_firewall</code>は<code>BPF_MAP_TYPE_LPM_TRIE</code>を利用することで簡単にIPアドレスがルールにマッチするかどうかを判断することができました．</p> <h5 id="実行-3"><a href="#実行-3" class="header-anchor">#</a> 実行</h5> <p>それでは動かしてみます．
今回もこれまでと同様に<code>netns</code>で実験環境を用意します．</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ go generate
$ go build <span class="token builtin class-name">.</span>
$ <span class="token function">sudo</span> ./netns.sh build
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>では<code>basic_firewall</code>を起動しましょう．今回は以下のように<code>192.168.0.0/24</code>をブロックするように指定して実行します．</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> node1 ./basic_firewall -iface veth1 -drop <span class="token number">192.168</span>.0.0/24
Blacklisting IPv4 Addresses<span class="token punctuation">..</span>.
        <span class="token number">192.168</span>.0.0/24
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>それでは別のターミナルから<code>ping</code>を飛ばしてみましょう．
<code>192.168.0.3 -&gt; 192.168.0.2</code>向けのパケットが飛ぶはずなのでこれは<code>basic_firewall</code>を動かしている間はレスポンスがないはずです．</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token function">ping</span> <span class="token number">192.168</span>.0.2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>というわけで<code>basic_firewall</code>を動かしているターミナルに戻ってみます．</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Blacklisting IPv4 Addresses...
        192.168.0.0/24
    192.168.0.0/24      1
    192.168.0.0/24      2
    192.168.0.0/24      3
    192.168.0.0/24      4
    192.168.0.0/24      5
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>このようにブロックしたパケットをカウントして出力されています．
<code>Crtl + c</code>でプログラムを終了させると<code>ping</code>の応答が返ってくるようになることを確認してください．</p> <p>実験が終了したら<code>netns</code>を掃除しておきましょう．</p> <h4 id="bpf-redirect-map"><a href="#bpf-redirect-map" class="header-anchor">#</a> bpf_redirect_map</h4> <p>4つめのサンプルは<code>bpf_redirect_map</code>です．
このサンプルはICPMパケットを対象にICMPパケットの送信者にリダイレクトするというものとなっています．
<code>bpf_redirect_map</code>配下の<code>main.go</code>と<code>bpf/xdp.c</code>から構成されます．
これまでと同様にXDPとGoに分けて見ていきましょう．</p> <h5 id="xdp-5"><a href="#xdp-5" class="header-anchor">#</a> XDP</h5> <p>これまでのサンプルと同様にヘッダのインクルードと構造体の定義を行います．
その後BPFマップの定義を行います．</p> <p>今回は<code>BPF_MAP_TYPE_DEVMAP</code>というタイプのマップを使用します．
このマップは<code>bpf_redirect()</code>, <code>bpf_redirect_map()</code>を使用するためにデバイスのインデックスを保持しておくマップです．</p> <p>こちらも少しハマりどころがあり，<a href="https://github.com/dropbox/goebpf/blob/master/examples/xdp/bpf_redirect_map/ebpf_prog/xdp.c#L44" target="_blank" rel="noopener noreferrer">dropbox/goebpfのサンプル<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>では<code>max_entries</code>の値が<code>64</code>となっていますが<code>cilium/ebpf</code>を使用した場合マップに値を入れるときに<code>panic: update failed: key too big for map: argument list too long</code>と怒られます．
ですので今回は<code>1024</code>という大きめの数字を使用しています．</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/* XDP enabled TX ports for redirect map */</span>
<span class="token function">BPF_MAP_DEF</span><span class="token punctuation">(</span>if_redirect<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>map_type <span class="token operator">=</span> BPF_MAP_TYPE_DEVMAP<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>key_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>__u32<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>value_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>__u32<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>max_entries <span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">BPF_MAP_ADD</span><span class="token punctuation">(</span>if_redirect<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>次にXDP関数を見ていきます．
関数名は<code>xdp_test</code>です．
これまで通りEthernet, IPv4パケットにパースします．
さらに，IPパケットのプロトコルをみてICMPでなければPASSします．</p> <p>続いて，ルートテーブルのlookup処理です．
XDPではカーネルのルートテーブルを参照することができます．
参照のためには</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>bpf_fib_lookup<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ctx<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>params<span class="token punctuation">,</span> <span class="token keyword">int</span> plen<span class="token punctuation">,</span> __u32 flags<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token comment">// NOLINT</span>
     BPF_FUNC_fib_lookup<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>という関数を使用します．
この<code>bpf_fib_lookup()</code>に渡す<code>bpf_fib_lookup</code>構造体の定義について確認します．</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">bpf_fib_lookup</span> <span class="token punctuation">{</span>
  <span class="token comment">/* input:  network family for lookup (AF_INET, AF_INET6)
  * output: network family of egress nexthop
  */</span>
  __u8	family<span class="token punctuation">;</span>
  <span class="token comment">/* set if lookup is to consider L4 data - e.g., FIB rules */</span>
  __u8	l4_protocol<span class="token punctuation">;</span>
  __be16	sport<span class="token punctuation">;</span>
  __be16	dport<span class="token punctuation">;</span>
  <span class="token comment">/* total length of packet from network header - used for MTU check */</span>
  __u16	tot_len<span class="token punctuation">;</span>
  <span class="token comment">/* input: L3 device index for lookup
  * output: device index from FIB lookup
  */</span>
  __u32	ifindex<span class="token punctuation">;</span>
  <span class="token keyword">union</span> <span class="token punctuation">{</span>
    <span class="token comment">/* inputs to lookup */</span>
    __u8	tos<span class="token punctuation">;</span>		<span class="token comment">/* AF_INET  */</span>
    __be32	flowinfo<span class="token punctuation">;</span>	<span class="token comment">/* AF_INET6, flow_label + priority */</span>
    <span class="token comment">/* output: metric of fib result (IPv4/IPv6 only) */</span>
    __u32	rt_metric<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">union</span> <span class="token punctuation">{</span>
    __be32		ipv4_src<span class="token punctuation">;</span>
    __u32		ipv6_src<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">/* in6_addr; network order */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">/* input to bpf_fib_lookup, ipv{4,6}_dst is destination address in
  * network header. output: bpf_fib_lookup sets to gateway address
  * if FIB lookup returns gateway route
  */</span>
  <span class="token keyword">union</span> <span class="token punctuation">{</span>
    __be32		ipv4_dst<span class="token punctuation">;</span>
    __u32		ipv6_dst<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">/* in6_addr; network order */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">/* output */</span>
  __be16	h_vlan_proto<span class="token punctuation">;</span>
  __be16	h_vlan_TCI<span class="token punctuation">;</span>
  __u8	smac<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>     <span class="token comment">/* ETH_ALEN */</span>
  __u8	dmac<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>     <span class="token comment">/* ETH_ALEN */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>ご覧のようにかなりいろいろなフィールドが定義されています．
しかし，単なるIPv4ルートテーブルを参照するだけであればそこまで大変ではありません．
セットするフィールドは以下です．</p> <ul><li>family</li> <li>ipv4_src</li> <li>ipv4_dst</li> <li>ifindex</li></ul> <p>これらのフィールドをIPパケットとingressのifindexをもとにセットし，<code>bpf_fib_lookup()</code>に渡します．
その結果がfailedでなく<code>no neigh</code>でなければルートが引けたことになるのでその結果が引数として渡した<code>fib_params</code>に格納されます．</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">bpf_fib_lookup</span> fib_params<span class="token punctuation">;</span>
<span class="token comment">// fill struct with zeroes, so we are sure no data is missing</span>
<span class="token function">__builtin_memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fib_params<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>fib_params<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fib_params<span class="token punctuation">.</span>family	<span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
<span class="token comment">// use daddr as source in the lookup, so we refleect packet back (as if it wcame from us)</span>
fib_params<span class="token punctuation">.</span>ipv4_src	<span class="token operator">=</span> ip_header<span class="token operator">-&gt;</span>daddr<span class="token punctuation">;</span>
<span class="token comment">// opposite here, the destination is the source of the icmp packet..remote end</span>
fib_params<span class="token punctuation">.</span>ipv4_dst	<span class="token operator">=</span> ip_header<span class="token operator">-&gt;</span>saddr<span class="token punctuation">;</span>
fib_params<span class="token punctuation">.</span>ifindex <span class="token operator">=</span> ctx<span class="token operator">-&gt;</span>ingress_ifindex<span class="token punctuation">;</span>
<span class="token function">bpf_printk</span><span class="token punctuation">(</span><span class="token string">&quot;doing route lookup dst: %d\n&quot;</span><span class="token punctuation">,</span> fib_params<span class="token punctuation">.</span>ipv4_dst<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token function">bpf_fib_lookup</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fib_params<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>fib_params<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rc <span class="token operator">!=</span> BPF_FIB_LKUP_RET_SUCCESS<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>rc <span class="token operator">!=</span> BPF_FIB_LKUP_RET_NO_NEIGH<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">bpf_printk</span><span class="token punctuation">(</span><span class="token string">&quot;Dropping packet\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> XDP_DROP<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> BPF_FIB_LKUP_RET_NO_NEIGH<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// here we should let packet pass so we resolve arp.</span>
    <span class="token function">bpf_printk</span><span class="token punctuation">(</span><span class="token string">&quot;Passing packet, lookup returned %d\n&quot;</span><span class="token punctuation">,</span> BPF_FIB_LKUP_RET_NO_NEIGH<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> XDP_PASS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>ルートが引けたらリダイレクト処理を行います．
IPパケットの宛先と送信元を入れ替えます．
さらに<code>fib_params</code>に格納された<code>dmac</code>と<code>smac</code>をパケットに上書きします．
そして，</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>bpf_redirect_map<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>map<span class="token punctuation">,</span> __u32 key<span class="token punctuation">,</span> __u64 flags<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token comment">// NOLINT</span>
     BPF_FUNC_redirect_map<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>を実行してリダイレクトします．
引数には定義したDEVMAPである<code>if_redirect</code>, それをlookupするキーとしてのifindex, flagは0です．</p> <p>これによりICMPパケットを送信元にそのままリダイレクトします．</p> <h5 id="go-4"><a href="#go-4" class="header-anchor">#</a> Go</h5> <p>続いてGoのコントロールプレーンをみていきます．
コマンドライン引数のパースやXDPプログラムのロードとアタッチはこれまでと同様です．
今回はNICを二つ引数として渡してあげます．
<code>bpf2go</code>で自動生成した関数を用いたプログラムのロードはれまでと同様です．
今回のリダイレクトのプログラムは二つのNICにアタッチしなければなりません．
さらに，アタッチするNICのインデックスを<code>DEVMAP</code>に登録する必要があります．
そこで以下のように<code>Attach()</code>関数を作成して上記の操作をまとめてしまいます．</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Attach</span><span class="token punctuation">(</span>infList <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> prog <span class="token operator">*</span>ebpf<span class="token punctuation">.</span>Program<span class="token punctuation">,</span> ifRedirect <span class="token operator">*</span>ebpf<span class="token punctuation">.</span>Map<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> inf <span class="token operator">:=</span> <span class="token keyword">range</span> infList <span class="token punctuation">{</span>
		link<span class="token punctuation">,</span> err <span class="token operator">:=</span> netlink<span class="token punctuation">.</span><span class="token function">LinkByName</span><span class="token punctuation">(</span>inf<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> netlink<span class="token punctuation">.</span><span class="token function">LinkSetXdpFdWithFlags</span><span class="token punctuation">(</span>link<span class="token punctuation">,</span> prog<span class="token punctuation">.</span><span class="token function">FD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nl<span class="token punctuation">.</span>XDP_FLAGS_SKB_MODE<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> ifRedirect<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span><span class="token function">uint32</span><span class="token punctuation">(</span>link<span class="token punctuation">.</span><span class="token function">Attrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Index<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">uint32</span><span class="token punctuation">(</span>link<span class="token punctuation">.</span><span class="token function">Attrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><code>Detach()</code>も同様に定義しておき<code>defer</code>に渡しておきます．
そのあとは<code>Ctrl + c</code>での終了処理を行うのみです．</p> <div class="language-gov line-numbers-mode"><pre class="language-text"><code>if err := Attach(infList, collect.Prog, collect.IfRedirect); err != nil {
		panic(err)
}
defer Detach(infList)
ctrlC := make(chan os.Signal, 1)
signal.Notify(ctrlC, os.Interrupt)
for {
	select {
	case &lt;-ctrlC:
		fmt.Println(&quot;\nDetaching program and exit&quot;)
		return
	}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h5 id="実行-4"><a href="#実行-4" class="header-anchor">#</a> 実行</h5> <p>それでは動かしてみましょう．
今回も<code>netns</code>で実験を行います．</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ go generate
$ go build <span class="token builtin class-name">.</span>
$ <span class="token function">sudo</span> ./netns.sh build
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>それでは動かしてみます．
今回は以下のようにこれまでと少し異なる環境を用意しています．
<img src="/img/xdp-example-network-2.png" alt="xdp-example-network-2.png"></p> <p>XDPプログラムは<code>node1</code>で<code>veth1</code>と<code>veth2</code>にアタッチします．</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> node1 ./bpf_redirect_map -iflist veth1,veth2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>コンソールが返ってこなければ正常に動作しています．
今回は特に何も出力してくれないので別ターミナルで<code>ping</code>と<code>tcpdump</code>を使って確認します．</p> <p>それでは<code>192.168.1.5</code>に<code>ping</code>を飛ばしてみます．その様子を<code>tcpdump</code>で確認します．</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token function">ping</span> -c <span class="token number">1</span> <span class="token number">192.168</span>.1.5
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>まずは<code>bpf_redirect_map</code>を動かさない状態でパケットを確認します．</p> <h6 id="bpf-redirect-mapなし"><a href="#bpf-redirect-mapなし" class="header-anchor">#</a> bpf_redirect_mapなし</h6> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">sudo</span> tcpdump -i veth0 -n -vvv
tcpdump: listening on veth0, link-type EN10MB <span class="token punctuation">(</span>Ethernet<span class="token punctuation">)</span>, capture size <span class="token number">262144</span> bytes
<span class="token number">11</span>:09:49.160300 IP <span class="token punctuation">(</span>tos 0x0, ttl <span class="token number">64</span>, <span class="token function">id</span> <span class="token number">19056</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>DF<span class="token punctuation">]</span>, proto ICMP <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>, length <span class="token number">84</span><span class="token punctuation">)</span>
    <span class="token number">192.168</span>.0.3 <span class="token operator">&gt;</span> <span class="token number">192.168</span>.1.5: ICMP <span class="token builtin class-name">echo</span> request, <span class="token function">id</span> <span class="token number">57</span>, <span class="token function">seq</span> <span class="token number">1</span>, length <span class="token number">64</span>
<span class="token number">11</span>:09:49.160339 IP <span class="token punctuation">(</span>tos 0x0, ttl <span class="token number">63</span>, <span class="token function">id</span> <span class="token number">13495</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>none<span class="token punctuation">]</span>, proto ICMP <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>, length <span class="token number">84</span><span class="token punctuation">)</span>
    <span class="token number">192.168</span>.1.5 <span class="token operator">&gt;</span> <span class="token number">192.168</span>.0.3: ICMP <span class="token builtin class-name">echo</span> reply, <span class="token function">id</span> <span class="token number">57</span>, <span class="token function">seq</span> <span class="token number">1</span>, length <span class="token number">64</span>
^C
<span class="token number">2</span> packets captured
<span class="token number">2</span> packets received by filter
<span class="token number">0</span> packets dropped by kernel
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>このようにecho request, replyが一往復みられます．</p> <p>つぎに<code>bpf_redirect_map</code>を動かした状態で同様に<code>ping</code>を飛ばしてみます．</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ <span class="token function">sudo</span> <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> node1 ./bpf_redirect_map -iflist veth1,veth2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h6 id="bpf-redirect-mapあり"><a href="#bpf-redirect-mapあり" class="header-anchor">#</a> bpf_redirect_mapあり</h6> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">sudo</span> tcpdump -i veth0 -n -vvv
tcpdump: listening on veth0, link-type EN10MB <span class="token punctuation">(</span>Ethernet<span class="token punctuation">)</span>, capture size <span class="token number">262144</span> bytes
<span class="token number">11</span>:13:10.304324 IP <span class="token punctuation">(</span>tos 0x0, ttl <span class="token number">64</span>, <span class="token function">id</span> <span class="token number">29369</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>DF<span class="token punctuation">]</span>, proto ICMP <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>, length <span class="token number">84</span><span class="token punctuation">)</span>
    <span class="token number">192.168</span>.0.3 <span class="token operator">&gt;</span> <span class="token number">192.168</span>.1.5: ICMP <span class="token builtin class-name">echo</span> request, <span class="token function">id</span> <span class="token number">58</span>, <span class="token function">seq</span> <span class="token number">1</span>, length <span class="token number">64</span>
<span class="token number">11</span>:13:10.304357 IP <span class="token punctuation">(</span>tos 0x0, ttl <span class="token number">64</span>, <span class="token function">id</span> <span class="token number">29369</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>DF<span class="token punctuation">]</span>, proto ICMP <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>, length <span class="token number">84</span><span class="token punctuation">)</span>
    <span class="token number">192.168</span>.1.5 <span class="token operator">&gt;</span> <span class="token number">192.168</span>.0.3: ICMP <span class="token builtin class-name">echo</span> request, <span class="token function">id</span> <span class="token number">58</span>, <span class="token function">seq</span> <span class="token number">1</span>, length <span class="token number">64</span>
<span class="token number">11</span>:13:10.304493 IP <span class="token punctuation">(</span>tos 0x0, ttl <span class="token number">64</span>, <span class="token function">id</span> <span class="token number">29370</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>none<span class="token punctuation">]</span>, proto ICMP <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>, length <span class="token number">84</span><span class="token punctuation">)</span>
    <span class="token number">192.168</span>.0.3 <span class="token operator">&gt;</span> <span class="token number">192.168</span>.1.5: ICMP <span class="token builtin class-name">echo</span> reply, <span class="token function">id</span> <span class="token number">58</span>, <span class="token function">seq</span> <span class="token number">1</span>, length <span class="token number">64</span>
<span class="token number">11</span>:13:10.304500 IP <span class="token punctuation">(</span>tos 0x0, ttl <span class="token number">64</span>, <span class="token function">id</span> <span class="token number">29370</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>none<span class="token punctuation">]</span>, proto ICMP <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>, length <span class="token number">84</span><span class="token punctuation">)</span>
    <span class="token number">192.168</span>.1.5 <span class="token operator">&gt;</span> <span class="token number">192.168</span>.0.3: ICMP <span class="token builtin class-name">echo</span> reply, <span class="token function">id</span> <span class="token number">58</span>, <span class="token function">seq</span> <span class="token number">1</span>, length <span class="token number">64</span>
^C
<span class="token number">4</span> packets captured
<span class="token number">4</span> packets received by filter
<span class="token number">0</span> packets dropped by kernel
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>今度は4つパケットがキャプチャされています．
ICMPのIDをみてみるとどのパケットも58となっています．
一方で宛先と送信元が入れ替わっているパケットがみられます．</p> <p>このようにNICからNICへのリダイレクト処理もXDPで行うことができます．</p> <p>実験終了後には<code>netns</code>をお掃除しましょう．</p> <h2 id="おわりに"><a href="#おわりに" class="header-anchor">#</a> おわりに</h2> <p>今回はXDPに入門してみました．
だいぶ大作な記事になってしまいました．</p> <p>XDPの概要やXDPを扱うために必要な周辺知識の紹介，実践編と段階的にXDPを理解できるように書きました．
結構ハマりどころが多い技術なので，私が勉強する際にハマった箇所はできるだけ書き起こしました．
XDP関連の日本語の記事はあまり多くないため参考になれば幸いです．</p> <p>XDPでパケット処理しましょう．</p> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <h3 id="日本語"><a href="#日本語" class="header-anchor">#</a> 日本語</h3> <ul><li><a href="http://gundam-hathaway.net/mecha.html" target="_blank" rel="noopener noreferrer">http://gundam-hathaway.net/mecha.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://yunazuno.hatenablog.com/entry/2016/10/11/090245" target="_blank" rel="noopener noreferrer">Linuxカーネルの新機能 XDP (eXpress Data Path) を触ってみる<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://atmarkit.itmedia.co.jp/ait/articles/1811/21/news010.html" target="_blank" rel="noopener noreferrer">パケットフィルターでトレーシング？　Linuxで活用が進む「Berkeley Packet Filter（BPF）」とは何か<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://blog.bobuhiro11.net/2020/09-17-xdp.html" target="_blank" rel="noopener noreferrer">XDPメモ（アーキテクチャ、性能、ユースケース）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://speakerdeck.com/yunazuno/brief-summary-of-xdp-and-use-case-at-line" target="_blank" rel="noopener noreferrer">eXpress Data Path (XDP) の概要とLINEにおける利活用<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.janog.gr.jp/meeting/janog45/application/files/1615/7984/1029/008_pktfwd-xdp_kusakabe_00.pdf" target="_blank" rel="noopener noreferrer">パケット処理の独自実装や高速化手法の比較と実践<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://speakerdeck.com/mabuchin/zhuan-binagaramonetutowakuchu-li-wo-sohutoueadezi-zuo-siteikuhua" target="_blank" rel="noopener noreferrer">転びながらもネットワーク処理をソフトウェアで自作していく話<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://yunazuno.hatenablog.com/entry/2017/06/12/094101" target="_blank" rel="noopener noreferrer">Generic XDPを使えばXDP動作環境がお手軽に構築できるようになった<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://takeio.hatenablog.com/entry/2019/12/05/212945" target="_blank" rel="noopener noreferrer">今日から始めるXDPと取り巻く環境について<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://takeio.hatenablog.com/entry/2021/01/26/180129" target="_blank" rel="noopener noreferrer">Go+XDPな開発を始めるときに参考になる記事/janog LT フォローアップ<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://chipa34.hatenadiary.org/entry/20081217/1229479548" target="_blank" rel="noopener noreferrer">ヘッダ構造体メモ<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h3 id="英語"><a href="#英語" class="header-anchor">#</a> 英語</h3> <ul><li><a href="https://man7.org/linux/man-pages/man2/bpf.2.html" target="_blank" rel="noopener noreferrer">bpf(2) - Linux manual page - man7.org<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://man7.org/linux/man-pages/man7/bpf-helpers.7.html" target="_blank" rel="noopener noreferrer">bpf-helpers(7) - Linux manual page - man7.org<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.iovisor.org/technology/xdp" target="_blank" rel="noopener noreferrer">XDP - IO Visor Project<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.linuxplumbersconf.org/event/2/contributions/71/attachments/17/9/presentation-lpc2018-xdp-tutorial.pdf" target="_blank" rel="noopener noreferrer">A practical introduction to XDP<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://blog.cloudflare.com/l4drop-xdp-ebpf-based-ddos-mitigations/" target="_blank" rel="noopener noreferrer">L4Drop: XDP DDoS Mitigations<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://engineering.fb.com/2018/05/22/open-source/open-sourcing-katran-a-scalable-network-load-balancer/" target="_blank" rel="noopener noreferrer">Open-sourcing Katran, a scalable network load balancer<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://prototype-kernel.readthedocs.io/en/latest/networking/XDP/implementation/xdp_actions.html" target="_blank" rel="noopener noreferrer">XDP Actions<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://blogs.oracle.com/linux/post/bpf-in-depth-communicating-with-userspace" target="_blank" rel="noopener noreferrer">BPF In Depth: Communicating with Userspace<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://docs.cilium.io/en/stable/bpf/#llvm" target="_blank" rel="noopener noreferrer">cilium docs bpf #llvm<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://medium.com/@christina.jacob.koikara/how-to-compile-a-kernel-with-xdp-support-c245ed3460f1" target="_blank" rel="noopener noreferrer">How to compile a kernel with XDP support<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://pingcap.com/blog/tips-and-tricks-for-writing-linux-bpf-applications-with-libbpf#reduce-pre-allocation-overhead" target="_blank" rel="noopener noreferrer">Reduce pre-allocation overhead<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/cilium/ebpf" target="_blank" rel="noopener noreferrer">cilium/ebpf<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/dropbox/goebpf" target="_blank" rel="noopener noreferrer">dropbox/goebpf<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/vishvananda/netlink" target="_blank" rel="noopener noreferrer">vishvananda/netlink<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></article> <section class="post-meta main-div" data-v-4e23451f><section class="post-date clearfix" data-v-4e23451f><span class="create-date" data-v-4e23451f>
      Created : 2021-10-18
    </span> <span class="update-date" data-v-4e23451f>
      Updated : 2021-11-17
    </span></section> <section class="post-links" data-v-4e23451f><a href="/posts/2021/10/07/use-xdpcap.html" class="post-link" data-v-4e23451f>
      Previous Post : Goのcilium/ebpfでXdpcapを使う
    </a> <!----></section></section> <div id="post-comments" class="main-div"><!----></div></div></main> <aside class="aside" data-v-4dd605a1><div class="info-card main-div" data-v-9d847660 data-v-4dd605a1><div class="info-card-header" style="background-size:cover;background-repeat:no-repeat;background-position:center;background-attachment:scroll;background-image:url(/img/bg.jpg);" data-v-9d847660><img src="/img/avatar.jpg" alt="terassyi" class="info-avatar" data-v-9d847660></div> <div class="info-card-body" data-v-9d847660><section class="info-nickname" data-v-9d847660>
      terassyi
    </section> <section class="info-desc" data-v-9d847660>Fortune favors the brave</section> <section class="info-contact" data-v-9d847660><section data-v-9d847660><span title="Fukuoka City, Japan" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>Fukuoka City, Japan</title><use xlink:href="#icon-location" data-v-9d847660 data-v-9d847660></use></svg><span class="info-text" data-v-9d847660 data-v-9d847660>
          Fukuoka City, Japan
        </span></span></section> <section data-v-9d847660><span title="Kyushu University" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>Kyushu University</title><use xlink:href="#icon-organization" data-v-9d847660 data-v-9d847660></use></svg><span class="info-text" data-v-9d847660 data-v-9d847660>
          Kyushu University
        </span></span></section> <section data-v-9d847660><a href="mailto:iscale821@gmail.com" title="iscale821@gmail.com" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>iscale821@gmail.com</title><use xlink:href="#icon-email" data-v-9d847660 data-v-9d847660></use></svg><span class="info-text" data-v-9d847660 data-v-9d847660>
          iscale821@gmail.com
        </span></a></section></section></div> <div class="info-card-footer" data-v-9d847660><section class="info-sns clearfix" data-v-9d847660><a href="https://github.com/terassyi" target="_blank" class="sns-link" data-v-9d847660><span title="GitHub: terassyi" class="sns-icon" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1.5em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>GitHub: terassyi</title><use xlink:href="#icon-github" data-v-9d847660 data-v-9d847660></use></svg></span></a><a href="https://twitter.com/terassyi_" target="_blank" class="sns-link" data-v-9d847660><span title="Twitter: terassyi" class="sns-icon" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1.5em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>Twitter: terassyi</title><use xlink:href="#icon-twitter" data-v-9d847660 data-v-9d847660></use></svg></span></a></section></div></div> <div class="post-nav-card main-div" style="position:relative;top:0;width:0px;" data-v-4dd605a1><div class="post-nav-contents"><svg class="icon"><title>book</title><use xlink:href="#icon-book"></use></svg> <span>Table of Contents</span> <div class="post-nav-toc"><ul><li><a href="/posts/2021/10/18/intro-xdp.html#xdp">XDP</a></li><li><a href="/posts/2021/10/18/intro-xdp.html#ユースケース">ユースケース</a></li><li><a href="/posts/2021/10/18/intro-xdp.html#アーキテクチャ-仕組み">アーキテクチャ(仕組み)</a><ul><li><a href="/posts/2021/10/18/intro-xdp.html#xdp-actions">XDP Actions</a></li><li><a href="/posts/2021/10/18/intro-xdp.html#bpf-map">BPF Map</a></li><li><a href="/posts/2021/10/18/intro-xdp.html#bpf-map-type">BPF Map Type</a></li><li><a href="/posts/2021/10/18/intro-xdp.html#ヘルパー関数">ヘルパー関数</a></li></ul></li><li><a href="/posts/2021/10/18/intro-xdp.html#generic-xdp">Generic XDP</a></li><li><a href="/posts/2021/10/18/intro-xdp.html#実験環境">実験環境</a></li><li><a href="/posts/2021/10/18/intro-xdp.html#使い方">使い方</a><ul><li><a href="/posts/2021/10/18/intro-xdp.html#xdpが有効なカーネルであるか確認-依存関係の解決">XDPが有効なカーネルであるか確認, 依存関係の解決</a></li><li><a href="/posts/2021/10/18/intro-xdp.html#nicの設定">NICの設定</a></li><li><a href="/posts/2021/10/18/intro-xdp.html#c言語-制限付き-でプログラムを記述する">C言語(制限付き)でプログラムを記述する</a></li><li><a href="/posts/2021/10/18/intro-xdp.html#clangでbpfバイトコードにコンパイルする">clangでBPFバイトコードにコンパイルする</a></li><li><a href="/posts/2021/10/18/intro-xdp.html#カーネルにロードする">カーネルにロードする</a></li></ul></li><li><a href="/posts/2021/10/18/intro-xdp.html#実践">実践</a><ul><li><a href="/posts/2021/10/18/intro-xdp.html#bpf-xdp-用c言語のお作法">BPF(XDP)用C言語のお作法</a></li><li><a href="/posts/2021/10/18/intro-xdp.html#チュートリアル">チュートリアル</a></li></ul></li><li><a href="/posts/2021/10/18/intro-xdp.html#おわりに">おわりに</a></li><li><a href="/posts/2021/10/18/intro-xdp.html#参考">参考</a><ul><li><a href="/posts/2021/10/18/intro-xdp.html#日本語">日本語</a></li><li><a href="/posts/2021/10/18/intro-xdp.html#英語">英語</a></li></ul></li></ul></div></div> <div class="post-nav-comments"><svg class="icon"><title>comment</title><use xlink:href="#icon-comment"></use></svg> <a href="/posts/2021/10/18/intro-xdp.html#post-comments">
      Comments
    </a></div></div></aside></div> <footer class="footer" data-v-1375e54c><p class="footer-sns-links" data-v-1375e54c><a href="https://github.com/terassyi" target="_blank" class="sns-link" data-v-1375e54c><span title="GitHub: terassyi" class="sns-icon" data-v-1375e54c data-v-1375e54c><svg class="icon" style="font-size:25px;" data-v-1375e54c data-v-1375e54c><title data-v-1375e54c data-v-1375e54c>GitHub: terassyi</title><use xlink:href="#icon-github" data-v-1375e54c data-v-1375e54c></use></svg></span></a><a href="https://twitter.com/terassyi_" target="_blank" class="sns-link" data-v-1375e54c><span title="Twitter: terassyi" class="sns-icon" data-v-1375e54c data-v-1375e54c><svg class="icon" style="font-size:25px;" data-v-1375e54c data-v-1375e54c><title data-v-1375e54c data-v-1375e54c>Twitter: terassyi</title><use xlink:href="#icon-twitter" data-v-1375e54c data-v-1375e54c></use></svg></span></a></p> <p class="footer-text" data-v-1375e54c><span data-v-1375e54c>Powered by </span> <a href="https://github.com/vuejs/vuepress" target="_blank" data-v-1375e54c>
      VuePress
    </a> <span data-v-1375e54c> | </span> <a href="https://github.com/meteorlxy/vuepress-theme-meteorlxy" target="_blank" data-v-1375e54c>
        meteorlxy
      </a></p> <p class="footer-text" data-v-1375e54c>Copyright 2018-present <a href="https://github.com/meteorlxy" target="_blank">meteorlxy</a> | MIT License</p></footer></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.cc7256d4.js" defer></script><script src="/assets/js/12.4d6eb347.js" defer></script><script src="/assets/js/6.aca649e2.js" defer></script>
  </body>
</html>
