<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>自作コンテナランタイムでつまずいてる話 | terassyi</title>
    <meta name="description" content="自作コンテナランタイムに挑戦しています．しかし，なかなかエラーが解決しないので現状についてまとめます．">
    <meta name="generator" content="VuePress 1.4.0">
    <meta property="article:published_time" content="2020-05-08T00:00:00.000Z"><meta property="article:modified_time" content="2020-05-10T07:19:14.000Z"><meta property="og:site_name" content="terassyi"><meta property="og:title" content="自作コンテナランタイムでつまずいてる話"><meta property="og:description" content="自作コンテナランタイムに挑戦しています．しかし，なかなかエラーが解決しないので現状についてまとめます．"><meta property="og:type" content="website"><meta property="og:url" content="/posts/2020/05/08/container.html"><meta name="twitter:title" content="自作コンテナランタイムでつまずいてる話"><meta name="twitter:description" content="自作コンテナランタイムに挑戦しています．しかし，なかなかエラーが解決しないので現状についてまとめます．"><meta name="twitter:url" content="/posts/2020/05/08/container.html"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:label2" content="Filed under"><meta name="twitter:data2" content="container, runc, golang, OCI-runtime, mycon"><meta property="article:tag" content="container"><meta property="article:tag" content="runc"><meta property="article:tag" content="golang"><meta property="article:tag" content="OCI-runtime"><meta property="article:tag" content="mycon">
    <link rel="preload" href="/assets/css/0.styles.59c2fb62.css" as="style"><link rel="preload" href="/assets/js/app.7e3d47b8.js" as="script"><link rel="preload" href="/assets/js/10.b0186384.js" as="script"><link rel="preload" href="/assets/js/4.82cf18b4.js" as="script"><link rel="preload" href="/assets/js/17.1ed29426.js" as="script"><link rel="prefetch" href="/assets/js/1.e8d6dc79.js"><link rel="prefetch" href="/assets/js/11.4ec12c96.js"><link rel="prefetch" href="/assets/js/12.f8afba66.js"><link rel="prefetch" href="/assets/js/13.d02e2fa8.js"><link rel="prefetch" href="/assets/js/14.ce2cd9e7.js"><link rel="prefetch" href="/assets/js/15.2be46745.js"><link rel="prefetch" href="/assets/js/16.bf085fee.js"><link rel="prefetch" href="/assets/js/18.bca0d097.js"><link rel="prefetch" href="/assets/js/19.d5820c36.js"><link rel="prefetch" href="/assets/js/20.285273ee.js"><link rel="prefetch" href="/assets/js/21.a1c766d9.js"><link rel="prefetch" href="/assets/js/22.b55b7a21.js"><link rel="prefetch" href="/assets/js/23.3dfad1ab.js"><link rel="prefetch" href="/assets/js/24.40c7d8ee.js"><link rel="prefetch" href="/assets/js/25.29abe8a0.js"><link rel="prefetch" href="/assets/js/26.299fab86.js"><link rel="prefetch" href="/assets/js/27.72bce85a.js"><link rel="prefetch" href="/assets/js/28.be7f4a69.js"><link rel="prefetch" href="/assets/js/29.e241e241.js"><link rel="prefetch" href="/assets/js/3.d7714460.js"><link rel="prefetch" href="/assets/js/30.65c74bd7.js"><link rel="prefetch" href="/assets/js/31.b7c3306f.js"><link rel="prefetch" href="/assets/js/5.185a277d.js"><link rel="prefetch" href="/assets/js/6.5a50f8e3.js"><link rel="prefetch" href="/assets/js/7.d5c2cb42.js"><link rel="prefetch" href="/assets/js/8.c19945a8.js"><link rel="prefetch" href="/assets/js/9.60a12ce3.js">
    <link rel="stylesheet" href="/assets/css/0.styles.59c2fb62.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-meteorlxy"><header class="header" style="background-size:cover;background-repeat:no-repeat;background-position:center;background-attachment:scroll;background-image:url(/img/bg.jpg);" data-v-7a046aea><div data-v-e4145d0a data-v-7a046aea><nav class="navbar" data-v-e4145d0a><div class="container" data-v-e4145d0a><a href="/" class="router-link-active" data-v-e4145d0a><span class="navbar-site-name" data-v-e4145d0a>
          terassyi
        </span></a> <div class="navbar-toggler" data-v-e4145d0a><svg class="icon" style="font-size:1.2em;" data-v-e4145d0a data-v-e4145d0a><title data-v-e4145d0a data-v-e4145d0a>menu</title><use xlink:href="#icon-menu" data-v-e4145d0a data-v-e4145d0a></use></svg></div> <div class="navbar-links" data-v-e4145d0a><a href="/" class="navbar-link" data-v-e4145d0a>
            Home
          </a><a href="/posts/" class="navbar-link router-link-active" data-v-e4145d0a>
            Posts
          </a><a href="/about/" class="navbar-link" data-v-e4145d0a>
            About
          </a></div></div></nav> <div class="navbar-holder" style="display:none;" data-v-e4145d0a></div></div> <div class="banner" data-v-98d6aa8c data-v-7a046aea data-v-7a046aea><div class="container" data-v-98d6aa8c><div class="center" data-v-98d6aa8c><h1 data-v-98d6aa8c data-v-7a046aea>
          自作コンテナランタイムでつまずいてる話
        </h1></div></div></div></header> <div class="container clearfix show-aside" data-v-4dd605a1 data-v-4dd605a1><main class="main" data-v-4dd605a1><div class="post" data-v-4dd605a1 data-v-4dd605a1><section class="post-meta main-div" data-v-4e23451f><section class="post-date clearfix" data-v-4e23451f><span class="create-date" data-v-4e23451f>
      Created : 2020-05-08
    </span> <span class="update-date" data-v-4e23451f>
      Updated : 2020-05-10
    </span></section> <section class="post-links" data-v-4e23451f><a href="/posts/2020/04/29/runc.html" class="post-link" data-v-4e23451f>
      Previous Post : runcを使ってみる
    </a> <a href="/posts/2020/05/24/ctf4b.html" class="post-link" data-v-4e23451f>
      Next Post : SECCON Beginners CTF 2020解けた問題 writeup
    </a></section></section> <article class="main-div"><div class="post-content content content__default"><p>こんにちは．緊急事態宣言がのびたので相変わらずの外出自粛中です．最近は外出自粛にも少し慣れましたがやはり退屈です．僕は作業中のBGMとして何度か見たことのあるアニメなどを流しているんですがそれらのストックも無くなってきています．ループしようかな．ちなみにおすすめはガンダムUCですね．音楽が素晴らしいですし，SFアニメはモチベが上がっていいです．
さて，今回は自作コンテナランタイムに挑戦したという話です．<a href="https://terassyi.net/posts/2020/04/29/runc.html" target="_blank" rel="noopener noreferrer">前回のポスト<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>では<code>runc</code>を使ってみましたが，今回は<code>runc</code>を参考に挑戦してみました．</p> <p>ちなみにコード書いて試してたときに<code>rm -rf</code>で書いてたコード全消去して萎えました．
<div></div></p> <p>gitで管理するのって大事ですね．
リポジトリはこちら</p> <p><a href="https://github.com/terassyi/mycon" target="_blank" rel="noopener noreferrer">https://github.com/terassyi/mycon<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="タイトルについて"><a href="#タイトルについて" class="header-anchor">#</a> タイトルについて</h2> <p>タイトルにつまずいているとつけましたが，つまずいてます．長い間同じ箇所でエラーがでて前に進めていません．
僕の魂の叫びがこちら．
<div></div>
このあと力付きこの記事を書き始めております．
ツイートの通り，マウントでつまずいております．
どなたか有識者の方に助けていただきたいです．</p> <h2 id="問題"><a href="#問題" class="header-anchor">#</a> 問題</h2> <p>発生している問題は</p> <blockquote><p><code>rootfs/dev/pts</code>に<code>devpts</code>でマウントできない</p></blockquote> <p>という問題です．
コンテナプロセスの設定ファイルである<code>config.json</code>でいうと以下の部分です．</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
	<span class="token property">&quot;destination&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/dev/pts&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;devpts&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;source&quot;</span><span class="token operator">:</span> <span class="token string">&quot;devpts&quot;</span><span class="token punctuation">,</span>
	<span class="token property">&quot;options&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
		<span class="token string">&quot;rw&quot;</span><span class="token punctuation">,</span>
		<span class="token string">&quot;mode=0620&quot;</span><span class="token punctuation">,</span>
		<span class="token string">&quot;gid=5&quot;</span>
	<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>実際にマウントを行うのは以下のコードです．
標準パッケージのマウントシステムコールのラッパー関数を呼び出しています．</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Mount</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Source<span class="token punctuation">,</span> target<span class="token punctuation">,</span> m<span class="token punctuation">.</span>Type<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> err
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><code>unix.Mount</code>メソッドに</p> <ul><li>m.Source = devpts</li> <li>target = rootfs/dev/ptsへの絶対パス</li> <li>m.Type = devpts</li> <li>flags = 0(オプションから得られるフラグ)</li> <li>data = mode=0620,gid=5</li></ul> <p>という感じで引数を渡しています．
すると<code>Invalid argument</code>エラーを発生させます．</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>DEBU[0000] source=devpts                                
DEBU[0000] target=/usr/local/go/src/github.com/terassyi/mycon/bundle/rootfs/dev/pts 
DEBU[0000] mtype=devpts                                 
DEBU[0000] flags=0                                      
DEBU[0000] options=mode=0620,gid=5                      
DEBU[0000] invalid argument 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="問題の実験環境"><a href="#問題の実験環境" class="header-anchor">#</a> 問題の実験環境</h3> <p>詳しくは後述しますが，実験しているVMのイメージは<a href="https://app.vagrantup.com/ubuntu/boxes/xenial64" target="_blank" rel="noopener noreferrer">ubuntu/xenial64<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>です．
ルート直下の構成は以下の様な感じ</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ ls /
bin   dev  home        initrd.img.old  lib64       media  opt   root  sbin  srv  tmp  vagrant  vmlinuz
boot  etc  initrd.img  lib             lost+found  mnt    proc  run   snap  sys  usr  var      vmlinuz.old
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>また，コンテナプロセスとして起動しようとしているのはdockerイメージからエクスポートしたcentosです．
プロジェクトから<code>./bundle/rootfs/</code>以下にファイルを配置しています．</p> <h4 id="マウントされているファイルシステム"><a href="#マウントされているファイルシステム" class="header-anchor">#</a> マウントされているファイルシステム</h4> <p>マウントされているファイルシステムは以下の様な感じ.</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ mount
sysfs on /sys type sysfs (rw,nosuid,nodev,noexec,relatime)
proc on /proc type proc (rw,nosuid,nodev,noexec,relatime)
udev on /dev type devtmpfs (rw,nosuid,relatime,size=498852k,nr_inodes=124713,mode=755)
devpts on /dev/pts type devpts (rw,nosuid,noexec,relatime,mode=600,ptmxmode=000)
tmpfs on /run type tmpfs (rw,nosuid,noexec,relatime,size=101576k,mode=755)
/dev/sda1 on / type ext4 (rw,relatime,data=ordered)
securityfs on /sys/kernel/security type securityfs (rw,nosuid,nodev,noexec,relatime)
tmpfs on /dev/shm type tmpfs (rw,nosuid,nodev)
tmpfs on /run/lock type tmpfs (rw,nosuid,nodev,noexec,relatime,size=5120k)
tmpfs on /sys/fs/cgroup type tmpfs (ro,nosuid,nodev,noexec,mode=755)
cgroup on /sys/fs/cgroup/systemd type cgroup (rw,nosuid,nodev,noexec,relatime,xattr,release_agent=/lib/systemd/systemd-cgroups-agent,name=systemd)
pstore on /sys/fs/pstore type pstore (rw,nosuid,nodev,noexec,relatime)
cgroup on /sys/fs/cgroup/perf_event type cgroup (rw,nosuid,nodev,noexec,relatime,perf_event)
cgroup on /sys/fs/cgroup/freezer type cgroup (rw,nosuid,nodev,noexec,relatime,freezer)
cgroup on /sys/fs/cgroup/memory type cgroup (rw,nosuid,nodev,noexec,relatime,memory)
cgroup on /sys/fs/cgroup/devices type cgroup (rw,nosuid,nodev,noexec,relatime,devices)
cgroup on /sys/fs/cgroup/cpu,cpuacct type cgroup (rw,nosuid,nodev,noexec,relatime,cpu,cpuacct)
cgroup on /sys/fs/cgroup/net_cls,net_prio type cgroup (rw,nosuid,nodev,noexec,relatime,net_cls,net_prio)
cgroup on /sys/fs/cgroup/pids type cgroup (rw,nosuid,nodev,noexec,relatime,pids)
cgroup on /sys/fs/cgroup/blkio type cgroup (rw,nosuid,nodev,noexec,relatime,blkio)
cgroup on /sys/fs/cgroup/hugetlb type cgroup (rw,nosuid,nodev,noexec,relatime,hugetlb)
cgroup on /sys/fs/cgroup/cpuset type cgroup (rw,nosuid,nodev,noexec,relatime,cpuset)
mqueue on /dev/mqueue type mqueue (rw,relatime)
systemd-1 on /proc/sys/fs/binfmt_misc type autofs (rw,relatime,fd=33,pgrp=1,timeout=0,minproto=5,maxproto=5,direct)
hugetlbfs on /dev/hugepages type hugetlbfs (rw,relatime)
debugfs on /sys/kernel/debug type debugfs (rw,relatime)
fusectl on /sys/fs/fuse/connections type fusectl (rw,relatime)
lxcfs on /var/lib/lxcfs type fuse.lxcfs (rw,nosuid,nodev,relatime,user_id=0,group_id=0,allow_other)
vagrant on /vagrant type vboxsf (rw,nodev,relatime)
usr_local_go_src_github.com_terassyi_mycon on /usr/local/go/src/github.com/terassyi/mycon type vboxsf (rw,nodev,relatime)
tmpfs on /run/user/1000 type tmpfs (rw,nosuid,nodev,relatime,size=101576k,mode=700,uid=1000,gid=1000)
binfmt_misc on /proc/sys/fs/binfmt_misc type binfmt_misc (rw,relatime)
devpts on /usr/local/pts type devpts (rw,relatime,mode=600,ptmxmode=000)
usr_local_go_src_github.com_terassyi_mycon on /usr/local/go/src/github.com/terassyi/mycon/bundle/rootfs type vboxsf (rw,nodev,relatime)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>$ df -aH
Filesystem                                  Size  Used Avail Use% Mounted on
sysfs                                          0     0     0    - /sys
proc                                           0     0     0    - /proc
udev                                        511M     0  511M   0% /dev
devpts                                         0     0     0    - /dev/pts
tmpfs                                       105M  3.3M  101M   4% /run
/dev/sda1                                    11G  1.8G  8.7G  17% /
securityfs                                     0     0     0    - /sys/kernel/security
tmpfs                                       521M     0  521M   0% /dev/shm
tmpfs                                       5.3M     0  5.3M   0% /run/lock
tmpfs                                       521M     0  521M   0% /sys/fs/cgroup
cgroup                                         0     0     0    - /sys/fs/cgroup/systemd
pstore                                         0     0     0    - /sys/fs/pstore
cgroup                                         0     0     0    - /sys/fs/cgroup/perf_event
cgroup                                         0     0     0    - /sys/fs/cgroup/freezer
cgroup                                         0     0     0    - /sys/fs/cgroup/memory
cgroup                                         0     0     0    - /sys/fs/cgroup/devices
cgroup                                         0     0     0    - /sys/fs/cgroup/cpu,cpuacct
cgroup                                         0     0     0    - /sys/fs/cgroup/net_cls,net_prio
cgroup                                         0     0     0    - /sys/fs/cgroup/pids
cgroup                                         0     0     0    - /sys/fs/cgroup/blkio
cgroup                                         0     0     0    - /sys/fs/cgroup/hugetlb
cgroup                                         0     0     0    - /sys/fs/cgroup/cpuset
mqueue                                         0     0     0    - /dev/mqueue
systemd-1                                      -     -     -    - /proc/sys/fs/binfmt_misc
hugetlbfs                                      0     0     0    - /dev/hugepages
debugfs                                        0     0     0    - /sys/kernel/debug
fusectl                                        0     0     0    - /sys/fs/fuse/connections
lxcfs                                          0     0     0    - /var/lib/lxcfs
vagrant                                     500G  370G  131G  74% /vagrant
usr_local_go_src_github.com_terassyi_mycon  500G  370G  131G  74% /usr/local/go/src/github.com/terassyi/mycon
tmpfs                                       105M     0  105M   0% /run/user/1000
binfmt_misc                                    0     0     0    - /proc/sys/fs/binfmt_misc
devpts                                         0     0     0    - /usr/local/pts
usr_local_go_src_github.com_terassyi_mycon  500G  370G  131G  74% /usr/local/go/src/github.com/terassyi/mycon/bundle/rootfs
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>また，コマンドラインから<code>mount</code>を実行した場合はうまくいっている様です．</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ sudo mount -vt devpts devpts ./dev/pts/ -o mode=0620,gid=5
mount: devpts mounted on /usr/local/go/src/github.com/terassyi/mycon/bundle/rootfs/dev/pts.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>確認してみます．</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ mount | grep devpts
devpts on /dev/pts type devpts (rw,nosuid,noexec,relatime,gid=5,mode=620,ptmxmode=000)
devpts on /usr/local/pts type devpts (rw,relatime,gid=5,mode=620,ptmxmode=000)
devpts on /usr/local/go/src/github.com/terassyi/mycon/bundle/rootfs/dev/pts type devpts (rw,relatime,gid=5,mode=620,ptmxmode=000)
devpts on /usr/local/go/src/github.com/terassyi/mycon/bundle/rootfs/dev/pts type devpts (rw,relatime,gid=5,mode=620,ptmxmode=000)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>/usr/local/go/src/github.com/terassyi/mycon/bundle/rootfs$ ls dev/pts
0  1  ptmx
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>マウントリストにも出てきて，かつlsコマンドで<code>dev/pts</code>を覗くと<code>/dev/pts/</code>と同様のファイルが見えるのでマウントが完了している様に見えます．
しかし，作成したプログラムから実行するとエラーを発生させます．
マウントする順番の問題やその他プログラムの問題である可能性も考えつつ調査をしていましたが，なかなか解決策が見当たりません．
Linuxについて理解不足であることは間違いないので，もし原因や解決策に心当たりのある方がいらっしゃったらご教授お願いしたいです．</p> <h2 id="自作コンテナの動機"><a href="#自作コンテナの動機" class="header-anchor">#</a> 自作コンテナの動機</h2> <p>皆さんdocker好きですか？僕は好きです．
普段Macを使用しているのですが，Linuxをターゲットにしたプログラムを書くことが多いです．そのようなときにdockerは非常に簡単にLinuxの環境を構築でき，また，リポジトリに一緒に入れておくことでもし誰かが試してみたいと思ったときにコマンド一つで環境が再現できます．最近はVagrantを使用して環境構築を行うこともありますが基本的にdockerの方が便利ですよね．
さてここで気になるのはdockerがどのように仮想環境を実現しているかです．
ざっくりLinuxの<code>namespace</code>や<code>cgroup</code>などの機能を使用して実現しているという理解はあったのですが，詳しくはわかりませんでした．
そこで，仕組みを理解するには作ってみることが一番ということで自作してみるか，となりました．
しかし，現実はそう甘くないです．
<div></div> <div></div></p> <h2 id="実験環境"><a href="#実験環境" class="header-anchor">#</a> 実験環境</h2> <p>今回はVagrantを使用してMac上にubuntu VMを起動して実行しました．IDEはGolandを使用しました．
Mac上でLinuxをターゲットとして定義ジャンプなどできるので便利です．</p> <p>Vagrantfile</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Vagrant.configure(&quot;2&quot;) do |config|
  config.vm.box = &quot;ubuntu/xenial64&quot;
  config.vm.synced_folder &quot;./&quot;, &quot;/usr/local/go/src/github.com/terassyi/mycon&quot;
  config.vm.provision :shell, :path =&gt; &quot;./install.sh&quot;
end
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>install.sh</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#! /bin/sh
sudo apt update
# install golang
wget https://dl.google.com/go/go1.14.2.linux-amd64.tar.gz
sudo tar -C /usr/local -xzf go1.14.2.linux-amd64.tar.gz
rm go1.14.2.linux-amd64.tar.gz
echo &quot;export PATH=$PATH:/usr/local/go/bin&quot; &gt;&gt; .bashrc
# install docker
sudo apt -y install \
    apt-transport-https \
    ca-certificates \
    curl \
    gnupg-agent \
    software-properties-common
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
sudo add-apt-repository \
   &quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu \
   $(lsb_release -cs) \
   stable&quot;
sudo apt update
sudo apt -y install docker.io
sudo systemctl start docker
# add docker user group
sudo groupadd docker
sudo gpasswd -a $USER docker
sudo systemctl enable docker
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>さぁやりましょう．</p> <h2 id="runcについて"><a href="#runcについて" class="header-anchor">#</a> runcについて</h2> <p>まずは<code>runc</code>について．
runcでコンテナプロセスを作成するには<code>runc create [container id]</code>コマンドを実行します．
起動するには<code>runc start [container id]</code>ですね．
詳しくは<a href="https://terassyi.net/posts/2020/04/29/runc.html" target="_blank" rel="noopener noreferrer">前回のポスト<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>を参照してください．</p> <h3 id="runcがどのようにコンテナプロセスを起動するか"><a href="#runcがどのようにコンテナプロセスを起動するか" class="header-anchor">#</a> runcがどのようにコンテナプロセスを起動するか</h3> <p><code>runc create [container id]</code>を実行した後，runcはどのような処理を行ってコンテナプロセスが生成されるのでしょうか．
ここら辺を調べるためにruncのコードと格闘しました．
こちらの資料がすごく参考になりました．
<a href="https://medium.com/nttlabs/runc-overview-263b83164c98" target="_blank" rel="noopener noreferrer">コンテナユーザなら誰もが使っているランタイム「runc」を俯瞰する[Container Runtime Meetup #1発表レポート]<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
こちらの資料では<code>runc run</code>コマンドの実装について述べられています．runコマンドは新しいコンテナプロセスを生成して実行する<code>create + start</code>のようなコマンドなので基本的なフローはcreateの場合も同じです．
createコマンドが実行されると，内部で<code>runc init</code>というコマンドが名前空間を分離した上で別プロセスで実行されるようになっています．
その後，<code>init</code>プロセスにおいて，<code>cgroup</code>や<code>capabilities</code>，<code>pivot_root</code>などのリソース分離作業を行っています．
リソースの分離作業を終えると<code>start</code>コマンドからの起動シグナルを待ち受けてシグナルを受けるとセットされているコマンドを実行します．</p> <h3 id="リソースの分離について"><a href="#リソースの分離について" class="header-anchor">#</a> リソースの分離について</h3> <p>さて，リソースの分離とはどういったものでしょう．<code>namespace</code>や<code>cgroup</code>，<code>chroot</code>を使用しています．
<a href="https://employment.en-japan.com/engineerhub/entry/2019/02/05/103000#Capability" target="_blank" rel="noopener noreferrer">コンテナ技術入門 - 仮想化との違いを知り、要素技術を触って学ぼう<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>では，仮想マシンとコンテナの違いからLinuxコマンドを使用したコンテナの作成まで丁寧に説明されています．(僕が説明するより断然わかりやすいのでこちらを覗いてみてください)
一度手を動かしてみると非常に理解が進みます．
<code>chroot</code>と<code>pivot_root</code>の違いなどわかりやすかったです．</p> <h2 id="config-json"><a href="#config-json" class="header-anchor">#</a> config.json</h2> <p>作成するコンテナの設定は全て<code>config.json</code>に記述されています．このファイルは<code>runc spec</code>を実行するとテンプレートが作成されます．
基本的には変更せずに使用します．
ファイルの中身は前回のポストを参照してください．
<a href="https://terassyi.net/posts/2020/04/29/runc.html#config-json%E3%81%AE%E6%BA%96%E5%82%99" target="_blank" rel="noopener noreferrer">config.json<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>コンテナプロセスを作成する際に<code>config.json</code>からコンテナ起動時のコマンドやマウントするディレクトリ，cgroupやlinux capabilitiesなどの設定を読み込んで作成します．</p> <h2 id="開発"><a href="#開発" class="header-anchor">#</a> 開発</h2> <p>それでは作成したプログラムをみていきます．
CLIアプリケーションとして作成するので<a href="https://github.com/google/subcommands" target="_blank" rel="noopener noreferrer">google/subcommands<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>を使用しました．
こちらが<code>main.go</code></p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	subcommands<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>subcommands<span class="token punctuation">.</span><span class="token function">FlagsCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
	subcommands<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token function">new</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span>Create<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
	subcommands<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token function">new</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span>Start<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">const</span> internalOnly <span class="token operator">=</span> <span class="token string">&quot;internal only&quot;</span>
	subcommands<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token function">new</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span>Init<span class="token punctuation">)</span><span class="token punctuation">,</span> internalOnly<span class="token punctuation">)</span>
	flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">setDebugMode</span><span class="token punctuation">(</span>debug<span class="token punctuation">)</span>
	ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span>subcommands<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><code>subcommands.Command</code>インターフェースを満たした型のインスタンスを登録することでcreateなどのサブコマンドを扱えるようにします．
<code>init</code>サブコマンドは内部のみ呼び出されるべきなので<code>internal only</code>というラベルをつけています．
各種サブコマンドの実装は<code>cmd</code>以下に配置しています．</p> <h3 id="create"><a href="#create" class="header-anchor">#</a> create</h3> <p>まずは<code>create</code>をみてみましょう．
コマンドの中身は<code>Execute</code>メソッドに記述します．
主な処理は以下です．</p> <ul><li>バンドルディレクトリ(<code>config.json</code>とコンテナのルートファイルシステムを配置する)を指定して<code>config.json</code>を読み込んで<code>specs.Spec</code>構造体にマッピング</li> <li><code>init</code>サブコマンドを内部で呼び出すための<code>Factory</code>構造体のインスタンスを生成</li> <li><code>Factory.Create</code>メソッドで<code>init</code>サブコマンドを別プロセスとして実行</li></ul> <p>順に処理内容をみてみます．</p> <h4 id="config-jsonとspces-spec"><a href="#config-jsonとspces-spec" class="header-anchor">#</a> config.jsonとspces.Spec</h4> <p><code>config.json</code>は<a href="https://github.com/opencontainers/runtime-spec/blob/master/specs-go/config.go" target="_blank" rel="noopener noreferrer">opencontainer/runtime-spec/specs-go<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>の<code>specs.Spec</code>構造体にマッピングできます．
フィールドが大量にあるので今回はこれを流用しました．
そしてこれらを<code>Config</code>構造体にマッピングします．</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> Config <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Id     <span class="token builtin">string</span>
	Bundle <span class="token builtin">string</span>
	Spec   <span class="token operator">*</span>specs<span class="token punctuation">.</span>Spec
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="initプロセスを作成するfactory構造体"><a href="#initプロセスを作成するfactory構造体" class="header-anchor">#</a> initプロセスを作成するFactory構造体</h4> <p><code>Factory</code>型には<code>create</code>を実行しているプロセスから<code>init</code>プロセスを起動するための構造体です．</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>factory <span class="token operator">:=</span> <span class="token operator">&amp;</span>Factory<span class="token punctuation">{</span>
		Id<span class="token punctuation">:</span>       id<span class="token punctuation">,</span>
		Pid<span class="token punctuation">:</span>      <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
		Root<span class="token punctuation">:</span>     root<span class="token punctuation">,</span>
		InitPath<span class="token punctuation">:</span> <span class="token string">&quot;/proc/self/exe&quot;</span><span class="token punctuation">,</span>
		InitArgs<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;-debug&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;init&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// path to mycon init</span>
	<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><code>InitPath</code>には<code>/proc/self/exe</code>という文字列を渡していますが，これは現在実行中のプロセスへのパスを指すシンボリックリンクとなっています．
また<code>InitArgs</code>の<code>os.Args[0]</code>はコマンドライン引数の0番目なのでこの場合<code>./mycon</code>という実行ファイルを指していることとなります．
その後デバッグオプションをつけて<code>init</code>をサブコマンドとして指定しています．</p> <h4 id="factory-createメソッド"><a href="#factory-createメソッド" class="header-anchor">#</a> Factory.Createメソッド</h4> <p>さて，どのように<code>init</code>プロセスを起動するのでしょう．
Createでは以下のような処理をしています．</p> <ul><li>コンテナのルートディレクトリを作成</li> <li>bundleディレクトリに移動</li> <li><code>init</code>プロセスと<code>start</code>コマンドのプロセス間でシグナルをやり取りするfifoファイル作成</li> <li>実行するコマンドの作成と実行</li></ul> <p>具体的な処理は以下の様になってます．</p> <h4 id="コンテナルートディレクトリの作成"><a href="#コンテナルートディレクトリの作成" class="header-anchor">#</a> コンテナルートディレクトリの作成</h4> <p><code>/run/mycon/[container id]</code>というディレクトリを作成します．この中にコンテナ作成時に必要なファイルなどを配置します．これはコンテナに対して固有のディレクトリとなるので既に存在する場合はエラーを返します．</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>containerRootPath <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>Root<span class="token punctuation">,</span> f<span class="token punctuation">.</span>Id<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Stat</span><span class="token punctuation">(</span>containerRootPath<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;container root dir is already exist&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// make container dir</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">MkdirAll</span><span class="token punctuation">(</span>containerRootPath<span class="token punctuation">,</span> <span class="token number">0711</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="bundleディレクトリに移動"><a href="#bundleディレクトリに移動" class="header-anchor">#</a> bundleディレクトリに移動</h4> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">if</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Chdir</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Bundle<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		logrus<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">&quot;failed to chdir bundle dir: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><code>bundle</code>で指定されたディレクトリに移動します．<code>bundle</code>はデフォルトではカントディレクトリです．</p> <h4 id="fifoファイルの作成"><a href="#fifoファイルの作成" class="header-anchor">#</a> fifoファイルの作成</h4> <p><code>mkfifo</code>で名前付きパイプを作成します．
名前付きパイプについては<a href="https://kazmax.zpp.jp/cmd/f/fifo.7.html" target="_blank" rel="noopener noreferrer">こちら<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>を参照してください.
<code>init</code>プロセスと<code>start</code>プロセスで通信を行うのに使用します．</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Mkfifo</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token number">0744</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to create fifo file: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="mycon-initを実行するコマンドを作成して実行"><a href="#mycon-initを実行するコマンドを作成して実行" class="header-anchor">#</a> mycon initを実行するコマンドを作成して実行</h4> <p><code>init</code>プロセスを起動するためのコマンドを作成します．
<code>Factory</code>型インスタンスに登録されている<code>InitPath</code>, <code>InitArgs</code>を渡して<code>*exec.Cmd</code>を返します．
その際に各種名前空間を分離して，標準入力などを指定しています．</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// buildInitCommand builds a command to start init process</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>Factory<span class="token punctuation">)</span> <span class="token function">buildInitCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>exec<span class="token punctuation">.</span>Cmd <span class="token punctuation">{</span>
	cmd <span class="token operator">:=</span> exec<span class="token punctuation">.</span><span class="token function">Command</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>InitPath<span class="token punctuation">,</span> f<span class="token punctuation">.</span>InitArgs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span>
	cmd<span class="token punctuation">.</span>SysProcAttr <span class="token operator">=</span> <span class="token operator">&amp;</span>unix<span class="token punctuation">.</span>SysProcAttr<span class="token punctuation">{</span>
		Cloneflags<span class="token punctuation">:</span> unix<span class="token punctuation">.</span>CLONE_NEWIPC <span class="token operator">|</span> unix<span class="token punctuation">.</span>CLONE_NEWNET <span class="token operator">|</span> unix<span class="token punctuation">.</span>CLONE_NEWNS <span class="token operator">|</span>
			unix<span class="token punctuation">.</span>CLONE_NEWPID <span class="token operator">|</span> unix<span class="token punctuation">.</span>CLONE_NEWUSER <span class="token operator">|</span> unix<span class="token punctuation">.</span>CLONE_NEWUTS<span class="token punctuation">,</span>
		UidMappings<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>syscall<span class="token punctuation">.</span>SysProcIDMap<span class="token punctuation">{</span>
			<span class="token punctuation">{</span>ContainerID<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> HostID<span class="token punctuation">:</span> os<span class="token punctuation">.</span><span class="token function">Getuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Size<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		GidMappings<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>syscall<span class="token punctuation">.</span>SysProcIDMap<span class="token punctuation">{</span>
			<span class="token punctuation">{</span>ContainerID<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> HostID<span class="token punctuation">:</span> os<span class="token punctuation">.</span><span class="token function">Getgid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Size<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	cmd<span class="token punctuation">.</span>Stdin <span class="token operator">=</span> os<span class="token punctuation">.</span>Stdin
	cmd<span class="token punctuation">.</span>Stdout <span class="token operator">=</span> os<span class="token punctuation">.</span>Stdout
	cmd<span class="token punctuation">.</span>Stderr <span class="token operator">=</span> os<span class="token punctuation">.</span>Stderr
	logrus<span class="token punctuation">.</span><span class="token function">Debugf</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> cmd
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>また，作成した<code>cmd</code>にfifoファイルへのファイルディスクリプタを環境変数として格納します．</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>Factory<span class="token punctuation">)</span> <span class="token function">setFifoFd</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>exec<span class="token punctuation">.</span>Cmd<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	path <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>Root<span class="token punctuation">,</span> f<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> fifoName<span class="token punctuation">)</span>
	fd<span class="token punctuation">,</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> unix<span class="token punctuation">.</span>O_PATH<span class="token operator">|</span>unix<span class="token punctuation">.</span>O_CLOEXEC<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		logrus<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> unix<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span>
	cmd<span class="token punctuation">.</span>ExtraFiles <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span>ExtraFiles<span class="token punctuation">,</span> os<span class="token punctuation">.</span><span class="token function">NewFile</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">,</span> fifoName<span class="token punctuation">)</span><span class="token punctuation">)</span>
	cmd<span class="token punctuation">.</span>Env <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span>Env<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;_MYCON_FIFOFD=%v&quot;</span><span class="token punctuation">,</span> fd<span class="token operator">+</span><span class="token number">3</span><span class="token operator">+</span><span class="token function">len</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span>ExtraFiles<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> fd<span class="token punctuation">,</span> err
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>その後，実行します．
これで<code>init</code>プロセスが起動することとなります．</p> <h3 id="init"><a href="#init" class="header-anchor">#</a> init</h3> <p>さて，<code>init</code>プロセスを起動しました．
次はこちらをみてみます．
<code>init</code>サブコマンドで実行される処理の実体は<code>cmd/init.go</code>にあります．
ここでは<code>Factory.Initialize</code>メソッドで具体的処理を行います．
<code>Factory</code>型のメソッドとして<code>Initialize</code>を定義しているのはruncがそうしていたからなんですが，今回のコードではあまり<code>Factory</code>型のメソッドである必要はないですね．
<code>Initialize</code>メソッドでは先ほど保存した環境変数を取得して，<code>config.json</code>を<code>*specs.Spec</code>にマッピングして<code>Initializer</code>型のインスタンスを作成して<code>Initializer.Init</code>メソッドを呼び出すという具合です．</p> <h4 id="initializer型"><a href="#initializer型" class="header-anchor">#</a> Initializer型</h4> <p><code>Initializer</code>型は以下の様になっています．</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> Initializer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Id           <span class="token builtin">string</span>
	FifoFd       <span class="token builtin">int</span>
	Spec         <span class="token operator">*</span>specs<span class="token punctuation">.</span>Spec
	Cgroups      <span class="token operator">*</span>cgroups<span class="token punctuation">.</span>Cgroups
	Capabilities <span class="token operator">*</span>capabilities<span class="token punctuation">.</span>Capabilities
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><code>Cgroup</code>型や<code>Capabilities</code>型については後述します．</p> <h4 id="initializer-initメソッド"><a href="#initializer-initメソッド" class="header-anchor">#</a> Initializer.Initメソッド</h4> <p>このメソッドがコンテナ作成のコアとなるメソッドで問題の処理を行います．
順を追って処理をみていきます．
<code>Init</code>メソッドで行っているのは以下の様な処理です．</p> <ul><li><code>prepareRootfs</code>(root file systemの準備)
<ul><li>コンテナのroot filesystemをbindマウント</li> <li><code>config.json</code>で指定されているデバイス周りをマウント(<strong>問題が起きている箇所</strong>)</li> <li><code>cgroup</code>でハードウェアリソースを制限</li> <li><code>pivot_root</code></li></ul></li> <li>capabilityのセット</li> <li><code>start</code>サブコマンドからの合図を待ち受ける</li> <li>コンテナをスタート</li></ul> <p>という具合で処理が行われます．</p> <h4 id="rootfsのbindマウント"><a href="#rootfsのbindマウント" class="header-anchor">#</a> rootfsのbindマウント</h4> <p>バインドマウントを行うことで，コンテナのルートファイルシステムを<code>bundle/rootfs</code>にします．</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>Initializer<span class="token punctuation">)</span> <span class="token function">prepareRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token comment">// mount</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Mount</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_SLAVE<span class="token operator">|</span>unix<span class="token punctuation">.</span>MS_REC<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> unix<span class="token punctuation">.</span><span class="token function">Mount</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Root<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> i<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Root<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> <span class="token string">&quot;bind&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_BIND<span class="token operator">|</span>unix<span class="token punctuation">.</span>MS_REC<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="config-jsonで指定されているデバイスをマウントする"><a href="#config-jsonで指定されているデバイスをマウントする" class="header-anchor">#</a> config.jsonで指定されているデバイスをマウントする</h4> <p>次は<code>config.json</code>で指定されているデバイスをマウントします．ここで問題が発生しました．
デフォルトの<code>config.json</code>で指定されているデバイスは以下の様になっています．</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token property">&quot;mounts&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
		<span class="token punctuation">{</span>
			<span class="token property">&quot;destination&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/proc&quot;</span><span class="token punctuation">,</span>
			<span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;proc&quot;</span><span class="token punctuation">,</span>
			<span class="token property">&quot;source&quot;</span><span class="token operator">:</span> <span class="token string">&quot;proc&quot;</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>
			<span class="token property">&quot;destination&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/dev/shm&quot;</span><span class="token punctuation">,</span>
			<span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tmpfs&quot;</span><span class="token punctuation">,</span>
			<span class="token property">&quot;source&quot;</span><span class="token operator">:</span> <span class="token string">&quot;shm&quot;</span><span class="token punctuation">,</span>
			<span class="token property">&quot;options&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
				<span class="token comment">// ...</span>
			<span class="token punctuation">]</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>
			<span class="token property">&quot;destination&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/dev/mqueue&quot;</span><span class="token punctuation">,</span>
			<span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mqueue&quot;</span><span class="token punctuation">,</span>
			<span class="token property">&quot;source&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mqueue&quot;</span><span class="token punctuation">,</span>
			<span class="token property">&quot;options&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
				<span class="token comment">// ...</span>
			<span class="token punctuation">]</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>
			<span class="token property">&quot;destination&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/dev/pts&quot;</span><span class="token punctuation">,</span>
			<span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;devpts&quot;</span><span class="token punctuation">,</span>
			<span class="token property">&quot;source&quot;</span><span class="token operator">:</span> <span class="token string">&quot;devpts&quot;</span><span class="token punctuation">,</span>
			<span class="token property">&quot;options&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
				<span class="token comment">// ...</span>
			<span class="token punctuation">]</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>
			<span class="token property">&quot;destination&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/dev&quot;</span><span class="token punctuation">,</span>
			<span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tmpfs&quot;</span><span class="token punctuation">,</span>
			<span class="token property">&quot;source&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tmpfs&quot;</span><span class="token punctuation">,</span>
			<span class="token property">&quot;options&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
				<span class="token comment">// ...</span>
			<span class="token punctuation">]</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>
			<span class="token property">&quot;destination&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/sys&quot;</span><span class="token punctuation">,</span>
			<span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sysfs&quot;</span><span class="token punctuation">,</span>
			<span class="token property">&quot;source&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sysfs&quot;</span><span class="token punctuation">,</span>
			<span class="token property">&quot;options&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
				<span class="token comment">// ...</span>
			<span class="token punctuation">]</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>
			<span class="token property">&quot;destination&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/sys/fs/cgroup&quot;</span><span class="token punctuation">,</span>
			<span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cgroup&quot;</span><span class="token punctuation">,</span>
			<span class="token property">&quot;source&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cgroup&quot;</span><span class="token punctuation">,</span>
			<span class="token property">&quot;options&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
				<span class="token comment">// ...</span>
			<span class="token punctuation">]</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">]</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><p>マウントするデバイスのスライスを<code>*specs.Spec.Mounts</code>から取り出して<code>unix.Mount</code>メソッドで逐一マウントしていく感じです．
コードがこちら．(デバッグ出力などの不要なものを削っています．)
後述しますが，この部分で問題が発生しています．</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Mount</span><span class="token punctuation">(</span>root <span class="token operator">*</span>specs<span class="token punctuation">.</span>Root<span class="token punctuation">,</span> mounts <span class="token punctuation">[</span><span class="token punctuation">]</span>specs<span class="token punctuation">.</span>Mount<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	wd<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Getwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	rootfsPath <span class="token operator">:=</span> root<span class="token punctuation">.</span>Path
	<span class="token keyword">if</span> <span class="token operator">!</span>filepath<span class="token punctuation">.</span><span class="token function">IsAbs</span><span class="token punctuation">(</span>rootfsPath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		rootfsPath <span class="token operator">=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>wd<span class="token punctuation">,</span> rootfsPath<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> m <span class="token operator">:=</span> <span class="token keyword">range</span> mounts <span class="token punctuation">{</span>
		target <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>rootfsPath<span class="token punctuation">,</span> m<span class="token punctuation">.</span>Destination<span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Stat</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">MkdirAll</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> err
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		flags<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token function">parseMountOptions</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Options<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Mount</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Source<span class="token punctuation">,</span> target<span class="token punctuation">,</span> m<span class="token punctuation">.</span>Type<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			logrus<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>この様にしてスライスから取り出した各要素に対してマウントを繰り返す様にしています．基本的にruncのコードもその様になっていました．</p> <h4 id="cgroup"><a href="#cgroup" class="header-anchor">#</a> cgroup</h4> <p><code>cgroup</code>に関しても，<code>config.json</code>で指定された値をセットするという感じです．
一例がこちら．</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>cg <span class="token operator">*</span>Cgroups<span class="token punctuation">)</span> <span class="token function">limitCpu</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> cg<span class="token punctuation">.</span>Resources <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> cg<span class="token punctuation">.</span>Resources<span class="token punctuation">.</span>CPU <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		logrus<span class="token punctuation">.</span><span class="token function">Debugf</span><span class="token punctuation">(</span><span class="token string">&quot;cpu limitation is not set&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	dir <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>cg<span class="token punctuation">.</span>Root<span class="token punctuation">,</span> <span class="token string">&quot;cpu&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mycon&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">MkdirAll</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> cg<span class="token punctuation">.</span>Resources<span class="token punctuation">.</span>CPU<span class="token punctuation">.</span>Shares <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">writeFile</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> cpuShares<span class="token punctuation">,</span> strconv<span class="token punctuation">.</span><span class="token function">FormatUint</span><span class="token punctuation">(</span><span class="token operator">*</span>cg<span class="token punctuation">.</span>Resources<span class="token punctuation">.</span>CPU<span class="token punctuation">.</span>Shares<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>この場合だと，<code>/sys/fs/cgroup/cpu/mycon/cpu.shares</code>に値を書き込むことでセットしています．</p> <h4 id="pivot-root"><a href="#pivot-root" class="header-anchor">#</a> pivot_root</h4> <p>最後に<code>pivot_root</code>を行って，コンテナプロセスのルートファイルシステムを隔離します．
<code>chroot</code>と<code>pivot_root</code>の違いに関しては<a href="https://employment.en-japan.com/engineerhub/entry/2019/02/05/103000#chroot%E3%81%A8pivot_root" target="_blank" rel="noopener noreferrer">こちら<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>を参照してください．
pivot_rootを実際に行うコードがこちら．</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>Initializer<span class="token punctuation">)</span> <span class="token function">pivotRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	oldroot<span class="token punctuation">,</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>O_DIRECTORY<span class="token operator">|</span>unix<span class="token punctuation">.</span>O_RDONLY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		logrus<span class="token punctuation">.</span><span class="token function">Debugf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to open old root&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> unix<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span>oldroot<span class="token punctuation">)</span>
	newroot<span class="token punctuation">,</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Root<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> unix<span class="token punctuation">.</span>O_DIRECTORY<span class="token operator">|</span>unix<span class="token punctuation">.</span>O_RDONLY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		logrus<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">&quot;failed to open new root: &quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Root<span class="token punctuation">.</span>Path<span class="token punctuation">)</span>
		cd<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Getwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		logrus<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">&quot;now in &quot;</span><span class="token punctuation">,</span> cd<span class="token punctuation">)</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> unix<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span>newroot<span class="token punctuation">)</span>
	<span class="token comment">// fetch new root file system</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Fchdir</span><span class="token punctuation">(</span>newroot<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		logrus<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">&quot;failed to fetch new root&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">PivotRoot</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		logrus<span class="token punctuation">.</span><span class="token function">Debugf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to pivot_root: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Fchdir</span><span class="token punctuation">(</span>oldroot<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		logrus<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">&quot;failed to fetch old root&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Mount</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;.&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MS_SLAVE<span class="token operator">|</span>unix<span class="token punctuation">.</span>MS_REC<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		logrus<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">&quot;failed to mount .&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Unmount</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">,</span> unix<span class="token punctuation">.</span>MNT_DETACH<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		logrus<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">&quot;failed to unmount .&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> unix<span class="token punctuation">.</span><span class="token function">Chdir</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		logrus<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">&quot;failed to chdir /&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;failed to chdir: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>まず，<code>oldroot</code>に現在のファイルシステムのrootを開いたfdを保存，また，<code>newroot</code>に新しいファイルシステムのルートとなるポイントを開いたfdを保存します．
その後，newrootに移動して<code>pivot_root</code>を行います．</p> <p>pivot_rootが行えるにはいくつか条件があります．<a href="https://tenforward.hatenablog.com/entry/2017/06/28/021019" target="_blank" rel="noopener noreferrer">こちら<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>を参照してください．
pivot_rootに関してはまだ僕も理解が浅いのでLinuxのファイルシステムなどについてもっと勉強する必要がありそうです．</p> <h4 id="capability"><a href="#capability" class="header-anchor">#</a> capability</h4> <p>capabilitiesのセットには<a href="https://github.com/syndtr/gocapability/tree/master/capability" target="_blank" rel="noopener noreferrer">syndtr/gocapability/capability<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>を使用しています．
<code>config.json</code>に設定されたcapabilitiesを次の構造体にマッピングしています．</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> Capabilities <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	CapMap      <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>capability<span class="token punctuation">.</span>Cap
	Pid         capability<span class="token punctuation">.</span>Capabilities
	Bounding    <span class="token punctuation">[</span><span class="token punctuation">]</span>capability<span class="token punctuation">.</span>Cap
	Inheritable <span class="token punctuation">[</span><span class="token punctuation">]</span>capability<span class="token punctuation">.</span>Cap
	Effective   <span class="token punctuation">[</span><span class="token punctuation">]</span>capability<span class="token punctuation">.</span>Cap
	Permitted   <span class="token punctuation">[</span><span class="token punctuation">]</span>capability<span class="token punctuation">.</span>Cap
	Ambient     <span class="token punctuation">[</span><span class="token punctuation">]</span>capability<span class="token punctuation">.</span>Cap
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="startを待ち受ける"><a href="#startを待ち受ける" class="header-anchor">#</a> startを待ち受ける</h4> <p>リソースの分離などが完了したあと，スタートするためにシグナルを待ち受けます．</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token operator">&lt;-</span> i<span class="token punctuation">.</span><span class="token function">waitToStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		logrus<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">&quot;failed to wait to start: &quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><code>waitToStart</code>では<code>/proc/self/fd/%d</code>で環境変数に渡されたファイルディスクリプタの値でファイルを開きます．</p> <p>スタートの合図があった場合，セットされていたコマンドを実行します．</p> <h3 id="実装まとめ"><a href="#実装まとめ" class="header-anchor">#</a> 実装まとめ</h3> <p>以上がこれまで僕が実装した部分になります．とりあえずプロセス起動，cgroup, capabiltiesと段階を踏んで実装してきました．ここら辺はコミットを辿ってみてください．
また，上述したマウントできない問題によりプロセス間でシグナルを送受信することができず，createコマンドを実行すると<code>waitToStart</code>でエラーを吐くため<code>waitToStart</code>の部分をコメントアウトしてそのままプロセスを起動している状態です．
また，プロセスを起動しても<code>/dev/pts</code>がマウントできていないせいか，入力を受け付けてくれず，すぐにプロセスからログアウトするという状況になってます．</p> <h2 id="まとめ"><a href="#まとめ" class="header-anchor">#</a> まとめ</h2> <p>今回は自作コンテナに挑戦しましたが，エラーを解決できず，いったん断念してLinuxやその他の知識をもっとつけてから続きをしようかなと思っています．
なかなかうまくいきませんね．</p> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <ul><li><a href="https://github.com/rrreeeyyy/container-internship" target="_blank" rel="noopener noreferrer">https://github.com/rrreeeyyy/container-internship<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://kazmax.zpp.jp/cmd/d/dup.2.html" target="_blank" rel="noopener noreferrer">dup man<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://tech.retrieva.jp/entry/2019/06/04/130134" target="_blank" rel="noopener noreferrer">コンテナ仮想、その裏側 〜user namespaceとrootlessコンテナ〜<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://gihyo.jp/admin/serial/01/linux_containers/0003" target="_blank" rel="noopener noreferrer">LXCで学ぶコンテナ入門 －軽量仮想化環境を実現する技術<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://medium.com/nttlabs/runc-overview-263b83164c98" target="_blank" rel="noopener noreferrer">コンテナユーザなら誰もが使っているランタイム「runc」を俯瞰する[Container Runtime Meetup #1発表レポート]<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://drumato.hatenablog.com/entry/2019/03/31/070000" target="_blank" rel="noopener noreferrer">runcのcreateコマンドを読む｡<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://employment.en-japan.com/engineerhub/entry/2019/02/05/103000#chroot%E3%81%A8pivot_root" target="_blank" rel="noopener noreferrer">コンテナ技術入門 - 仮想化との違いを知り、要素技術を触って学ぼう<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/opencontainers/runc" target="_blank" rel="noopener noreferrer">runc<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://speakerdeck.com/tomocy/write-container-runtime-in-go" target="_blank" rel="noopener noreferrer">Write Container Runtime in Go<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h3 id="oci-runtime-specification"><a href="#oci-runtime-specification" class="header-anchor">#</a> OCI runtime specification</h3> <ul><li><a href="https://udzura.hatenablog.jp/entry/2016/08/02/155913" target="_blank" rel="noopener noreferrer">https://udzura.hatenablog.jp/entry/2016/08/02/155913<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/opencontainers/runtime-spec" target="_blank" rel="noopener noreferrer">https://github.com/opencontainers/runtime-spec<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <div id="disqus_thread"></div></div></article> <section class="post-meta main-div" data-v-4e23451f><section class="post-date clearfix" data-v-4e23451f><span class="create-date" data-v-4e23451f>
      Created : 2020-05-08
    </span> <span class="update-date" data-v-4e23451f>
      Updated : 2020-05-10
    </span></section> <section class="post-links" data-v-4e23451f><a href="/posts/2020/04/29/runc.html" class="post-link" data-v-4e23451f>
      Previous Post : runcを使ってみる
    </a> <a href="/posts/2020/05/24/ctf4b.html" class="post-link" data-v-4e23451f>
      Next Post : SECCON Beginners CTF 2020解けた問題 writeup
    </a></section></section> <div id="post-comments" class="main-div"><!----></div></div></main> <aside class="aside" data-v-4dd605a1><div class="info-card main-div" data-v-9d847660 data-v-4dd605a1><div class="info-card-header" style="background-size:cover;background-repeat:no-repeat;background-position:center;background-attachment:scroll;background-image:url(/img/bg.jpg);" data-v-9d847660><img src="/img/avatar.jpg" alt="terassyi" class="info-avatar" data-v-9d847660></div> <div class="info-card-body" data-v-9d847660><section class="info-nickname" data-v-9d847660>
      terassyi
    </section> <section class="info-desc" data-v-9d847660>Fortune favors the brave</section> <section class="info-contact" data-v-9d847660><section data-v-9d847660><span title="Fukuoka City, Japan" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>Fukuoka City, Japan</title><use xlink:href="#icon-location" data-v-9d847660 data-v-9d847660></use></svg><span class="info-text" data-v-9d847660 data-v-9d847660>
          Fukuoka City, Japan
        </span></span></section> <section data-v-9d847660><span title="Kyushu University" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>Kyushu University</title><use xlink:href="#icon-organization" data-v-9d847660 data-v-9d847660></use></svg><span class="info-text" data-v-9d847660 data-v-9d847660>
          Kyushu University
        </span></span></section> <section data-v-9d847660><a href="mailto:iscale821@gmail.com" title="iscale821@gmail.com" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>iscale821@gmail.com</title><use xlink:href="#icon-email" data-v-9d847660 data-v-9d847660></use></svg><span class="info-text" data-v-9d847660 data-v-9d847660>
          iscale821@gmail.com
        </span></a></section></section></div> <div class="info-card-footer" data-v-9d847660><section class="info-sns clearfix" data-v-9d847660><a href="https://github.com/terassyi" target="_blank" class="sns-link" data-v-9d847660><span title="GitHub: terassyi" class="sns-icon" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1.5em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>GitHub: terassyi</title><use xlink:href="#icon-github" data-v-9d847660 data-v-9d847660></use></svg></span></a><a href="https://twitter.com/terassyi_" target="_blank" class="sns-link" data-v-9d847660><span title="Twitter: terassyi" class="sns-icon" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1.5em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>Twitter: terassyi</title><use xlink:href="#icon-twitter" data-v-9d847660 data-v-9d847660></use></svg></span></a></section></div></div> <div class="post-nav-card main-div" style="position:relative;top:0;width:0px;" data-v-4dd605a1><div class="post-nav-contents"><svg class="icon"><title>book</title><use xlink:href="#icon-book"></use></svg> <span>Table of Contents</span> <div class="post-nav-toc"><ul><li><a href="/posts/2020/05/08/container.html#タイトルについて">タイトルについて</a></li><li><a href="/posts/2020/05/08/container.html#問題">問題</a><ul><li><a href="/posts/2020/05/08/container.html#問題の実験環境">問題の実験環境</a></li></ul></li><li><a href="/posts/2020/05/08/container.html#自作コンテナの動機">自作コンテナの動機</a></li><li><a href="/posts/2020/05/08/container.html#実験環境">実験環境</a></li><li><a href="/posts/2020/05/08/container.html#runcについて">runcについて</a><ul><li><a href="/posts/2020/05/08/container.html#runcがどのようにコンテナプロセスを起動するか">runcがどのようにコンテナプロセスを起動するか</a></li><li><a href="/posts/2020/05/08/container.html#リソースの分離について">リソースの分離について</a></li></ul></li><li><a href="/posts/2020/05/08/container.html#config-json">config.json</a></li><li><a href="/posts/2020/05/08/container.html#開発">開発</a><ul><li><a href="/posts/2020/05/08/container.html#create">create</a></li><li><a href="/posts/2020/05/08/container.html#init">init</a></li><li><a href="/posts/2020/05/08/container.html#実装まとめ">実装まとめ</a></li></ul></li><li><a href="/posts/2020/05/08/container.html#まとめ">まとめ</a></li><li><a href="/posts/2020/05/08/container.html#参考">参考</a><ul><li><a href="/posts/2020/05/08/container.html#oci-runtime-specification">OCI runtime specification</a></li></ul></li></ul></div></div> <div class="post-nav-comments"><svg class="icon"><title>comment</title><use xlink:href="#icon-comment"></use></svg> <a href="/posts/2020/05/08/container.html#post-comments">
      Comments
    </a></div></div></aside></div> <footer class="footer" data-v-1375e54c><p class="footer-sns-links" data-v-1375e54c><a href="https://github.com/terassyi" target="_blank" class="sns-link" data-v-1375e54c><span title="GitHub: terassyi" class="sns-icon" data-v-1375e54c data-v-1375e54c><svg class="icon" style="font-size:25px;" data-v-1375e54c data-v-1375e54c><title data-v-1375e54c data-v-1375e54c>GitHub: terassyi</title><use xlink:href="#icon-github" data-v-1375e54c data-v-1375e54c></use></svg></span></a><a href="https://twitter.com/terassyi_" target="_blank" class="sns-link" data-v-1375e54c><span title="Twitter: terassyi" class="sns-icon" data-v-1375e54c data-v-1375e54c><svg class="icon" style="font-size:25px;" data-v-1375e54c data-v-1375e54c><title data-v-1375e54c data-v-1375e54c>Twitter: terassyi</title><use xlink:href="#icon-twitter" data-v-1375e54c data-v-1375e54c></use></svg></span></a></p> <p class="footer-text" data-v-1375e54c><span data-v-1375e54c>Powered by </span> <a href="https://github.com/vuejs/vuepress" target="_blank" data-v-1375e54c>
      VuePress
    </a> <span data-v-1375e54c> | </span> <a href="https://github.com/meteorlxy/vuepress-theme-meteorlxy" target="_blank" data-v-1375e54c>
        meteorlxy
      </a></p> <p class="footer-text" data-v-1375e54c>Copyright 2018-present <a href="https://github.com/meteorlxy" target="_blank">meteorlxy</a> | MIT License</p></footer></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.7e3d47b8.js" defer></script><script src="/assets/js/10.b0186384.js" defer></script><script src="/assets/js/4.82cf18b4.js" defer></script><script src="/assets/js/17.1ed29426.js" defer></script>
  </body>
</html>
