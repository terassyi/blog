(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{242:function(t,s,a){"use strict";var n=0;function e(t){if(!n){var s=document.createElement("script");s.setAttribute("src",t),document.body.appendChild(s),n=new Promise((function(t){s.onload=function(){t(window.twttr)}}))}return n}var r={id:{type:String,required:!0},sourceType:{type:String},slug:{type:String},options:Object};t.exports={addPlatformScript:e,twitterEmbedComponent:function(t){return{data:function(){return{isLoaded:!1,isAvailable:!1}},props:Object.assign({},r,t.props),mounted:function(){var s,a=this;s="profile"===this.sourceType?{sourceType:this.sourceType,screenName:this.id}:"list"===this.sourceType?{sourceType:this.sourceType,ownerScreenName:this.id,slug:this.slug}:this.id,Promise.resolve(window.twttr?window.twttr:e("//platform.twitter.com/widgets.js")).then((function(n){return t.embedComponent(n,s,a.$el,a.options)})).then((function(t){a.isAvailable=void 0!==t,a.isLoaded=!0}))},render:function(t){if(this.isLoaded&&this.isAvailable)return t("div",{class:this.$props.widgetClass});if(this.isLoaded&&!this.isAvailable&&this.$props.errorMessage){var s=t("div",{class:this.$props.errorMessageClass,domProps:{innerHTML:this.$props.errorMessage}});return t("div",[s])}return t("div",{class:this.$props.widgetClass},this.$slots.default)}}}}},247:function(t,s,a){"use strict";Object.defineProperty(s,"__esModule",{value:!0}),Object.defineProperty(s,"Tweet",{enumerable:!0,get:function(){return n.default}}),Object.defineProperty(s,"Moment",{enumerable:!0,get:function(){return e.default}}),Object.defineProperty(s,"Timeline",{enumerable:!0,get:function(){return r.default}});var n=p(a(248)),e=p(a(249)),r=p(a(250));function p(t){return t&&t.__esModule?t:{default:t}}},248:function(t,s,a){"use strict";Object.defineProperty(s,"__esModule",{value:!0}),s.default=void 0;var n=(0,a(242).twitterEmbedComponent)({embedComponent:function(t){for(var s,a=arguments.length,n=new Array(a>1?a-1:0),e=1;e<a;e++)n[e-1]=arguments[e];return(s=t.widgets).createTweetEmbed.apply(s,n)},props:{errorMessage:{type:String,default:"Whoops! We couldn't access this Tweet."},errorMessageClass:{type:String,required:!1},widgetClass:{type:String,required:!1}}});s.default=n},249:function(t,s,a){"use strict";Object.defineProperty(s,"__esModule",{value:!0}),s.default=void 0;var n=(0,a(242).twitterEmbedComponent)({embedComponent:function(t){for(var s,a=arguments.length,n=new Array(a>1?a-1:0),e=1;e<a;e++)n[e-1]=arguments[e];return(s=t.widgets).createMoment.apply(s,n)},props:{errorMessage:{type:String,default:"Whoops! We couldn't access this Moment."},errorMessageClass:{type:String,required:!1},widgetClass:{type:String,required:!1}}});s.default=n},250:function(t,s,a){"use strict";Object.defineProperty(s,"__esModule",{value:!0}),s.default=void 0;var n=(0,a(242).twitterEmbedComponent)({embedComponent:function(t){for(var s,a=arguments.length,n=new Array(a>1?a-1:0),e=1;e<a;e++)n[e-1]=arguments[e];return(s=t.widgets).createTimeline.apply(s,n)},props:{errorMessage:{type:String,default:"Whoops! We couldn't access this Timeline."},errorMessageClass:{type:String,required:!1},widgetClass:{type:String,required:!1}}});s.default=n},285:function(t,s,a){"use strict";a.r(s);var n={components:{Tweet:a(247).Tweet}},e=a(1),r=Object(e.a)(n,(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("p",[t._v("こんにちは．趣味の将棋がなかなか強くならなくて困ってます．勉強せずにすぐ対局してしまうのがダメなのはわかってますがつい対局してしまいます．\n今回はKLab Expert Campに参加してTCP/IPプロトコルスタック自作に挑戦しました．")]),t._v(" "),a("h2",{attrs:{id:"経緯"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#経緯"}},[t._v("#")]),t._v(" 経緯")]),t._v(" "),a("p",[t._v("最初にこのイベントについて知ったのは昨年の"),a("a",{attrs:{href:"https://www.klab.com/jp/blog/pr/2019/51714636.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("第一回TCP/IPプロトコルスタック自作キャンプ"),a("OutboundLink")],1),t._v("に参加されていた参加者の方のツイートとブログでした．ちょうど僕もTCP/IPの自作を行う機運が高まっていたので次回があれば絶対参加するぞと思っていました．")]),t._v(" "),a("Tweet",{attrs:{id:"1227190490690310145"}}),t._v(" "),a("h2",{attrs:{id:"klab-expert-camp-tcp-ipプロトコルスタック自作開発"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#klab-expert-camp-tcp-ipプロトコルスタック自作開発"}},[t._v("#")]),t._v(" KLab Expert Camp(TCP/IPプロトコルスタック自作開発)")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/pandax381/microps",target:"_blank",rel:"noopener noreferrer"}},[t._v("microps"),a("OutboundLink")],1),t._v("や"),a("a",{attrs:{href:"https://github.com/pandax381/lectcp",target:"_blank",rel:"noopener noreferrer"}},[t._v("lectcp"),a("OutboundLink")],1),t._v("を開発されている"),a("a",{attrs:{href:"https://twitter.com/pandax381",target:"_blank",rel:"noopener noreferrer"}},[t._v("pandax381"),a("OutboundLink")],1),t._v("さんに直接解説やアドバイスをいただきながらTCP/IPを実装していくというものです．")]),t._v(" "),a("p",[t._v("基本コースと発展コースが用意されており基本コースは講義形式でmicropsを参考に実装を行い，発展コースは自身の持ち込んだテーマでTCP/IPに関する開発を行います．\n僕はGo言語で自作TCP/IPをすでに開発中でTCPも少し動いていたので自作のプロトコルスタックにwindow制御などの機能追加をしたいと思っていました．")]),t._v(" "),a("p",[t._v("僕の自作TCP/IPのリポジトリはこちら")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/terassyi/gotcp",target:"_blank",rel:"noopener noreferrer"}},[a("img",{attrs:{src:"https://gh-card.dev/repos/terassyi/gotcp.svg",alt:"terassyi/gotcp - GitHub"}}),a("OutboundLink")],1)]),t._v(" "),a("h2",{attrs:{id:"やったこと"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#やったこと"}},[t._v("#")]),t._v(" やったこと")]),t._v(" "),a("p",[t._v("やったことの概要は成果発表の資料にまとめてます．")]),t._v(" "),a("iframe",{attrs:{src:"https://docs.google.com/presentation/d/e/2PACX-1vRZYaCiABE150hJnZpE3zaaKzzlg1qSQ77zFKg-ht0zcKOCCJcFlR9PuaBRh4g9dGrvyTbwyklpeWeb/embed?start=false&loop=false&delayms=3000",frameborder:"0",width:"480",height:"299",allowfullscreen:"true",mozallowfullscreen:"true",webkitallowfullscreen:"true"}}),t._v(" "),a("p",[t._v("成果発表スライドをチラッとみていただければ分かりますが期間中進捗はほぼほぼなしで永遠にデバッグしてました．とはいえ自分一人では気づかなかったバグや仕様の落とし穴などを指摘していただけたので貴重な経験でした．結果としてデバッグも進んだのでよかったです．")]),t._v(" "),a("p",[t._v("スライドで上げているバグとそれに対してやったことについて軽く紹介します．")]),t._v(" "),a("h3",{attrs:{id:"rfc793に書かれている仕様が現実の実装と異なる場合がある"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#rfc793に書かれている仕様が現実の実装と異なる場合がある"}},[t._v("#")]),t._v(" RFC793に書かれている仕様が現実の実装と異なる場合がある")]),t._v(" "),a("p",[t._v("これは"),a("code",[t._v("PSHフラグ")]),t._v("問題です．TCPは到着したセグメントを格納しておくバッファを持っています．\nそしてRFC793の仕様には以下のような記述があります．")]),t._v(" "),a("blockquote",[a("p",[t._v("There is a coupling between the push function and the use of buffers\nof data that cross the TCP/user interface.  Each time a PUSH flag is\nassociated with data placed into the receiving user’s buffer, the\nbuffer is returned to the user for processing even if the buffer is\nnot filled.  If data arrives that fills the user’s buffer before a\nPUSH is seen, the data is passed to the user in buffer size units.")])]),t._v(" "),a("p",[t._v("つまり，TCPはPSHフラグが検出される，もしくはバッファがいっぱいになったらアプリケーションにデータを投げるということになっています．\nということで僕が当初書いていたコードがこちら．")]),t._v(" "),a("p",[t._v("セグメントの処理部．")]),t._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" packet"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Packet"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Header"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("OffsetControlFlag"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ControlFlag")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Psh")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//c.readyQueue <- packet.Packet.Data")]),t._v("\n\tc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rcvBuffer "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("append")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rcvBuffer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" packet"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Packet"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Data"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("readyQueue "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<-")]),t._v(" c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rcvBuffer\n\t\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rcvBuffer "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("append")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rcvBuffer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" packet"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Packet"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Data"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("len")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rcvBuffer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cap")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rcvBuffer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("readyQueue "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<-")]),t._v(" c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rcvBuffer\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br")])]),a("p",[t._v("Read処理部")]),t._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("c "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("Conn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("read")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("b "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tbuf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ok "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<-")]),t._v("c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("readyQueue\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("ok "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" fmt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Errorf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"failed to read"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br")])]),a("p",[t._v("しかし現在のSocket APIは能動的にデータを上位層に渡す手段は持っていません．実際の実装ではシステムコールを使用してreadするのでアプリケーション側が任意のタイミングでデータを読み出します．つまり，PSHフラグは現在意味をなさず，TCPは到着したデータを単にバッファに詰め込んでアプリケーションからの読み出しを待ちます．")]),t._v(" "),a("p",[t._v("というわけで実装を変更しました．")]),t._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Do not check PSH flag.")]),t._v("\nl "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("len")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("packet"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Packet"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("len")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rcvBuffer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("buf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("l "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cap")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rcvBuffer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("buf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rcvBuffer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("init")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tcb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rcv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("WND "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" window\n\tc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rcvBuffer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("buf "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("append")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rcvBuffer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("buf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" packet"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Packet"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Data"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tcb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rcv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("NXT "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tcb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rcv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("NXT "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uint32")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("l"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tcb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rcv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("WND "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tcb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rcv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("WND "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uint32")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("l"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br")])]),a("p",[t._v("セグメント処理部では単に到着したデータをバッファに詰め込みます．")]),t._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("c "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("Conn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("read")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("b "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("_")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ok "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<-")]),t._v("c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rcvBuffer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("readable"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("ok "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" fmt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Errorf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"failed to recv"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\tl "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("copy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rcvBuffer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("buf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rcvBuffer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("init")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tcb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rcv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("WND "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" window\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" l"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br")])]),a("p",[t._v("Read処理部ではバッファがreadableならバッファをコピーします．")]),t._v(" "),a("p",[t._v("RFC793は昔に策定された仕様なので実際の実装とは異なる場合があるようです．歴史を感じます．")]),t._v(" "),a("h3",{attrs:{id:"パケットがどこかへ消えてしまう-未解決問題"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#パケットがどこかへ消えてしまう-未解決問題"}},[t._v("#")]),t._v(" パケットがどこかへ消えてしまう(未解決問題)")]),t._v(" "),a("p",[t._v("ある程度大きなデータを送受信しようとすると途中でパケットが欠損してしまい応答ができなくなるという問題がありました．\nEthernetからTCPまで結構複雑にgoroutineとchannelを使用してデータを送受信しています．\n非同期処理の中でデータが落ちてるのかなと思いデバッグしてましたが期間中に修正することはできず時間切れでした．")]),t._v(" "),a("p",[t._v("当時の僕\n"),a("Tweet",{attrs:{id:"1368878451071930376"}})],1),t._v(" "),a("h4",{attrs:{id:"解決"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解決"}},[t._v("#")]),t._v(" 解決")]),t._v(" "),a("Tweet",{attrs:{id:"1369499414121750533"}}),t._v(" "),a("p",[t._v("期間中は間に合いませんでしたが原因はgoroutineとchannelのスイッチングの問題でうまく処理ができていないことのようでした．原因は詳しく調査できていませんが以下のようにchannel受信処理の前にsleepを挟むとうまく動作しました．")]),t._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\ttime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Sleep")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("time"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Millisecond "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tbuf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ok "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<-")]),t._v("rcvQueue\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br")])]),a("h2",{attrs:{id:"まとめ"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#まとめ"}},[t._v("#")]),t._v(" まとめ")]),t._v(" "),a("p",[t._v("期間中はpandax381さんをはじめKLabの方々に様々なサポートをしていただきました．ありがとうございました．いただいたお菓子も非常に美味しかったです．結果としてほぼほぼ全期間デバッグで終わってしまいましたが一人では気づけない箇所に気づくことができたので非常に有意義でした．")]),t._v(" "),a("p",[t._v("詳しいTCP/IPの実装などはまた別に記事にできればなと思います．\n貴重な機会をいただきましてありがとうございました．")]),t._v(" "),a("Tweet",{attrs:{id:"1366268368106385408"}}),t._v(" "),a("disqus")],1)}),[],!1,null,null,null);s.default=r.exports}}]);