(window.webpackJsonp=window.webpackJsonp||[]).push([[19],{293:function(s,t,n){"use strict";n.r(t);var a=n(1),e=Object(a.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("p",[s._v("こんにちは．緊急事態宣言が出ているため相変わらず外出ができません．早く収束して欲しいものです．\n今回はdocker関連の話題についてです．Googleが開発したgVisorというコンテナランタイムについて調べてみました．")]),s._v(" "),n("h1",{attrs:{id:"gvisor"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#gvisor"}},[s._v("#")]),s._v(" gVisor")]),s._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"https://gvisor.dev/",target:"_blank",rel:"noopener noreferrer"}},[s._v("gvisor.dev"),n("OutboundLink")],1)]),s._v(" "),n("li",[n("a",{attrs:{href:"https://github.com/google/gvisor",target:"_blank",rel:"noopener noreferrer"}},[s._v("github.com/google/gvisor"),n("OutboundLink")],1)])]),s._v(" "),n("h2",{attrs:{id:"documentを意訳"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#documentを意訳"}},[s._v("#")]),s._v(" Documentを意訳")]),s._v(" "),n("p",[s._v("gVisorとはGo言語で実装されたユーザー空間カーネルです．ほとんどのLinuxシステムコールインターフェースを実装しており，ホストOSと起動しているアプリケーションとの間に隔離層を設けることで安全性を実現しています．\ngVisorには"),n("code",[s._v("runsc")]),s._v("というOCI仕様に準拠したコンテナランタイムを含んでいます．"),n("code",[s._v("runsc")]),s._v("はDockerやKubernetesで使用でき，簡単にサンドボックス化されたコンテナを実行できます．\ngVisorは既存のサンドボックス化ツールと異なるアプローチを用いています．")]),s._v(" "),n("h2",{attrs:{id:"architecture-guide"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#architecture-guide"}},[s._v("#")]),s._v(" Architecture Guide")]),s._v(" "),n("p",[s._v("gVisorは信用されていないコンテナをサンドボックス化する仮想環境を作成します．ホストのカーネルによるシステムインターフェースは攻撃のリスクを少なくするために実装されたユーザー空間カーネルによってラップされます．gVisorは大きなオーバーヘッドはありませんが，リソースの利用に関してプロセスモデルを使用します．")]),s._v(" "),n("h3",{attrs:{id:"how-is-this-different"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#how-is-this-different"}},[s._v("#")]),s._v(" How is this different?")]),s._v(" "),n("p",[s._v("通常はコンテナを分離する手法としてgVisorとは異なる二つの手法が用いられます．")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("Machine-level virtualization\nKVMやXenのようなマシンレベルの仮想化はVirtual Machine Monitor(VMM)を経由したゲストカーネルに対して仮想化されたハードウェアをさらしてしまいます．仮想化されたハードウェアは通常軽量化され，追加のメカニズムがゲストとホストの可視性を高めるために使用されます．仮想マシン上で実行されるコンテナは高い分離性や互換性，パフォーマンスを得ることができますが，コンテナにとって追加のプロキシやエージェントを要求されるため，より大きなリソースや起動時間を必要としてしまいます．\n"),n("img",{attrs:{src:"/img/arch1.png",alt:"arch1"}})])]),s._v(" "),n("li",[n("p",[s._v("Rule-based execution\nseccompやSELinux, AppArmorのようなルールベースの実行はアプリケーションやコンテナにとって安全な特定のシステムコールのみを実行できます．これらは大抵の場合ルールを強化するためにホストカーネルの内部でフックされます．もしも十分に小さくカーネルの表面が作られているとしたら，この手法はアプリケーションをサンドボックス化し，元のパフォーマンスを維持する良い方法です．しかし，そのポリシーやルールを未知のアプリケーションやコンテナに対して定義するのは難しい場合が多いです．\n"),n("img",{attrs:{src:"/img/arch2.png",alt:"arch2"}}),s._v("\n通常，ルールベース実行は多層防御のため追加層を設けます．")])])]),s._v(" "),n("p",[s._v("gVisorはそれらの分離手法と異なり，第三の分離手法をとっています．")]),s._v(" "),n("p",[s._v("gVisorはアプリケーションシステムコールをゲストカーネルとして仮想化ハードウェアを必要とせずに介入します．gVisorはVMMやseccompといったものと同一のように見えます．しかし，このアーキテクチャはより柔軟なリソース管理を行うことができます．一方でこれは互換性の低下やより高いオーバーヘッドをもたらします．")]),s._v(" "),n("p",[n("img",{attrs:{src:"/img/arch3.png",alt:"arch3"}}),s._v("\ngVisorは多層防御のためにルールベース実行を用います．\ngVisorの手法は"),n("a",{attrs:{href:"http://user-mode-linux.sourceforge.net/",target:"_blank",rel:"noopener noreferrer"}},[s._v("User Mode Linux(UML)"),n("OutboundLink")],1),s._v("と似ています．しかし，UMLは内部でハードウェアを仮想化しています．\nそれぞれの手法は特定の環境では優れています．例えば，マシンレベル仮想化は高い密度を実現するのが困難で，gVisorはシステムコールのパフォーマンスが低いです．")]),s._v(" "),n("h3",{attrs:{id:"why-go"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#why-go"}},[s._v("#")]),s._v(" Why Go?")]),s._v(" "),n("p",[s._v("gVisorは脆弱性を埋め込むことを防ぐためにGo言語で実装されています．")]),s._v(" "),n("h2",{attrs:{id:"overview-platforms"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#overview-platforms"}},[s._v("#")]),s._v(" Overview & Platforms")]),s._v(" "),n("p",[s._v("gVisorのサンドボックスは複数のプロセスから構成されます．これらのプロセスは複数のコンテナを実行できる共有環境を構成します．\nそれぞれのサンドボックスは隔離された"),n("code",[s._v("Sentry")]),s._v("と"),n("code",[s._v("Gofer")]),s._v("というインスタンスを持ちます．")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("Sentry")]),s._v("\nコンテナを実行し，アプリケーションによって発行されるシステムコールに対して介入し，応答するユーザー空間カーネル")]),s._v(" "),n("li",[n("code",[s._v("Gofer")]),s._v("\nコンテナにアクセスするファイルシステムを供給する\n"),n("img",{attrs:{src:"/img/arch4.png",alt:"arch4"}})])]),s._v(" "),n("h3",{attrs:{id:"runsc"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#runsc"}},[s._v("#")]),s._v(" runsc")]),s._v(" "),n("p",[s._v("サンドボックス化されたコンテナへのエントリーポイントが"),n("code",[s._v("runsc")]),s._v("です．"),n("code",[s._v("runsc")]),s._v("はOCI仕様に準拠しています．これはOCI互換のファイルシステムバンドルを実行することができることを意味します．ファイルシステムバンドルは"),n("code",[s._v("config.json")]),s._v("を含み，コンテナ設定やコンテナのルートファイルシステムから構成されます．")]),s._v(" "),n("h3",{attrs:{id:"sentry"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#sentry"}},[s._v("#")]),s._v(" Sentry")]),s._v(" "),n("p",[s._v("SentryはgVisorの中で最も大きなコンポーネントです．これはユーザー空間カーネルとして動作します．Sentryは信用されていないアプリケーションに必要なカーネルの機能の全てを実装しています．これはほぼ全てのシステムコールやシグナル伝搬，メモリ管理，ページ管理，スレッドなどを実装しています．\n信用されていないアプリケーションがシステムコールを発行するとき，使用されているプラットフォームはシステムコールをSentryにリダイレクトします．Sentryはホストカーネルにそのままシステムコールを通すわけではありません．ユーザー空間アプリケーションとして，Sentryはホストのシステムコールを発行します．しかし，Sentryはアプリケーションが自身が発行したシステムコールを直接制御することを許可しません．\nSentryはLinux v4.4以上の環境が必要です．")]),s._v(" "),n("p",[s._v("サンドボックスにより拡張されたファイルシステムはGoferによって送られます．")]),s._v(" "),n("h3",{attrs:{id:"platforms"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#platforms"}},[s._v("#")]),s._v(" Platforms")]),s._v(" "),n("p",[s._v("gVisorはプラットフォームに対してシステムコールの介入とコンテキストスイッチ，メモリマッピングの機能の実装を要求します．")]),s._v(" "),n("h4",{attrs:{id:"ptrace"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#ptrace"}},[s._v("#")]),s._v(" ptrace")]),s._v(" "),n("p",[s._v("ptraceはユーザーコードをホストのシステムコールを実行せずに実行するために"),n("code",[s._v("PTRACE_SYSEMU")]),s._v("を使用します．このプラットフォームはptraceが動作するどんな環境でも実行できます．")]),s._v(" "),n("h3",{attrs:{id:"gofer"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#gofer"}},[s._v("#")]),s._v(" Gofer")]),s._v(" "),n("p",[n("code",[s._v("Gofer")]),s._v("は通常のホストLinuxプロセスです．Goferはそれぞれのサンドボックスにより起動され，Sentryに接続されます．Sentryプロセスは制限されたseccompコンテナの中でファイルシステムリソースにアクセスすることなしに起動されます．GoferはSentryに9Pプロトコル経由でファイルシステムリソースにアクセスすることを可能にします．")]),s._v(" "),n("h3",{attrs:{id:"application"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#application"}},[s._v("#")]),s._v(" Application")]),s._v(" "),n("p",[s._v("アプリケーションはgVisorのOCIランタイムバンドルによって提供される通常のLinuxバイナリです．gVisorはLinux v4.4の環境が必要です．従ってアプリケーションは変更されずに実行できる必要があります．")]),s._v(" "),n("h2",{attrs:{id:"gvisorを使ってみる"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#gvisorを使ってみる"}},[s._v("#")]),s._v(" gVisorを使ってみる")]),s._v(" "),n("p",[s._v("gVisorを実際に使ってみます．gVisorはLinux環境でしか動作しないので今回はVagrantを用いて仮想環境を用意してその中にDockerを導入します．\nリポジトリはこちら．"),n("a",{attrs:{href:"https://github.com/terassyi/try-gVisor",target:"_blank",rel:"noopener noreferrer"}},[s._v("try-gVisor"),n("OutboundLink")],1),s._v("\n以下が"),n("code",[s._v("Vagrantfile")]),s._v(".")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('Vagrant.configure("2") do |config|\n\n  config.vm.box = "ubuntu/xenial64"\n  config.vm.synced_folder "./docker", "/home/vagrant/work"\n  config.vm.provision :shell, :path => "./install.sh"\n\nend\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("起動スクリプトとして"),n("code",[s._v("install.sh")]),s._v("を用意します．")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#! /bin/sh")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt")]),s._v(" update\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# install docker")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt")]),s._v(" -y "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    apt-transport-https "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    ca-certificates "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    gnupg-agent "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    software-properties-common\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -fsSL https://download.docker.com/linux/ubuntu/gpg "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" apt-key "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" -\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" add-apt-repository "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n   "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"deb [arch=amd64] https://download.docker.com/linux/ubuntu \\\n   '),n("span",{pre:!0,attrs:{class:"token variable"}},[n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),s._v("lsb_release -cs"),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v(' \\\n   stable"')]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt")]),s._v(" update\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt")]),s._v(" -y "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" docker.io\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# install gVisor")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -fsSL https://gvisor.dev/archive.key "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" apt-key "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" -\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" add-apt-repository "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"deb https://storage.googleapis.com/gvisor/releases release main"')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt-get")]),s._v(" update "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt-get")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y runsc\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" systemctl start docker\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add docker user group")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("groupadd")]),s._v(" docker\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" gpasswd -a "),n("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$USER")]),s._v(" docker\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# config runsc")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'{\n    "runtimes": {\n        "runsc": {\n            "path": "/usr/bin/runsc"\n        }\n    }\n}\'')]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" /etc/docker/daemon.json\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" systemctl restart docker\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" systemctl "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" docker\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br")])]),n("p",[s._v("というわけで起動します．")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("$ vagrant up\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("起動したら"),n("code",[s._v("ssh")]),s._v("で接続します．")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("$ vagrant ssh\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("接続したらコンテナをrunscを使用して起動してみましょう．")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("$ sudo docker run --runtime=runsc -it ubuntu dmesg\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("[    0.000000] Starting gVisor...\n[    0.513677] Checking naughty and nice process list...\n[    0.857696] Segmenting fault lines...\n[    1.293455] Creating process schedule...\n[    1.727520] Moving files to filing cabinet...\n[    1.889653] Rewriting operating system in Javascript...\n[    1.976582] Committing treasure map to memory...\n[    2.015297] Preparing for the zombie uprising...\n[    2.486752] Synthesizing system calls...\n[    2.578894] Creating cloned children...\n[    2.677559] Searching for socket adapter...\n[    3.025556] Ready!\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("p",[s._v("無事起動できたようです．")]),s._v(" "),n("h2",{attrs:{id:"gvisorのソースコードを読む"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#gvisorのソースコードを読む"}},[s._v("#")]),s._v(" gVisorのソースコードを読む")]),s._v(" "),n("p",[s._v("gVisorのリポジトリを手元に落として読んでみます．\n今回はGoLandを使用してみました．インターフェースの実装にも飛べるので便利ですね．")]),s._v(" "),n("h3",{attrs:{id:"ディレクトリ構成"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#ディレクトリ構成"}},[s._v("#")]),s._v(" ディレクトリ構成")]),s._v(" "),n("p",[s._v("トップレベルの構成はこんな感じです．")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v(".\n├── benchmarks\n├── g3doc\n├── kokoro\n├── pkg\n├── runsc\n├── scripts\n├── test\n├── tools\n└── vdso\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("p",[s._v("今回は"),n("code",[s._v("pkg")]),s._v("と"),n("code",[s._v("runsc")]),s._v("をみてみます．")]),s._v(" "),n("h3",{attrs:{id:"runsc-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#runsc-2"}},[s._v("#")]),s._v(" runsc")]),s._v(" "),n("p",[s._v("runscのディレクトリ構成はこちら")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v(".\n├── boot\n├── cgroup\n├── cmd\n├── console\n├── container\n├── criutil\n├── debian\n├── dockerutil\n├── flag\n├── fsgofer\n├── sandbox\n├── specutils\n└── testutil\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("p",[s._v("とりあえず怪しそうな"),n("code",[s._v("sandbox")]),s._v("パッケージから辿ってみます．")]),s._v(" "),n("h4",{attrs:{id:"sandbox"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#sandbox"}},[s._v("#")]),s._v(" sandbox")]),s._v(" "),n("p",[n("code",[s._v("sandbox")]),s._v("パッケージにはサンドボックスプロセスを生成するための構造体やメソッドが定義されているようです．")]),s._v(" "),n("blockquote",[n("p",[s._v("Sandbox wraps a sandbox process.\nIt is used to start/stop sandbox process (and associated processes like gofers), as well as for running and manipulating containers inside a running sandbox.\nNote: Sandbox must be immutable because a copy of it is saved for each container and changes would not be synchronized to all of them.")])]),s._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("type")]),s._v(" Sandbox "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ID is the id of the sandbox (immutable). By convention, this is the same")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ID as the first container run in the sandbox.")]),s._v("\n\tID "),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('`json:"id"`')]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Pid is the pid of the running sandbox (immutable). May be 0 if the sandbox")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// is not running.")]),s._v("\n\tPid "),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("int")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('`json:"pid"`')]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Cgroup has the cgroup configuration for the sandbox.")]),s._v("\n\tCgroup "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("cgroup"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Cgroup "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('`json:"cgroup"`')]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// child is set if a sandbox process is a child of the current process.")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// This field isn't saved to json, because only a creator of sandbox")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// will have it as a child process.")]),s._v("\n\tchild "),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("bool")]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// status is an exit status of a sandbox process.")]),s._v("\n\tstatus syscall"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("WaitStatus\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// statusMu protects status.")]),s._v("\n\tstatusMu sync"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Mutex\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br")])]),n("p",[n("code",[s._v("Sandbox.Pid")]),s._v("がサンドボックスとして動作しているプロセスのPIDのようです．New関数の"),n("code",[s._v("Sandbox.createSandboxProcess()")]),s._v("メソッドでプロセスを生成しています．非常に長い関数なので詳細は載せませんが名前空間を指定したり，引数を指定して")]),s._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("StartInNS")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cmd "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("exec"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Cmd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" nss "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("specs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("LinuxNamespace"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("error")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" cmd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Start")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("を呼び出します．この関数は内部で"),n("code",[s._v("cmd.Start()")]),s._v("を呼び出してプロセスを生成しているようです．")]),s._v(" "),n("p",[n("code",[s._v("sandbox.New()")]),s._v("を呼び出している箇所を辿ってみると"),n("code",[s._v("container")]),s._v("パッケージで呼び出されているようです．")]),s._v(" "),n("h4",{attrs:{id:"container"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#container"}},[s._v("#")]),s._v(" container")]),s._v(" "),n("p",[s._v("続いて"),n("code",[s._v("container")]),s._v("パッケージをみてみます．")]),s._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("type")]),s._v(" Container "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ID is the container ID.")]),s._v("\n\tID "),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('`json:"id"`')]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Spec is the OCI runtime spec that configures this container.")]),s._v("\n\tSpec "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("specs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Spec "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('`json:"spec"`')]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// BundleDir is the directory containing the container bundle.")]),s._v("\n\tBundleDir "),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('`json:"bundleDir"`')]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// CreatedAt is the time the container was created.")]),s._v("\n\tCreatedAt time"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Time "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('`json:"createdAt"`')]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Owner is the container owner.")]),s._v("\n\tOwner "),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('`json:"owner"`')]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ConsoleSocket is the path to a unix domain socket that will receive")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// the console FD.")]),s._v("\n\tConsoleSocket "),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('`json:"consoleSocket"`')]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Status is the current container Status.")]),s._v("\n\tStatus Status "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('`json:"status"`')]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// GoferPid is the PID of the gofer running along side the sandbox. May")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// be 0 if the gofer has been killed.")]),s._v("\n\tGoferPid "),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("int")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('`json:"goferPid"`')]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Sandbox is the sandbox this container is running in. It's set when the")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// container is created and reset when the sandbox is destroyed.")]),s._v("\n\tSandbox "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("sandbox"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Sandbox "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('`json:"sandbox"`')]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Saver handles load from/save to the state file safely from multiple")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// processes.")]),s._v("\n\tSaver StateFile "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('`json:"saver"`')]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Fields below this line are not saved in the state file and will not")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// be preserved across commands.")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//")]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// goferIsChild is set if a gofer process is a child of the current process.")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// This field isn't saved to json, because only a creator of a gofer")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// process will have it as a child process.")]),s._v("\n\tgoferIsChild "),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("bool")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br")])]),n("p",[s._v("こちらが"),n("code",[s._v("Container")]),s._v("構造体．"),n("code",[s._v("Sandbox")]),s._v(", "),n("code",[s._v("GoferPid")]),s._v("といったフィールドを持ってます．"),n("code",[s._v("container.New()")]),s._v("関数内で"),n("code",[s._v("sandbox.New()")]),s._v("関数や"),n("code",[s._v("Container.createGoferProcess()")]),s._v("メソッドを呼び出しGoferプロセスを生成しているようです．今回はこちらは詳しくみません．\n"),n("code",[s._v("Container")]),s._v("構造体には"),n("code",[s._v("Start")]),s._v(", "),n("code",[s._v("Run")]),s._v(", "),n("code",[s._v("Execute")]),s._v("などのメソッドが定義されています．\n"),n("code",[s._v("container.New()")]),s._v("は"),n("code",[s._v("pkg/cmd")]),s._v("で呼び出されているようです．というわけで"),n("code",[s._v("cmd")]),s._v("パッケージをみてみます．")]),s._v(" "),n("h4",{attrs:{id:"cmd"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#cmd"}},[s._v("#")]),s._v(" cmd")]),s._v(" "),n("p",[s._v("cmdパッケージには各種コマンドが定義されているようです．\ncmdパッケージ内のコマンドの名前になってそうな各ファイルの中に構造体が定義してあり，それぞれの構造体は"),n("code",[s._v("subcommands.Command")]),s._v("を実装しているようです．"),n("code",[s._v("subcommands")]),s._v("パッケージは"),n("a",{attrs:{href:"https://github.com/google/subcommands",target:"_blank",rel:"noopener noreferrer"}},[s._v("google/subcommands"),n("OutboundLink")],1),s._v("ですね．CLIを作成する際に使用するパッケージのようです．Rustのclapみたいな感じかな．各構造体の"),n("code",[s._v("Execute()")]),s._v("メソッドが実行されるコマンドの実体のようです．"),n("code",[s._v("cmd/boot.go")]),s._v("に定義されている"),n("code",[s._v("Boot")]),s._v("型の"),n("code",[s._v("Boot.Execute()")]),s._v("でサンドボックスが待ち状態で起動するようです．\n"),n("code",[s._v("Boot.Execute()")]),s._v("メソッドでは"),n("code",[s._v("Loader")]),s._v("構造体を生成して"),n("code",[s._v("Loader.Run()")]),s._v("メソッドを呼び出しているようです．")]),s._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Create the loader.")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("b "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("Boot"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Execute")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("_")]),s._v(" context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" f "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("flag"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("FlagSet"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" args "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("interface")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" subcommands"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ExitStatus "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 省略")]),s._v("\n\n\tbootArgs "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" boot"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Args"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tID"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("           f"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Arg")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\tSpec"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("         spec"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\tConf"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("         conf"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\tControllerFD"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" b"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("controllerFD"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\tDevice"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("       os"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("NewFile")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("uintptr")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("b"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("deviceFD"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"platform device"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\tGoferFDs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("     b"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ioFDs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("GetArray")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\tStdioFDs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("     b"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("stdioFDs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("GetArray")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\tConsole"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("      b"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\tNumCPU"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("       b"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("cpuNum"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\tTotalMem"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("     b"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("totalMem"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\tUserLogFD"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("    b"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("userLogFD"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    l"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" boot"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("New")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bootArgs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    \n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 省略")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Run the application and wait for it to finish.")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" l"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Run")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("nil")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tl"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Destroy")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Fatalf")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"running sandbox: %v"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 省略")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br")])]),n("p",[n("code",[s._v("Loader.Run()")]),s._v("でサンドボックスを起動しているのかな？\n"),n("code",[s._v("Loader")]),s._v("を詳しくみてみましょう．"),n("code",[s._v("cmd/boot")]),s._v("をみてみます．")]),s._v(" "),n("h4",{attrs:{id:"boot"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#boot"}},[s._v("#")]),s._v(" boot")]),s._v(" "),n("p",[n("code",[s._v("boot")]),s._v("パッケージに定義されている"),n("code",[s._v("Loader")]),s._v("型を覗いてみます．")]),s._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Loader keeps state needed to start the kernel and run the container..")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("type")]),s._v(" Loader "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// k is the kernel.")]),s._v("\n\tk "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("kernel"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Kernel\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ctrl is the control server.")]),s._v("\n\tctrl "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("controller\n\n\tconf "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("Config\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// console is set to true if terminal is enabled.")]),s._v("\n\tconsole "),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("bool")]),s._v("\n\n\twatchdog "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("watchdog"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Watchdog\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// stdioFDs contains stdin, stdout, and stderr.")]),s._v("\n\tstdioFDs "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("int")]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// goferFDs are the FDs that attach the sandbox to the gofers.")]),s._v("\n\tgoferFDs "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("int")]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// spec is the base configuration for the root container.")]),s._v("\n\tspec "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("specs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Spec\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// stopSignalForwarding disables forwarding of signals to the sandboxed")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// container. It should be called when a sandbox is destroyed.")]),s._v("\n\tstopSignalForwarding "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// restore is set to true if we are restoring a container.")]),s._v("\n\trestore "),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("bool")]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// rootProcArgs refers to the root sandbox init task.")]),s._v("\n\trootProcArgs kernel"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("CreateProcessArgs\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// sandboxID is the ID for the whole sandbox.")]),s._v("\n\tsandboxID "),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// mu guards processes.")]),s._v("\n\tmu sync"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Mutex\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// processes maps containers init process and invocation of exec. Root")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// processes are keyed with container ID and pid=0, while exec invocations")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// have the corresponding pid set.")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// processes is guardded by mu.")]),s._v("\n\tprocesses "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("map")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("execID"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("execProcess\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// mountHints provides extra information about mounts for containers that")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// apply to the entire pod.")]),s._v("\n\tmountHints "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("podMountHints\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br")])]),n("p",[n("code",[s._v("Loader")]),s._v("のフィールドには"),n("code",[s._v("k *kernel.Kernel")]),s._v("や"),n("code",[s._v("goferFDs []int")]),s._v("のような気になるフィールドがいくつかあります．\n全部見ているとキリがないので"),n("code",[s._v("Loader.Run()")]),s._v("を覗いてみます．\n"),n("code",[s._v("Loader.Run()")]),s._v("は"),n("code",[s._v("Loader.run()")]),s._v("を呼び出しているのでそちらをみます．")]),s._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("l "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("Loader"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("run")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("error")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 省略")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" l"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("k"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Start")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("このメソッドはいろいろな処理をしているようです．気になる関数を列挙してみました．")]),s._v(" "),n("ul",[n("li",[s._v("Loader.installSeccompFilters()")]),s._v(" "),n("li",[s._v("createFDTable()")]),s._v(" "),n("li",[s._v("startGoferMonitor()\n"),n("blockquote",[n("p",[s._v("startGoferMonitor runs a goroutine to monitor gofer's health. It polls on\nthe gofer FDs looking for disconnects, and destroys the container if a disconnect occurs in any of the gofer FDs.")])])]),s._v(" "),n("li",[s._v("processHints()")]),s._v(" "),n("li",[s._v("CreateProcess()\n"),n("blockquote",[n("p",[s._v("CreateProcess creates a new task in a new thread group with the given options. The new task has no parent and is in the root PID namespace. If k.Start() has already been called, then the created process must be started by calling kernel.StartProcess(tg). If k.Start() has not yet been called, then the created task will begin running when k.Start() is called. CreateProcess has no analogue in Linux; it is used to create the initial application task, as well as processes started by the control server.")])])]),s._v(" "),n("li",[s._v("Loader.Kernel.Start()")])]),s._v(" "),n("p",[s._v("こちらも別の機会にみてみたいと思います．\nとりあえず"),n("code",[s._v("Kernel.Start()")]),s._v("をみてみます．このメソッドは"),n("code",[s._v("pkg/sentry")]),s._v("に定義されているので"),n("code",[s._v("pkg/sentry")]),s._v("をみてみます．やっと"),n("code",[s._v("Sentry")]),s._v("にたどり着きました．")]),s._v(" "),n("h3",{attrs:{id:"pkg"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#pkg"}},[s._v("#")]),s._v(" pkg")]),s._v(" "),n("p",[s._v("ディレクトリ構成はこちら")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v(".\n├── abi\n├── amutex\n├── atomicbitops\n├── binary\n├── bits\n├── bpf\n├── buffer\n├── compressio\n├── context\n├── control\n├── cpuid\n├── eventchannel\n├── fd\n├── fdchannel\n├── fdnotifier\n├── flipcall\n├── fspath\n├── gate\n├── gohacks\n├── goid\n├── ilist\n├── linewriter\n├── log\n├── memutil\n├── metric\n├── p9\n├── pool\n├── procid\n├── rand\n├── refs\n├── safecopy\n├── safemem\n├── seccomp\n├── secio\n├── segment\n├── sentry\n├── sleep\n├── state\n├── sync\n├── syncevent\n├── syserr\n├── syserror\n├── tcpip\n├── tmutex\n├── unet\n├── urpc\n├── usermem\n└── waiter\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br")])]),n("h3",{attrs:{id:"sentry-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#sentry-2"}},[s._v("#")]),s._v(" sentry")]),s._v(" "),n("p",[s._v("gVisorの核となるコンポーネント．Sentryでユーザー空間カーネルを実現している．")]),s._v(" "),n("h4",{attrs:{id:"kernel"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#kernel"}},[s._v("#")]),s._v(" kernel")]),s._v(" "),n("p",[n("code",[s._v("pkg/sentry/kernel")]),s._v("に"),n("code",[s._v("Kernel")]),s._v("型が定義されています．\n"),n("code",[s._v("Kernel.Start()")]),s._v("がこちら．")]),s._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Start starts execution of all tasks in k.")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Preconditions: Start may be called exactly once.")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("k "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("Kernel"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Start")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("error")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tk"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("extMu"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Lock")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("defer")]),s._v(" k"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("extMu"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Unlock")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" k"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("globalInit "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("nil")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" fmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Errorf")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kernel contains no tasks"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" k"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("started "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" fmt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Errorf")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kernel already started"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\tk"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("started "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n\tk"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("cpuClockTicker "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ktime"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("NewTimer")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("k"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("monotonicClock"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("newKernelCPUClockTicker")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("k"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\tk"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("cpuClockTicker"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Swap")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ktime"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Setting"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tEnabled"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\tPeriod"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  linux"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ClockTick"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// If k was created by LoadKernelFrom, timers were stopped during")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Kernel.SaveTo and need to be resumed. If k was created by NewKernel,")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// this is a no-op.")]),s._v("\n\tk"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("resumeTimeLocked")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Start task goroutines.")]),s._v("\n\tk"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("tasks"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mu"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("RLock")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("defer")]),s._v(" k"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("tasks"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mu"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("RUnlock")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" tid "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("range")]),s._v(" k"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("tasks"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Root"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("tids "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Start")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("tid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("nil")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br")])]),n("p",[n("code",[s._v("Task.Start(ThreadID)")]),s._v("でタスクを起動しているようです．\nこのメソッドの処理はこんな感じ．")]),s._v(" "),n("blockquote",[n("p",[s._v("'tid' must be the task's TID in the root PID namespace and it's used for debugging purposes only (set as parameter to Task.run to make it visible in stack dumps).")])]),s._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("t "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("Task"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Start")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("tid ThreadID"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// If the task was restored, it may be "starting" after having already exited.')]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("runState "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("nil")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\tt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("goroutineStopped"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Add")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\tt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("tg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("liveGoroutines"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Add")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\tt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("tg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pidns"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("owner"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("liveGoroutines"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Add")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\tt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("tg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pidns"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("owner"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("runningGoroutines"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Add")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Task is now running in system mode.")]),s._v("\n\tt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("accountTaskGoroutineLeave")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("TaskGoroutineNonexistent"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Use the task's TID in the root PID namespace to make it visible in stack dumps.")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("go")]),s._v(" t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("run")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("uintptr")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("tid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// S/R-SAFE: synchronizes with saving through stops")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])]),n("p",[s._v("どうやらgoroutineで"),n("code",[s._v("Task.run(tid)")]),s._v("を起動しているようです．\n"),n("code",[s._v("Kernel")]),s._v("構造体に登録されているそれぞれの"),n("code",[s._v("Task")]),s._v("をgoroutineを使用して走らせているようですね．\n"),n("code",[s._v("Task.run()")]),s._v("をみてみます．")]),s._v(" "),n("blockquote",[n("p",[s._v("run runs the task goroutine. threadID a dummy value set to the task's TID in the root PID namespace to make it visible in stack dumps. A goroutine for a given task can be identified searching for Task.run()'s argument value.")])]),s._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("t "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("Task"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("run")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("threadID "),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 省略")]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("doStop")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\tt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("runState "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("runState"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("execute")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("runState "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("nil")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t\tt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("accountTaskGoroutineEnter")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("TaskGoroutineNonexistent"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\t\tt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("goroutineStopped"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Done")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\t\tt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("tg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("liveGoroutines"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Done")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\t\tt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("tg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pidns"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("owner"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("liveGoroutines"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Done")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\t\tt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("tg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pidns"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("owner"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("runningGoroutines"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Done")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Keep argument alive because stack trace for dead variables may not be correct.")]),s._v("\n\t\t\truntime"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("KeepAlive")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("threadID"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br")])]),n("p",[n("code",[s._v("t.runState = t.runState.execute(t)")]),s._v("で実際の処理を行なっていそうです．"),n("code",[s._v("execute(Task)")]),s._v("はインターフェースとして実装されており．"),n("code",[s._v("runState")]),s._v("の状態により呼び出される実装が変化するようです．今回は"),n("code",[s._v("runApp")]),s._v("型に実装されている"),n("code",[s._v("execute()")]),s._v("メソッドをみてみます．")]),s._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("app "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("runApp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("execute")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("t "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("Task"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" taskRunState "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 省略")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("switch")]),s._v(" err "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("nil")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Handle application system call.")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("doSyscall")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 省略")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("いろいろ処理をしていますが"),n("code",[s._v("Task.doSyscall()")]),s._v("でシステムコールをハンドリングしてそうな感じですね．")]),s._v(" "),n("blockquote",[n("p",[s._v("doSyscall is the entry point for an invocation of a system call specified by the current state of t's registers. The syscall path is very hot; avoid defer.")])]),s._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("t "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("Task"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("doSyscall")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" taskRunState "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    sysno "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Arch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("SyscallNo")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    args "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Arch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("SyscallArgs")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 省略")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Check seccomp filters. The nil check is for performance (as seccomp use")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// is rare), not needed for correctness.")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("syscallFilters"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Load")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("nil")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("switch")]),s._v(" r "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("checkSeccompSyscall")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("int32")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sysno"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" args"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" usermem"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Addr")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Arch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("IP")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" r "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 省略")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("doSyscallEnter")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sysno"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" args"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("p",[n("code",[s._v("seccomp")]),s._v("でシステムコールをチェックしているようです．その後，"),n("code",[s._v("Task.doSyscallEnter(sysno, args)")]),s._v("でシステムコールを発行している感じです．")]),s._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("t "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("Task"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("doSyscallEnter")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sysno "),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" args arch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("SyscallArguments"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" taskRunState "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" next"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ok "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ptraceSyscallEnter")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" ok "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" next\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("doSyscallInvoke")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sysno"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" args"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[n("code",[s._v("ptraceSyscallEnter()")]),s._v("で発行されるシステムコールがptraceでストップされるべきかチェックした後"),n("code",[s._v("Task.doSyscallInvoke(sysno, args)")]),s._v("を呼び出しています．このメソッドでは"),n("code",[s._v("Task.executeSyscall(sysno, args)")]),s._v("を呼び出してシステムコールを発行するようです．このメソッドを覗いてみます．")]),s._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("t "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("Task"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("executeSyscall")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sysno "),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" args arch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("SyscallArguments"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("rval "),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ctrl "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("SyscallControl"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err "),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("error")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\ts "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("SyscallTable")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 省略")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" bits"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("IsOn32")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("fe"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ExternalBeforeEnable"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ExternalFilterBefore "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("nil")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v(" s"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ExternalFilterBefore")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" sysno"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" args"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tt"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("invokeExternal")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Ensure we check for stops, then invoke the syscall again.")]),s._v("\n\t\tctrl "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ctrlStopAndReinvokeSyscall\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tfn "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" s"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Lookup")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sysno"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 省略")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" fn "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("nil")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Call our syscall implementation.")]),s._v("\n\t\t\trval"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ctrl"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("fn")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" args"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Use the missing function if not found.")]),s._v("\n\t\t\trval"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("SyscallTable")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Missing")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" sysno"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" args"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 省略")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br")])]),n("p",[s._v("ざっと重要な部分を抜き出しました．最初にシステムコールテーブルを作成してます．その後，テーブルを走査してシステムコールの実体を呼び出しています．("),n("code",[s._v("Lookup()")]),s._v("の部分)")]),s._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[s._v("rval"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ctrl"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("fn")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" args"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("ここでシステムコールを発行しています．")]),s._v(" "),n("p",[s._v("一通りシステムコールが発行されるまでの流れを追ってみました．大体は追えたかなと思います．というわけで次はユーザー空間システムコールについてみてみます．")]),s._v(" "),n("p",[s._v("先ほどの"),n("code",[s._v("Lookup()")]),s._v("から辿ってみます．")]),s._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Lookup returns the syscall implementation, if one exists.")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("SyscallTable"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Lookup")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sysno "),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SyscallFn "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" sysno "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("uintptr")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("len")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("lookup"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" s"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("lookup"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("sysno"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("nil")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[n("code",[s._v("SyscallTable")]),s._v("型の定義をみてみます．")]),s._v(" "),n("blockquote",[n("p",[s._v("SyscallTable is a lookup table of system calls. Critically, a SyscallTable is "),n("em",[s._v("immutable")]),s._v(". In order to make supporting suspend and resume sane, they must be uniquely registered and may not change during operation. +stateify savable")])]),s._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("type")]),s._v(" SyscallTable "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 省略")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Table is the collection of functions.")]),s._v("\n    Table "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("map")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("Syscall "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('`state:"manual"`')]),s._v("\n    \n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// lookup is a fixed-size array that holds the syscalls (indexed by")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// their numbers). It is used for fast look ups.")]),s._v("\n    lookup "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("SyscallFn "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('`state:"manual"`')]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 省略")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("p",[n("code",[s._v("lookup")]),s._v("フィールドが"),n("code",[s._v("SyscallFn")]),s._v("型のスライスを保持しています．\nシステムコール関数の登録は"),n("code",[s._v("RegisterSyscallTable()")]),s._v("関数で行われます．")]),s._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// RegisterSyscallTable registers a new syscall table for use by a Kernel.")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("RegisterSyscallTable")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("SyscallTable"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Initialize the fast-lookup table.")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" num"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" sc "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("range")]),s._v(" s"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Table "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\ts"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("lookup"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("num"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" sc"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Fn\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[n("code",[s._v("Table")]),s._v("フィールドにより"),n("code",[s._v("SyscallTable")]),s._v("型がNewされる時に初期化されているようです．"),n("code",[s._v("Table")]),s._v("フィールドは"),n("code",[s._v("map[uintptr]Syscall")]),s._v("型なので実際に呼び出される"),n("code",[s._v("SyscallFn")]),s._v("型をマッピングし直しているようです．\n"),n("code",[s._v("Syscall")]),s._v("型はこちら")]),s._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Syscall includes the syscall implementation and compatibility information.")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("type")]),s._v(" Syscall "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Name is the syscall name.")]),s._v("\n\tName "),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Fn is the implementation of the syscall.")]),s._v("\n\tFn SyscallFn\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// SupportLevel is the level of support implemented in gVisor.")]),s._v("\n\tSupportLevel SyscallSupportLevel\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Note describes the compatibility of the syscall.")]),s._v("\n\tNote "),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// URLs is set of URLs to any relevant bugs or issues.")]),s._v("\n\tURLs "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br")])]),n("p",[n("code",[s._v("Fn")]),s._v("に"),n("code",[s._v("SyscallFn")]),s._v("型を持ってますね．\n続いて"),n("code",[s._v("SyscallFn")]),s._v("型をみてみます．")]),s._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// SyscallFn is a syscall implementation.")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("type")]),s._v(" SyscallFn "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("t "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("Task"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" args arch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("SyscallArguments"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("SyscallControl"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("error")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("名前のごとくシステムコール関数の型ですね．\n次はこれらのシステムコール関数の実装を探します．\n"),n("code",[s._v("RegisterSyscallTable(s *SyscallTable)")]),s._v("が呼び出される場所を辿ると，"),n("code",[s._v("runsc/boot/loader_amd64.go")]),s._v(", "),n("code",[s._v("runsc/boot/loader_arm64.go")]),s._v("の初期化関数から呼び出されているようです．実装はどちらも同じなので紹介します．(AMDの方)")]),s._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("init")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Register the global syscall table.")]),s._v("\n\tkernel"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("RegisterSyscallTable")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("linux"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("AMD64"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("引数として与えられている構造体をみてみましょう．")]),s._v(" "),n("blockquote",[n("p",[s._v("AMD64 is a table of Linux amd64 syscall API with the corresponding syscall numbers from Linux 4.4.")])]),s._v(" "),n("div",{staticClass:"language-go line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-go"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),s._v(" AMD64 "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("kernel"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("SyscallTable"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tOS"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("   abi"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Linux"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\tArch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" arch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("AMD64"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\tVersion"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kernel"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Version"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Version 4.4 is chosen as a stable, longterm version of Linux, which")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// guides the interface provided by this syscall table. The build")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// version is that for a clean build with default kernel config, at 5")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// minutes after v4.4 was tagged.")]),s._v("\n\t\tSysname"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" LinuxSysname"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\tRelease"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" LinuxRelease"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\tVersion"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" LinuxVersion"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\tAuditNumber"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" linux"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("AUDIT_ARCH_X86_64"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\tTable"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("map")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("kernel"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Syscall"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("   syscalls"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Supported")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"read"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" Read"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("   syscalls"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Supported")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"write"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" Write"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("   syscalls"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("PartiallySupported")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"open"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" Open"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Options O_DIRECT, O_NOATIME, O_PATH, O_TMPFILE, O_SYNC are not supported."')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("nil")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("   syscalls"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Supported")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"close"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" Close"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("   syscalls"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Supported")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"stat"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" Stat"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("   syscalls"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Supported")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"fstat"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" Fstat"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("   syscalls"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Supported")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"lstat"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" Lstat"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("   syscalls"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Supported")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"poll"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" Poll"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("   syscalls"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Supported")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"lseek"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" Lseek"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("   syscalls"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("PartiallySupported")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mmap"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" Mmap"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Generally supported with exceptions. Options MAP_FIXED_NOREPLACE, MAP_SHARED_VALIDATE, MAP_SYNC MAP_GROWSDOWN, MAP_HUGETLB are not supported."')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("nil")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  syscalls"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Supported")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mprotect"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" Mprotect"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  syscalls"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Supported")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"munmap"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" Munmap"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  syscalls"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Supported")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"brk"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" Brk"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  syscalls"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Supported")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rt_sigaction"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" RtSigaction"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  syscalls"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Supported")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rt_sigprocmask"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" RtSigprocmask"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  syscalls"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Supported")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rt_sigreturn"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" RtSigreturn"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  syscalls"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("PartiallySupported")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ioctl"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" Ioctl"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Only a few ioctls are implemented for backing devices and file systems."')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("nil")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 省略")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("    \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br")])]),n("p",[n("code",[s._v("syscalls.Supported()")]),s._v("の第二引数に与えられているのがシステムコール関数の実装です．\n各システムコールの実装は辿るのが大変なのでまたの機会に．\nどのようにSentryとGoferが動いているのかやユーザー空間カーネルについて少しは理解できたかなと思います．")]),s._v(" "),n("h2",{attrs:{id:"まとめ"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#まとめ"}},[s._v("#")]),s._v(" まとめ")]),s._v(" "),n("p",[s._v("今回はGoogle製の安全なコンテナランタイムであるgVisorを覗いてみました．コンテナプロセスが立ち上がるところから見始めてユーザー空間に実装されたgVisorのシステムコールが実行されるまでを辿ってみました．まだまだわからない部分も多く，飛ばした箇所も多かったので今後もっと詳しくみてみたいです．モチベとしては自作コンテナランタイムとかの足掛かりになればと思っていましたが，そこらへんをみるなら普通にruncとかをみた方がいいかもなと思いました．これはこれで面白かったです．gVisorは現在はLinuxのみのサポートで，ネットワーク周りのオーバーヘッドが大きいということなのでMac OSがサポートされたりパフォーマンスが向上したら実際に使ってみたいなと考えています．")]),s._v(" "),n("disqus")],1)}),[],!1,null,null,null);t.default=e.exports}}]);