(window.webpackJsonp=window.webpackJsonp||[]).push([[35],{303:function(a,s,t){"use strict";t.r(s);var n=t(1),e=Object(n.a)({},(function(){var a=this,s=a.$createElement,t=a._self._c||s;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("p",[a._v("こんにちは．学生生活も後少しとなってしまいました．悲しいです．\n今回はxdpcapというツールについてです．xdpcapの使用に関する資料が日本語では非常に少なかったので使い方を紹介します．")]),a._v(" "),t("h2",{attrs:{id:"cloudflare-xdpcap"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#cloudflare-xdpcap"}},[a._v("#")]),a._v(" cloudflare/xdpcap")]),a._v(" "),t("p",[t("a",{attrs:{href:"https://github.com/cloudflare/xdpcap",target:"_blank",rel:"noopener noreferrer"}},[a._v("cloudflare/xdpcap"),t("OutboundLink")],1),a._v("はeXpress Data Path(XDP)を利用したtcpdumpのように使えるツールです．\nxdpcapはtcpdumpで使用するのと同様のフィルタリングルールを使用してパケットをキャプチャしたり，pcapファイルにダンプすることができます．")]),a._v(" "),t("p",[a._v("xdpで編集したパケットはtcpdumpでは見えなくなるのでちゃんとパケットの組み立てができているかわかりません．\nこのツールの嬉しさはxdpで編集後のパケットをtcpdumpと同じようにキャプチャできることです．")]),a._v(" "),t("h3",{attrs:{id:"tcpdumpとの違い"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#tcpdumpとの違い"}},[a._v("#")]),a._v(" tcpdumpとの違い")]),a._v(" "),t("p",[a._v("tcpdumpは内部でパケットをフィルタリングする際にcBPFを利用しますが，xdpcapはxdpを使用します．\nxdpcapでキャプチャしたパケットはxdpプログラムによって変更が加えられた後のパケットです．\nまた，xdp action codeも同時にキャプチャしてくれます．\nxdp action codeには以下のようなものがあります．")]),a._v(" "),t("ul",[t("li",[a._v("XDP_PASS")]),a._v(" "),t("li",[a._v("XDP_DROP")]),a._v(" "),t("li",[a._v("XDP_ABORTED")]),a._v(" "),t("li",[a._v("XDP_TX")]),a._v(" "),t("li",[a._v("XDP_REDIRECT")])]),a._v(" "),t("h3",{attrs:{id:"手法"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#手法"}},[a._v("#")]),a._v(" 手法")]),a._v(" "),t("p",[a._v("xdpcapではフィルタリングするためにxdpcapが使えるebpfマップをフックしてあげる必要があります．\nこのフックはeBPFの"),t("code",[a._v("tail call")]),a._v("を使用して実現されています．\n"),t("code",[a._v("tail call")]),a._v("はbpfプログラムから別のbpfプログラムを呼び出すための機能です．\n詳しくは"),t("a",{attrs:{href:"https://docs.cilium.io/en/stable/bpf/#tail-calls",target:"_blank",rel:"noopener noreferrer"}},[a._v("cilium document: tail calls"),t("OutboundLink")],1),a._v("を参照してください．\n"),t("code",[a._v("tail call")]),a._v("を行うためには"),t("code",[a._v("BPF_MAP_TYPE_PROG_ARRAY")]),a._v("というタイプのbpf mapが必要です．さらに"),t("code",[a._v("bpf_tail_call()")]),a._v("というヘルパー関数が用意されている必要があります．\nxdpcapはこの"),t("code",[a._v("tail call")]),a._v("を利用してユーザーが定義したxdpプログラムがリターンする際のコンテキストを引き継いでxdpcapのbpfプログラムによりキャプチャされます．\n詳しくは"),t("a",{attrs:{href:"https://blog.cloudflare.com/xdpcap/",target:"_blank",rel:"noopener noreferrer"}},[a._v("xdpcap: XDP Packet Capture"),t("OutboundLink")],1),a._v("を参照してください．")]),a._v(" "),t("h3",{attrs:{id:"使い方"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使い方"}},[a._v("#")]),a._v(" 使い方")]),a._v(" "),t("p",[a._v("今回作成したプログラムは"),t("a",{attrs:{href:"https://github.com/terassyi/xdpcap-with-cilium",target:"_blank",rel:"noopener noreferrer"}},[a._v("terassyi/xdpcap-with-cilium"),t("OutboundLink")],1),a._v("にあります．")]),a._v(" "),t("h4",{attrs:{id:"環境"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#環境"}},[a._v("#")]),a._v(" 環境")]),a._v(" "),t("p",[a._v("本プログラムの動作環境は以下です．")]),a._v(" "),t("ul",[t("li",[t("code",[a._v("Linux ip-172-31-20-186 5.11.0-1019-aws #20~20.04.1-Ubuntu SMP Tue Sep 21 10:40:39 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux")])]),a._v(" "),t("li",[t("code",[a._v("go 1.16")])]),a._v(" "),t("li",[t("code",[a._v("clang version 10.0.0-4ubuntu1")])])]),a._v(" "),t("h4",{attrs:{id:"前準備"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#前準備"}},[a._v("#")]),a._v(" 前準備")]),a._v(" "),t("p",[a._v("まずxdpcapをインストールします．\n"),t("code",[a._v("xdpcap")]),a._v("を使用するためには"),t("code",[a._v("bpffs")]),a._v("がマウントされている必要があります．\nマウントは以下のコマンドで行えます．")]),a._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[a._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("mount")]),a._v(" -t bpf none /sys/fs/bpf\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("h3",{attrs:{id:"実行"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#実行"}},[a._v("#")]),a._v(" 実行")]),a._v(" "),t("ol",[t("li",[t("code",[a._v("make")]),a._v("コマンドでビルドします．"),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[a._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("make")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])])]),a._v(" "),t("li",[a._v("ビルドされた実行ファイルを以下のように実行します．"),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[a._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" ./xdpcap-with-cilium -iface "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("interface"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])])]),a._v(" "),t("li",[a._v("別ターミナルで以下のコマンドを実行することでパケットのキャプチャとファイルへの保存を行うことができます．"),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[a._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" xdpcap /sys/fs/bpf/xdpcap "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("pcap file"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"filter rules"')]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" xdpcap /sys/fs/bpf/xdpcap - "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"filter rules"')]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" tcpdump -r -\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])])])]),a._v(" "),t("h3",{attrs:{id:"実装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#実装"}},[a._v("#")]),a._v(" 実装")]),a._v(" "),t("h4",{attrs:{id:"xdp-program"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#xdp-program"}},[a._v("#")]),a._v(" XDP Program")]),a._v(" "),t("p",[t("code",[a._v("bpf")]),a._v("配下にxdp用のプログラムがあります．\nディレクトリの構成は以下です．")]),a._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("bpf\n├── header\n│   ├── bpf.h\n│   └── bpf_helpers.h\n├── hook.h\n└── prog.c\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br")])]),t("p",[t("code",[a._v("bpf/header")]),a._v("配下にある"),t("code",[a._v("bpf.h")]),a._v(", "),t("code",[a._v("bpf_helpers.h")]),a._v("は"),t("a",{attrs:{href:"https://github.com/dropbox/goebpf",target:"_blank",rel:"noopener noreferrer"}},[a._v("dropbox/goebpf"),t("OutboundLink")],1),a._v("から借用しています．必要なものが定義されているならどれでも構いません．\n"),t("code",[a._v("bpf/hook.h")]),a._v("にxdpcapのための関数が定義されています．\n内容はフック用の"),t("code",[a._v("PROG_ARRAY")]),a._v("のマップの定義と"),t("code",[a._v("tail_call")]),a._v("をラップした"),t("code",[a._v("xdpcap_exit()")]),a._v("関数のみなので"),t("code",[a._v("prog.c")]),a._v("にコピペしてもかまいません．\n"),t("code",[a._v("prog.c")]),a._v("でも特に何もしていません．ただ"),t("code",[a._v("XDP_PASS")]),a._v("でパケットをパスしますが"),t("code",[a._v("xdpcap_exit()")]),a._v("を呼び出すことでxdpcapのbpfプログラムをtail callします．")]),a._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[a._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[a._v("include")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"hook.h"')])]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[a._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[a._v("include")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"bpf_helpers.h"')])]),a._v("\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("BPF_MAP_DEF")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("xdpcap_hook"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("map_type "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" BPF_MAP_TYPE_PROG_ARRAY"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("key_size "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("sizeof")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("int")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("value_size "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("sizeof")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("int")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("max_entries "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("BPF_MAP_ADD")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("xdpcap_hook"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("SEC")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"xdp"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("int")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("prog")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("struct")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("xdp_md")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),a._v("ctx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n\t"),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("return")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("xdpcap_exit")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("ctx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&")]),a._v("xdpcap_hook"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" XDP_PASS"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br"),t("span",{staticClass:"line-number"},[a._v("11")]),t("br"),t("span",{staticClass:"line-number"},[a._v("12")]),t("br"),t("span",{staticClass:"line-number"},[a._v("13")]),t("br"),t("span",{staticClass:"line-number"},[a._v("14")]),t("br"),t("span",{staticClass:"line-number"},[a._v("15")]),t("br"),t("span",{staticClass:"line-number"},[a._v("16")]),t("br")])]),t("h4",{attrs:{id:"go-program"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#go-program"}},[a._v("#")]),a._v(" Go program")]),a._v(" "),t("p",[a._v("今回はxdpのフロントとして"),t("a",{attrs:{href:"https://github.com/cilium/ebpf",target:"_blank",rel:"noopener noreferrer"}},[a._v("cilium/ebpf"),t("OutboundLink")],1),a._v("を使用しています．")]),a._v(" "),t("p",[a._v("ciliumには"),t("code",[a._v("bpf2go")]),a._v("というパッケージがあって"),t("code",[a._v("bpf2go")]),a._v("経由でbpfプログラムをビルドすることでbpfプログラムをGo側でロードするためのインターフェースとなるGoのコードを自動生成してくれます．\n自動生成されたコードのなかにコンパイルしたbpfのバイトコードをバイトスライスとして保存しているためGoのコードをビルドするとあとはシングルバイナリで動作します．\nmain.goに以下の行を追加することで"),t("code",[a._v("go generate")]),a._v("によりコードを自動生成できます．")]),a._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("//go:generate go run github.com/cilium/ebpf/cmd/bpf2go -cc clang XdpcapProg ./bpf/prog.c -- -I./bpf/header\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("p",[a._v("続いてbpfプログラムのロードとアタッチ，bpfマップのピンです．\n"),t("code",[a._v("Collect")]),a._v("という型を定義してbpfプログラムとマップをGo側で保持するための構造体を作ります．")]),a._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("type")]),a._v(" Collect "),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("struct")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n\tXdpProg "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),a._v("ebpf"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("Program "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('`ebpf:"prog"`')]),a._v("\n\tXdpcapHook "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),a._v("ebpf"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("Map "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('`ebpf:"xdpcap_hook"`')]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br")])]),t("p",[a._v("そして"),t("code",[a._v("bpf2go")]),a._v("により自動生成される関数を使用してbpfプログラムをロードします．")]),a._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[a._v("spec"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" err "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("LoadXdpcapProg")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" err "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("nil")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n\t"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("panic")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("err"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" err "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":=")]),a._v(" spec"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("LoadAndAssign")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("collect"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("nil")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" err "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("nil")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n\t"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("panic")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("err"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" err "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":=")]),a._v(" netlink"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("LinkSetXdpFd")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("link"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" collect"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("XdpProg"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("FD")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" err "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("nil")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n\t"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("panic")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("err"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br")])]),t("p",[a._v("その後，bpfマップのbpffsへのピンを行います．")]),a._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[a._v("tmpDir "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[a._v('"/sys/fs/bpf/xdpcap"')]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" err "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":=")]),a._v(" collect"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("XdpcapHook"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("Pin")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("tmpDir"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" err "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!=")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("nil")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n\t"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("panic")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("err"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br")])]),t("p",[a._v("実装は以上となります．ほぼ何もしないので実装は簡単です．")]),a._v(" "),t("h2",{attrs:{id:"まとめ"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#まとめ"}},[a._v("#")]),a._v(" まとめ")]),a._v(" "),t("p",[a._v("今回は"),t("code",[a._v("xdpcap")]),a._v("というxdpを利用したパケットキャプチャツールの使い方を紹介しました．\nxdpを使うときは編集したパケットをのぞくのが難しいので使えると便利です．\nxdp関連の話題は日本語の資料がないので参考になれば幸いです．")]),a._v(" "),t("h2",{attrs:{id:"参考資料"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考資料"}},[a._v("#")]),a._v(" 参考資料")]),a._v(" "),t("h3",{attrs:{id:"cloudflare-xdpcap-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#cloudflare-xdpcap-2"}},[a._v("#")]),a._v(" cloudflare/xdpcap")]),a._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"https://blog.masu-mi.me/post/2021/01/29/try-to-use-xdpcap/",target:"_blank",rel:"noopener noreferrer"}},[a._v("xdpcapを使ってみる"),t("OutboundLink")],1)]),a._v(" "),t("li",[t("a",{attrs:{href:"https://blog.cloudflare.com/xdpcap/",target:"_blank",rel:"noopener noreferrer"}},[a._v("xdpcap: XDP Packet Capture"),t("OutboundLink")],1)])]),a._v(" "),t("h3",{attrs:{id:"cilium-ebpf"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#cilium-ebpf"}},[a._v("#")]),a._v(" cilium/ebpf")]),a._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"https://docs.cilium.io/en/stable/bpf/#tail-calls",target:"_blank",rel:"noopener noreferrer"}},[a._v("cilium document: tail calls"),t("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=e.exports}}]);