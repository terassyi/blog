(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{242:function(t,s,a){"use strict";var n=0;function e(t){if(!n){var s=document.createElement("script");s.setAttribute("src",t),document.body.appendChild(s),n=new Promise((function(t){s.onload=function(){t(window.twttr)}}))}return n}var r={id:{type:String,required:!0},sourceType:{type:String},slug:{type:String},options:Object};t.exports={addPlatformScript:e,twitterEmbedComponent:function(t){return{data:function(){return{isLoaded:!1,isAvailable:!1}},props:Object.assign({},r,t.props),mounted:function(){var s,a=this;s="profile"===this.sourceType?{sourceType:this.sourceType,screenName:this.id}:"list"===this.sourceType?{sourceType:this.sourceType,ownerScreenName:this.id,slug:this.slug}:this.id,Promise.resolve(window.twttr?window.twttr:e("//platform.twitter.com/widgets.js")).then((function(n){return t.embedComponent(n,s,a.$el,a.options)})).then((function(t){a.isAvailable=void 0!==t,a.isLoaded=!0}))},render:function(t){if(this.isLoaded&&this.isAvailable)return t("div",{class:this.$props.widgetClass});if(this.isLoaded&&!this.isAvailable&&this.$props.errorMessage){var s=t("div",{class:this.$props.errorMessageClass,domProps:{innerHTML:this.$props.errorMessage}});return t("div",[s])}return t("div",{class:this.$props.widgetClass},this.$slots.default)}}}}},244:function(t,s,a){"use strict";Object.defineProperty(s,"__esModule",{value:!0}),Object.defineProperty(s,"Tweet",{enumerable:!0,get:function(){return n.default}}),Object.defineProperty(s,"Moment",{enumerable:!0,get:function(){return e.default}}),Object.defineProperty(s,"Timeline",{enumerable:!0,get:function(){return r.default}});var n=p(a(245)),e=p(a(246)),r=p(a(247));function p(t){return t&&t.__esModule?t:{default:t}}},245:function(t,s,a){"use strict";Object.defineProperty(s,"__esModule",{value:!0}),s.default=void 0;var n=(0,a(242).twitterEmbedComponent)({embedComponent:function(t){for(var s,a=arguments.length,n=new Array(a>1?a-1:0),e=1;e<a;e++)n[e-1]=arguments[e];return(s=t.widgets).createTweetEmbed.apply(s,n)},props:{errorMessage:{type:String,default:"Whoops! We couldn't access this Tweet."},errorMessageClass:{type:String,required:!1},widgetClass:{type:String,required:!1}}});s.default=n},246:function(t,s,a){"use strict";Object.defineProperty(s,"__esModule",{value:!0}),s.default=void 0;var n=(0,a(242).twitterEmbedComponent)({embedComponent:function(t){for(var s,a=arguments.length,n=new Array(a>1?a-1:0),e=1;e<a;e++)n[e-1]=arguments[e];return(s=t.widgets).createMoment.apply(s,n)},props:{errorMessage:{type:String,default:"Whoops! We couldn't access this Moment."},errorMessageClass:{type:String,required:!1},widgetClass:{type:String,required:!1}}});s.default=n},247:function(t,s,a){"use strict";Object.defineProperty(s,"__esModule",{value:!0}),s.default=void 0;var n=(0,a(242).twitterEmbedComponent)({embedComponent:function(t){for(var s,a=arguments.length,n=new Array(a>1?a-1:0),e=1;e<a;e++)n[e-1]=arguments[e];return(s=t.widgets).createTimeline.apply(s,n)},props:{errorMessage:{type:String,default:"Whoops! We couldn't access this Timeline."},errorMessageClass:{type:String,required:!1},widgetClass:{type:String,required:!1}}});s.default=n},284:function(t,s,a){"use strict";a.r(s);var n={components:{Tweet:a(244).Tweet}},e=a(1),r=Object(e.a)(n,(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("p",[t._v("こんにちは．閃光のハサウェイが配信開始されたので早速視聴しました．メッサーがいいですね．")]),t._v(" "),a("p",[t._v("前回もXDP関連の話題でしたが，今回はXDPに入門します．\nXDPを学習する際のロードマップやつまりどころの解消になればと思います．")]),t._v(" "),a("h2",{attrs:{id:"xdp"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#xdp"}},[t._v("#")]),t._v(" XDP")]),t._v(" "),a("p",[t._v("XDPとはeXpress Data Pathの略でLinuxカーネル内で動作するeBPFベースの高性能なパケット処理技術です．\n制限のあるC言語で記述したプログラムをBPFバイトコードにコンパイルし，NICにアタッチすることでカーネルのプロトコルスタックより手前でパケット処理を行うことができます．\nXDPには以下のようなメリットがあります．")]),t._v(" "),a("ul",[a("li",[t._v("カーネルを修正することなく柔軟にパケット処理機能を実装することができる")]),t._v(" "),a("li",[t._v("特別なハードウェアを準備することなく利用することができる")]),t._v(" "),a("li",[t._v("高速にパケットを処理することができる")]),t._v(" "),a("li",[t._v("既存のTCP/IPスタックを置き換えることなく協調して動作させることができる")])]),t._v(" "),a("h2",{attrs:{id:"ユースケース"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ユースケース"}},[t._v("#")]),t._v(" ユースケース")]),t._v(" "),a("p",[t._v("XDPのユースケースとして以下のようなものがあります．")]),t._v(" "),a("ul",[a("li",[t._v("DDos攻撃の軽減\n"),a("ul",[a("li",[a("a",{attrs:{href:"https://blog.cloudflare.com/l4drop-xdp-ebpf-based-ddos-mitigations/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Cloudflare Gatebot"),a("OutboundLink")],1)])])]),t._v(" "),a("li",[t._v("L4ロードバランサ\n"),a("ul",[a("li",[a("a",{attrs:{href:"https://engineering.fb.com/2018/05/22/open-source/open-sourcing-katran-a-scalable-network-load-balancer/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Facebook Katran"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://speakerdeck.com/line_devday2019/software-engineering-that-supports-line-original-lbaas",target:"_blank",rel:"noopener noreferrer"}},[t._v("LINE"),a("OutboundLink")],1)])])]),t._v(" "),a("li",[t._v("NAT\n"),a("ul",[a("li",[a("a",{attrs:{href:"https://speakerdeck.com/mabuchin/zhuan-binagaramonetutowakuchu-li-wo-sohutoueadezi-zuo-siteikuhua",target:"_blank",rel:"noopener noreferrer"}},[t._v("XFLAG"),a("OutboundLink")],1)])])]),t._v(" "),a("li",[t._v("Packet filtering\n"),a("ul",[a("li",[a("a",{attrs:{href:"https://cilium.io/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Cilium"),a("OutboundLink")],1)])])]),t._v(" "),a("li",[t._v("Router")])]),t._v(" "),a("h2",{attrs:{id:"アーキテクチャ-仕組み"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#アーキテクチャ-仕組み"}},[t._v("#")]),t._v(" アーキテクチャ(仕組み)")]),t._v(" "),a("p",[t._v("XDPプログラムはC言語として記述し，BPFバイトコードにコンパイルします．\nまた，BPF Verifierによりメモリアクセスやループなどを静的に検査してNICにロードします．")]),t._v(" "),a("p",[t._v("プログラムがアタッチされるとパケットの着信の度にNICのデバイスドライバ内でフックされてプログラムが実行されます．\nそのため"),a("code",[t._v("sk_buff")]),t._v("が生成されるより前の段階でパケットを編集することができます．\n"),a("img",{attrs:{src:"/img/xdp-packet-processing.png",alt:"xdp-packet-processing"}})]),t._v(" "),a("h3",{attrs:{id:"xdp-actions"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#xdp-actions"}},[t._v("#")]),t._v(" XDP Actions")]),t._v(" "),a("p",[t._v("XDPプログラムはそのXDP Actions(終了コード)によってパケットを制御します．\nサポートされているXDP Actionsは以下です．")]),t._v(" "),a("ul",[a("li",[t._v("XDP_PASS\n"),a("ul",[a("li",[t._v("パケットをOSのプロトコルスタックに流す.")])])]),t._v(" "),a("li",[t._v("XDP_DROP\n"),a("ul",[a("li",[t._v("パケットをドロップする.")])])]),t._v(" "),a("li",[t._v("XDP_TX\n"),a("ul",[a("li",[t._v("パケットを受信したNICから送出する．")])])]),t._v(" "),a("li",[t._v("XDP_ABORTED\n"),a("ul",[a("li",[t._v("BPFのエラーを返す際に使用する．パケットはドロップする．")])])]),t._v(" "),a("li",[t._v("XDP_REDIRECT\n"),a("ul",[a("li",[t._v("受信したパケットを"),a("code",[t._v("DEVMAP")]),t._v("に登録されたNICから送出する．")])])])]),t._v(" "),a("h3",{attrs:{id:"bpf-map"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#bpf-map"}},[t._v("#")]),t._v(" BPF Map")]),t._v(" "),a("p",[t._v("BPFプログラムはカーネル内にロードされます．BPFプログラム(カーネル空間)とユーザー空間でデータをやり取りする手段としてBPFマップがあります．")]),t._v(" "),a("p",[a("img",{attrs:{src:"/img/Linux-kernel-eBPF-architecture.png",alt:"Linux-kernel-eBPF-architecture"}})]),t._v(" "),a("p",[t._v("BPFマップは任意の型のKey-Value連想配列です．bpfシステムコールによって作成，値の追加，削除，参照などが行われます．")]),t._v(" "),a("h3",{attrs:{id:"bpf-map-type"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#bpf-map-type"}},[t._v("#")]),t._v(" BPF Map Type")]),t._v(" "),a("p",[t._v("BPFマップはその用途に対して25種類のタイプが存在します．\nユーザーは自身の用途に合わせたマップを使用することができます．\n各タイプは以下のようになっています．")]),t._v(" "),a("ul",[a("li",[t._v("BPF_MAP_TYPE_UNSPEC")]),t._v(" "),a("li",[a("strong",[t._v("BPF_MAP_TYPE_HASH")]),t._v(" "),a("ul",[a("li",[t._v("単純なハッシュ．")])])]),t._v(" "),a("li",[a("strong",[t._v("BPF_MAP_TYPE_ARRAY")]),t._v(" "),a("ul",[a("li",[t._v("単純な配列．要素の削除はできない")])])]),t._v(" "),a("li",[a("strong",[t._v("BPF_MAP_TYPE_PROG_ARRAY")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("tail_call")]),t._v("(詳しくは前エントリ("),a("a",{attrs:{href:"https://terassyi.net/posts/2021/10/07/use-xdpcap.html#%E6%89%8B%E6%B3%95",target:"_blank",rel:"noopener noreferrer"}},[t._v("Goのcilium/ebpfでXdpcapを使う"),a("OutboundLink")],1),t._v("))のジャンプテーブルとして使用される配列")])])]),t._v(" "),a("li",[a("strong",[t._v("BPF_MAP_TYPE_PERF_EVENT_ARRAY")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("bpf_perf_event_output()")]),t._v("の結果が保持される．ユーザースペースのプログラムはそれをpoll()してあげる．")])])]),t._v(" "),a("li",[a("strong",[t._v("BPF_MAP_TYPE_PERCPU_HASH")]),t._v(" "),a("ul",[a("li",[t._v("CPUごとに割り当てられるハッシュ．")])])]),t._v(" "),a("li",[a("strong",[t._v("BPF_MAP_TYPE_PERCPU_ARRAY")]),t._v(" "),a("ul",[a("li",[t._v("CPUごとに割り当てられた配列．")])])]),t._v(" "),a("li",[t._v("BPF_MAP_TYPE_STACK_TRACE")]),t._v(" "),a("li",[t._v("BPF_MAP_TYPE_CGROUP_ARRAY")]),t._v(" "),a("li",[a("strong",[t._v("BPF_MAP_TYPE_LRU_HASH")]),t._v(" "),a("ul",[a("li",[t._v("LRUハッシュ")])])]),t._v(" "),a("li",[a("strong",[t._v("BPF_MAP_TYPE_LRU_PERCPU_HASH")]),t._v(" "),a("ul",[a("li",[t._v("CPUごとのLRUハッシュ")])])]),t._v(" "),a("li",[a("em",[a("strong",[t._v("BPF_MAP_TYPE_LPM_TRIE")])]),t._v(" "),a("ul",[a("li",[t._v("longest-prefixマッチをサポートしたマップ．ルートテーブルなどを作る際に使用する．")])])]),t._v(" "),a("li",[t._v("BPF_MAP_TYPE_ARRAY_OF_MAPS")]),t._v(" "),a("li",[t._v("BPF_MAP_TYPE_HASH_OF_MAPS")]),t._v(" "),a("li",[a("em",[a("strong",[t._v("BPF_MAP_TYPE_DEVMAP")])]),t._v(" "),a("ul",[a("li",[a("code",[t._v("bpf_redirect()")]),t._v("に使用する．NIC間のリダイレクト用．")])])]),t._v(" "),a("li",[t._v("BPF_MAP_TYPE_SOCKMAP")]),t._v(" "),a("li",[t._v("BPF_MAP_TYPE_CPUMAP")]),t._v(" "),a("li",[t._v("BPF_MAP_TYPE_XSKMAP")]),t._v(" "),a("li",[t._v("BPF_MAP_TYPE_SOCKHASH")]),t._v(" "),a("li",[t._v("BPF_MAP_TYPE_CGROUP_STORAGE")]),t._v(" "),a("li",[t._v("BPF_MAP_TYPE_REUSEPORT_SOCKARRAY")]),t._v(" "),a("li",[t._v("BPF_MAP_TYPE_PERCPU_CGROUP_STORAGE")]),t._v(" "),a("li",[t._v("BPF_MAP_TYPE_QUEUE")]),t._v(" "),a("li",[t._v("BPF_MAP_TYPE_STACK")]),t._v(" "),a("li",[t._v("BPF_MAP_TYPE_SK_STORAGE")])]),t._v(" "),a("p",[t._v("たくさんあります．\nしかし，BPF(XDP)を使う際によく使うマップはそんなに種類はなく,"),a("strong",[t._v("太字")]),t._v("にしているものくらいだと思います．")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://blogs.oracle.com/linux/post/bpf-in-depth-communicating-with-userspace",target:"_blank",rel:"noopener noreferrer"}},[t._v("BPF In Depth: Communicating with Userspace"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://man7.org/linux/man-pages/man2/bpf.2.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("bpf(2) - Linux manual page - man7.org"),a("OutboundLink")],1)])]),t._v(" "),a("h3",{attrs:{id:"ヘルパー関数"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ヘルパー関数"}},[t._v("#")]),t._v(" ヘルパー関数")]),t._v(" "),a("p",[t._v("BPFマップの作成や参照，更新は"),a("a",{attrs:{href:"https://man7.org/linux/man-pages/man2/bpf.2.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("bpfシステムコール"),a("OutboundLink")],1),t._v("を呼び出すことで行われます．\n定義は以下です．")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("bpf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" cmd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("union")]),t._v(" bpf_attr "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("attr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("unsigned")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" size"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[a("code",[t._v("linux/bpf.h")]),t._v("をインクルードすると使えるとのことですが，通常の環境では定義がありません．\nそのためbpfシステムコールを直で使うのは結構大変です．")]),t._v(" "),a("p",[t._v("そこで，BPFマップの扱いを簡潔にする"),a("a",{attrs:{href:"https://man7.org/linux/man-pages/man7/bpf-helpers.7.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("ヘルパー関数"),a("OutboundLink")],1),t._v("が用意されています．\nマップの操作に限らず様々なヘルパー関数が定義されています．\nここでは頻繁に使用する関数のみ見ていきます．他の関数が気になる方は"),a("a",{attrs:{href:"https://man7.org/linux/man-pages/man7/bpf-helpers.7.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("man page"),a("OutboundLink")],1),t._v("をのぞいてみてください．")]),t._v(" "),a("h4",{attrs:{id:"マップ関連"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#マップ関連"}},[t._v("#")]),t._v(" マップ関連")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("void *bpf_map_lookup_elem(struct bpf_map *map, const void *key)")]),t._v(" "),a("ul",[a("li",[t._v("keyに対応するvalueを探す")]),t._v(" "),a("li",[t._v("値のポインタがNULLかチェックが必要")])])]),t._v(" "),a("li",[a("code",[t._v("long bpf_map_update_elem(struct bpf_map *map, const void *key, const void *value, u64 flags)")]),t._v(" "),a("ul",[a("li",[t._v("keyに対応するvalueの値を更新する")]),t._v(" "),a("li",[t._v("flagsに渡す値によって値がすでに存在している場合の挙動などを指定する")]),t._v(" "),a("li",[a("code",[t._v("flags = 0")]),t._v("で新規に値を追加できる")])])]),t._v(" "),a("li",[a("code",[t._v("long bpf_map_delete_elem(struct bpf_map *map, const void *key)")]),t._v(" "),a("ul",[a("li",[t._v("keyに対応するエントリを削除する")])])])]),t._v(" "),a("h4",{attrs:{id:"デバッグ"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#デバッグ"}},[t._v("#")]),t._v(" デバッグ")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("long bpf_trace_printk(const char *fmt, u32 fmt_size, ...)")]),t._v(" "),a("ul",[a("li",[t._v("デバッグのためにメッセージを出力する")]),t._v(" "),a("li",[a("code",[t._v("/sys/kernel/debug/tracing/trace_pipe")]),t._v("に出力されるので"),a("code",[t._v("cat")]),t._v("などで読む")])])])]),t._v(" "),a("h4",{attrs:{id:"xdpで使う"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#xdpで使う"}},[t._v("#")]),t._v(" XDPで使う")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("long bpf_fib_lookup(void *ctx, struct bpf_fib_lookup *params, int plen, u32 flags)")]),t._v(" "),a("ul",[a("li",[t._v("FIB(Forwarding Information Base)(ルートテーブル)を参照することができる")]),t._v(" "),a("li",[a("a",{attrs:{href:"https://elixir.bootlin.com/linux/latest/source/include/uapi/linux/bpf.h#L5947",target:"_blank",rel:"noopener noreferrer"}},[t._v("bpf_fib_lookup"),a("OutboundLink")],1),t._v("という構造体を通してルートテーブルを参照して結果を得る")])])]),t._v(" "),a("li",[a("code",[t._v("long bpf_xdp_adjust_head(struct xdp_buff *xdp_md, int delta)")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("xdp_md->data")]),t._v("で得られるパケットの先頭をずらすことができる")]),t._v(" "),a("li",[t._v("encap/decapに使用する")])])])]),t._v(" "),a("h2",{attrs:{id:"generic-xdp"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#generic-xdp"}},[t._v("#")]),t._v(" Generic XDP")]),t._v(" "),a("p",[t._v("前項までで述べたようにXDPはNICのデバイスドライバレベルでパケットを処理します．\nつまり，XDPが有効なNICでなければ使用することができません．\nしかし，このような制限があると気軽にXDPを試すことができません．\nそこでLinux Kernelには"),a("code",[t._v("Generic XDP")]),t._v("という機能がサポートされています．\nこの"),a("code",[t._v("Generic XDP")]),t._v("はXDPの強みである高速さを犠牲にして"),a("code",[t._v("sk_buff")]),t._v("の生成後にXDPプログラムを実行することができるようにしています．\nそのため，NICのサポートの有無を気にすることなくXDPを試すことができます．")]),t._v(" "),a("p",[t._v("入門段階ではほぼすべてのケースで"),a("code",[t._v("Generic XDP")]),t._v("を使用することとなるため以降のサンプルでは"),a("code",[t._v("Generic XDP")]),t._v("を使用します．")]),t._v(" "),a("p",[a("code",[t._v("Generic XDP")]),t._v("の話題は"),a("a",{attrs:{href:"https://yunazuno.hatenablog.com/entry/2017/06/12/094101#f-609aae5d",target:"_blank",rel:"noopener noreferrer"}},[t._v("こちら"),a("OutboundLink")],1),t._v("の記事が詳しいので背景など気になる方はご覧ください．")]),t._v(" "),a("h2",{attrs:{id:"実験環境"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#実験環境"}},[t._v("#")]),t._v(" 実験環境")]),t._v(" "),a("p",[t._v("本記事での実験環境は以下のようになっています．")]),t._v(" "),a("ul",[a("li",[t._v("AWS EC2 instance t3.large")]),t._v(" "),a("li",[t._v("kernel version\n"),a("ul",[a("li",[t._v("5.11.0-1019-aws")])])]),t._v(" "),a("li",[t._v("architecture\n"),a("ul",[a("li",[t._v("x86_64")])])]),t._v(" "),a("li",[t._v("NIC\n"),a("ul",[a("li",[t._v("Elastic Network Adaptor(ENA)")])])]),t._v(" "),a("li",[t._v("os\n"),a("ul",[a("li",[t._v("Ubuntu 20.04.3 LTS")])])]),t._v(" "),a("li",[t._v("clang\n"),a("ul",[a("li",[t._v("10.0.0-4ubuntu")])])]),t._v(" "),a("li",[t._v("iproute2\n"),a("ul",[a("li",[t._v("iproute2-ss200127")])])]),t._v(" "),a("li",[t._v("go\n"),a("ul",[a("li",[t._v("go1.16.7 linux/amd64")])])])]),t._v(" "),a("h2",{attrs:{id:"使い方"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使い方"}},[t._v("#")]),t._v(" 使い方")]),t._v(" "),a("p",[t._v("XDPの使い方を紹介します．\nXDPプログラムを実行するまでの手順は以下です．")]),t._v(" "),a("ol",[a("li",[t._v("XDPが有効なカーネルか確認し依存関係を解決する")]),t._v(" "),a("li",[t._v("C言語(制限付き)でXDPプログラムを記述する")]),t._v(" "),a("li",[a("code",[t._v("clang")]),t._v("でBPFバイトコードにコンパイル")]),t._v(" "),a("li",[t._v("カーネルにロードする")])]),t._v(" "),a("p",[t._v("それぞれを詳しく見ていきましょう.")]),t._v(" "),a("h3",{attrs:{id:"xdpが有効なカーネルであるか確認-依存関係の解決"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#xdpが有効なカーネルであるか確認-依存関係の解決"}},[t._v("#")]),t._v(" XDPが有効なカーネルであるか確認, 依存関係の解決")]),t._v(" "),a("h4",{attrs:{id:"xdpが有効なカーネルか確認"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#xdpが有効なカーネルか確認"}},[t._v("#")]),t._v(" XDPが有効なカーネルか確認")]),t._v(" "),a("p",[t._v("まずはカーネルのバージョンを確認します．\nGeneric XDPが使えるのは"),a("code",[t._v("4.12")]),t._v("以上です．\n"),a("Tweet",{attrs:{id:"1217675419450634240"}}),t._v("\nこのようなツイートもあるのでできるだけ最新に近いカーネルを使うのがよいと思います．\nさらにカーネルのバージョンは要件を満たしていてもXDPを有効化してビルドされたものでなければ動かせません．\n以下の設定が有効になっていることを確認します．")],1),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("CONFIG_BPF=y\nCONFIG_BPF_SYSCALL=y\nCONFIG_BPF_JIT=y\nCONFIG_HAVE_EBPF_JIT=y\nCONFIG_XDP_SOCKETS=y\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br")])]),a("p",[t._v("これらの設定は以下のコマンドで確認します．")]),t._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" -i CONFIG_BPF /boot/config-"),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uname")]),t._v(" -r"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" -i CONFIG_XDP_SOCKETS /boot/config-"),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uname")]),t._v(" -r"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("p",[t._v("その他詳しい機能のサポートバージョンなどは"),a("a",{attrs:{href:"https://medium.com/@christina.jacob.koikara/how-to-compile-a-kernel-with-xdp-support-c245ed3460f1",target:"_blank",rel:"noopener noreferrer"}},[t._v("How to compile a kernel with XDP support"),a("OutboundLink")],1),t._v("をご覧ください．")]),t._v(" "),a("h4",{attrs:{id:"依存関係の解決"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#依存関係の解決"}},[t._v("#")]),t._v(" 依存関係の解決")]),t._v(" "),a("p",[t._v("依存関係のセットアップは"),a("a",{attrs:{href:"https://github.com/xdp-project/xdp-tutorial/blob/master/setup_dependencies.org",target:"_blank",rel:"noopener noreferrer"}},[t._v("xdp tutorialのSetup dependencies"),a("OutboundLink")],1),t._v("をご覧ください．\n各ディストリビューションのインストールについて記載されています．")]),t._v(" "),a("h3",{attrs:{id:"nicの設定"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#nicの設定"}},[t._v("#")]),t._v(" NICの設定")]),t._v(" "),a("p",[a("code",[t._v("Generic XDP")]),t._v("を使用する場合はあまり気にする必要はないですが"),a("code",[t._v("Native XDP")]),t._v("(NICに実際にロードするXDP)を使用する場合mtuやqueueの問題でロードが失敗する可能性があります．\n"),a("a",{attrs:{href:"#%E5%AE%9F%E9%A8%93%E7%92%B0%E5%A2%83"}},[t._v("本実験環境")]),t._v("では以下のコマンドで設定を変更することでNICにXDPをロードすることができました．")]),t._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ip")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("link")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("set")]),t._v(" dev ens5 mtu "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3498")]),t._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ethtool")]),t._v(" -L ens5 combined "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("Tweet",{attrs:{id:"1446513432350519296"}}),t._v(" "),a("h3",{attrs:{id:"c言語-制限付き-でプログラムを記述する"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#c言語-制限付き-でプログラムを記述する"}},[t._v("#")]),t._v(" C言語(制限付き)でプログラムを記述する")]),t._v(" "),a("p",[t._v("C言語でプログラムを記述しますがBPFのプログラムは様々な制約があります．\n主な制約は以下となっています．")]),t._v(" "),a("ul",[a("li",[t._v("命令数の制限\n"),a("ul",[a("li",[t._v("カーネルバージョン5.3以上で1M")])])]),t._v(" "),a("li",[t._v("ループ制限\n"),a("ul",[a("li",[t._v("無限ループは禁止")]),t._v(" "),a("li",[t._v("5.2から有限ループは可能")])])]),t._v(" "),a("li",[t._v("到達不可能な命令があってはいけない")]),t._v(" "),a("li",[t._v("有効なメモリにのみアクセスできる\n"),a("ul",[a("li",[t._v("メモリが有効なものかチェックする必要がある")])])])]),t._v(" "),a("p",[t._v("実際にプログラムを書く際の作法は"),a("a",{attrs:{href:"#bpf-xdp-%E7%94%A8c%E8%A8%80%E8%AA%9E%E3%81%AE%E3%81%8A%E4%BD%9C%E6%B3%95"}},[t._v("実践-BPF(XDP)用C言語のお作法")]),t._v("の項に記述しています．")]),t._v(" "),a("p",[t._v("BPFプログラムの制限に関する資料は以下を参照してください．")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://www.slideshare.net/lcplcp1/introduction-to-ebpf-and-xdp",target:"_blank",rel:"noopener noreferrer"}},[t._v("Introduction to eBPF and XDP"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://www.janog.gr.jp/meeting/janog45/application/files/1615/7984/1029/008_pktfwd-xdp_kusakabe_00.pdf",target:"_blank",rel:"noopener noreferrer"}},[t._v("パケット処理の独自実装や高速化手法の比較と実践"),a("OutboundLink")],1)])]),t._v(" "),a("h3",{attrs:{id:"clangでbpfバイトコードにコンパイルする"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#clangでbpfバイトコードにコンパイルする"}},[t._v("#")]),t._v(" "),a("code",[t._v("clang")]),t._v("でBPFバイトコードにコンパイルする")]),t._v(" "),a("p",[a("code",[t._v("example.c")]),t._v("を"),a("code",[t._v("example.o")]),t._v("に吐き出すコマンドは以下のような感じです．")]),t._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ clang -O2 -target bpf -c example.c -o example.o\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("h3",{attrs:{id:"カーネルにロードする"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#カーネルにロードする"}},[t._v("#")]),t._v(" カーネルにロードする")]),t._v(" "),a("p",[t._v("コンパイルして生成されたELFファイルをカーネルにロードするすることによってXDPが実行されます．\nロードする方法はいくつか存在します．")]),t._v(" "),a("h4",{attrs:{id:"iproute2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#iproute2"}},[t._v("#")]),t._v(" iproute2")]),t._v(" "),a("p",[t._v("最も気軽に利用できるロード方法は"),a("code",[t._v("iproute2")]),t._v("を利用することです．\n"),a("code",[t._v("iproute2")]),t._v("を利用する場合のロードは次のようにします．")]),t._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ip")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("link")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("set")]),t._v(" dev ens5 xdp obj example.o\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("ロード後にNICの情報を見てみると以下のようにxdpプログラムがロードされています．")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("2: ens5: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 3498 xdp qdisc mq state UP mode DEFAULT group default qlen 1000\n    link/ether 0e:66:45:0d:d9:b9 brd ff:ff:ff:ff:ff:ff\n    prog/xdp id 67\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br")])]),a("p",[t._v("XDPプログラムを外す場合は以下のコマンドを実行します．")]),t._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ip")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("link")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("set")]),t._v(" dev ens5 xdp off\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("h4",{attrs:{id:"プログラムからロードする"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#プログラムからロードする"}},[t._v("#")]),t._v(" プログラムからロードする")]),t._v(" "),a("p",[t._v("BPFマップを利用するような複雑なXDPプログラムを実行したい場合，コントロールプレーンとしてプログラムを書く必要があります．\nコントロールプレーンはどの言語でも特に問題ありません．\n本記事ではコントロールプレーンのプログラムにはGo言語を使用します．")]),t._v(" "),a("h2",{attrs:{id:"実践"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#実践"}},[t._v("#")]),t._v(" 実践")]),t._v(" "),a("p",[t._v("本項ではXDPプログラムを実際に書いて動かしてみます．\nGo言語でXDPのコントロールプレーンを記述するパッケージがいくつかあります．")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://github.com/cilium/ebpf",target:"_blank",rel:"noopener noreferrer"}},[t._v("cilium/ebpf"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://github.com/dropbox/goebpf",target:"_blank",rel:"noopener noreferrer"}},[t._v("dropbox/goebpf"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://github.com/iovisor/gobpf",target:"_blank",rel:"noopener noreferrer"}},[t._v("iovisor/gobpf"),a("OutboundLink")],1)])]),t._v(" "),a("p",[t._v("スターの数や開発状況などから見ても"),a("code",[t._v("cilium/ebpf")]),t._v("がデファクトといってよいと思います．\nこれからGo+XDPで開発を行うのであれば"),a("code",[t._v("cilium/ebpf")]),t._v("を使うのがよいでしょう．\n一方で"),a("code",[t._v("dropbox/goebpf")]),t._v("はexamplesにxdpのサンプルがいくつかあり，基本的なプログラムを学ぶには非常によいと思います．\nまた，作りがシンプルなのでとっかかりやすいのではないかと思います．\n"),a("code",[t._v("iovisor/gobpf")]),t._v("は使用したことがないのでわかりませんが"),a("code",[t._v("CGO")]),t._v("という話なのであまりお勧めとは言えません．")]),t._v(" "),a("p",[t._v("いくつかライブラリを紹介しましたが本記事では"),a("code",[t._v("cilium/ebpf")]),t._v("を使用してプログラムを記述します．")]),t._v(" "),a("p",[t._v("今回の実践編のサンプルコードは以下のリポジトリにあります．\n"),a("a",{attrs:{href:"https://github.com/terassyi/go-xdp-examples",target:"_blank",rel:"noopener noreferrer"}},[a("img",{attrs:{src:"https://gh-card.dev/repos/terassyi/go-xdp-examples.svg",alt:"terassyi/go-xdp-examples - GitHub"}}),a("OutboundLink")],1)]),t._v(" "),a("h3",{attrs:{id:"bpf-xdp-用c言語のお作法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#bpf-xdp-用c言語のお作法"}},[t._v("#")]),t._v(" BPF(XDP)用C言語のお作法")]),t._v(" "),a("p",[t._v("BPFバイトコードにコンパイルするC言語は様々な制約があると述べました．\n本項ではその制約について具体的な例を示します．")]),t._v(" "),a("h4",{attrs:{id:"命令数の制約"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#命令数の制約"}},[t._v("#")]),t._v(" 命令数の制約")]),t._v(" "),a("p",[t._v("カーネルバージョン5.3から命令数制限は1Mとなっているので現実的にこの制約が問題となることはないでしょう．\nもし命令数制限を超えるBPFプログラムをロードしたいとき，複数のプログラムに分割，ロードするということになります．\nこれを実現するための手段として"),a("code",[t._v("bpf_tail_call()")]),t._v(", "),a("code",[t._v("BPF_MAP_TYPE_PROG_ARRAY")]),t._v("が用意されています．\n詳しいドキュメントは"),a("a",{attrs:{href:"https://docs.cilium.io/en/stable/bpf/#tail-calls",target:"_blank",rel:"noopener noreferrer"}},[t._v("cilium document - tail-calls"),a("OutboundLink")],1),t._v("をご覧ください．")]),t._v(" "),a("h4",{attrs:{id:"無限ループ禁止"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#無限ループ禁止"}},[t._v("#")]),t._v(" 無限ループ禁止")]),t._v(" "),a("p",[t._v("無限ループは禁止ですが有限ループは可能です．\nXDPではパケットの改変を行うのでチェックサムの計算を行う機会も多いです．\nIPチェックサムを計算する関数を例示します．\nこのコードは"),a("code",[t._v("bufsize")]),t._v("がいずれ必ず1以下となるので有効です．")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("inline")]),t._v(" __u16 "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("checksum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__u16 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("buf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" __u32 bufsize"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t__u32 sum "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bufsize "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tsum "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("buf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\tbuf"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\tbufsize "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bufsize "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tsum "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__u8 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("buf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\tsum "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sum "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0xffff")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sum "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\tsum "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sum "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0xffff")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sum "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("~")]),t._v("sum"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br")])]),a("h4",{attrs:{id:"有効なメモリにのみアクセスする"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#有効なメモリにのみアクセスする"}},[t._v("#")]),t._v(" 有効なメモリにのみアクセスする")]),t._v(" "),a("p",[t._v("BPFプログラムではアクセスしたいメモリが有効であるか明示的にチェックした後でしかアクセスできません．\n頻出する有効メモリチェックを二つ示します．")]),t._v(" "),a("h5",{attrs:{id:"パケットのパース"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#パケットのパース"}},[t._v("#")]),t._v(" パケットのパース")]),t._v(" "),a("p",[t._v("ここで"),a("code",[t._v("data")]),t._v("はNICから受け取ったデータの先頭のポインタ．"),a("code",[t._v("data_end")]),t._v("は末尾のポインタです．\n"),a("code",[t._v("ether")]),t._v("というethernetヘッダ用変数のポインタに"),a("code",[t._v("data")]),t._v("を代入してethernetヘッダをパースします．\nこのとき，ヘッダサイズが"),a("code",[t._v("data_end")]),t._v("を超えている場合無効なメモリにアクセスすることとなるので"),a("code",[t._v("data + sizeof(*ether) > data_end")]),t._v("であることを明示的にチェックしなければなりません．")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("data_end "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("long")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("ctx"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("data_end"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("data "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("long")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("ctx"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ethhdr")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("ether "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sizeof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("ether"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" data_end"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" XDP_ABORTED"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br")])]),a("h5",{attrs:{id:"bpfマップのlookup"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#bpfマップのlookup"}},[t._v("#")]),t._v(" BPFマップのlookup")]),t._v(" "),a("p",[t._v("BPFマップの参照は値が存在しなかった場合NULLとなります．\nそのため，参照結果がNULLでないことをチェックしてから値を使用しなければなりません．")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[t._v("__u32 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("val "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("bpf_map_lookup_elem")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("val"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" XDP_PASS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])]),a("h4",{attrs:{id:"処理を関数に切り分けるときはinline展開する"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#処理を関数に切り分けるときはinline展開する"}},[t._v("#")]),t._v(" 処理を関数に切り分けるときはinline展開する")]),t._v(" "),a("p",[t._v("XDPプログラム本体として実行される以外の自作関数はすべてinline展開される必要があります．\nそのため，自作関数にはすべて"),a("code",[t._v("static inline")]),t._v("をつけましょう．\n"),a("a",{attrs:{href:"#%E7%84%A1%E9%99%90%E3%83%AB%E3%83%BC%E3%83%97%E7%A6%81%E6%AD%A2"}},[t._v("無限ループ禁止")]),t._v("で例示したchecksum()関数を参考にしてください．")]),t._v(" "),a("h4",{attrs:{id:"ebpf組み込み関数しか使えない"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ebpf組み込み関数しか使えない"}},[t._v("#")]),t._v(" eBPF組み込み関数しか使えない")]),t._v(" "),a("p",[a("code",[t._v("memset()")]),t._v(", "),a("code",[t._v("memcpy()")]),t._v("といった関数はllvm組み込みの関数を使用することとなります．")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("__builtin_memset")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dest"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("chr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("__builtin_memcpy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dest"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("src"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("__builtin_memmove")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dest"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("src"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br")])]),a("p",[t._v("とはいえ引数は変わらないので気を付けていれば大丈夫です．")]),t._v(" "),a("h4",{attrs:{id:"グローバル変数が使えない"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#グローバル変数が使えない"}},[t._v("#")]),t._v(" グローバル変数が使えない")]),t._v(" "),a("p",[t._v("グローバル変数は使用できません．\n変わりに毎回BPFマップから値をとってくることとなります．")]),t._v(" "),a("h4",{attrs:{id:"可変長引数を取れない"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#可変長引数を取れない"}},[t._v("#")]),t._v(" 可変長引数を取れない")]),t._v(" "),a("p",[t._v("可変長引数をとる関数を作成・使用することができません．\n例として"),a("code",[t._v("bpf_printk(fmt, ...)")]),t._v("を見てみます．\n"),a("code",[t._v("bpf_printk()")]),t._v("は"),a("code",[t._v("bpf_trace_printk()")]),t._v("を使いやすくラップした関数です．\n定義は以下です．")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token macro-name function"}},[t._v("bpf_printk")]),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fmt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("                                   ")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("                                                           ")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),t._v(" ____fmt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" fmt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("                                      ")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("bpf_trace_printk")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("____fmt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sizeof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("____fmt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("##")]),a("span",{pre:!0,attrs:{class:"token expression"}},[t._v("__VA_ARGS__"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" ")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")])])]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br")])]),a("p",[t._v("以下のように文字列を含めた5つの引数をとらせてみます．")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("test")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("xdp_md")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" d "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("bpf_printk")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"%d %d %d %d"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" d"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" XDP_PASS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br")])]),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ clang -O2 -target bpf -c example.c -o example.o\nexample.c:9:5: error: too many args to 0xb70290: i64 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Constant"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[t._v("6")]),t._v(">")]),t._v("\nint test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("struct xdp_md *ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    ^\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" error generated.\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br")])]),a("p",[t._v("コンパイルすると"),a("code",[t._v("too many args")]),t._v("と怒られます．\nこれを4つ以下の引数にすると無事コンパイルは通ります．\nMACアドレスなどをデバッグ出力したいときに非常に困りますが仕方ありません．気を付けましょう．")]),t._v(" "),a("p",[t._v("その他制約やコンパイル方法などは次のドキュメントが詳しいです．")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://docs.cilium.io/en/stable/bpf/#llvm",target:"_blank",rel:"noopener noreferrer"}},[t._v("cilium docs bpf #llvm"),a("OutboundLink")],1)])]),t._v(" "),a("h3",{attrs:{id:"チュートリアル"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#チュートリアル"}},[t._v("#")]),t._v(" チュートリアル")]),t._v(" "),a("p",[t._v("この項ではチュートリアルとして"),a("a",{attrs:{href:"https://github.com/dropbox/goebpf/tree/master/examples/xdp",target:"_blank",rel:"noopener noreferrer"}},[t._v("dropbox/goebpf/examples/xdp"),a("OutboundLink")],1),t._v("にあるサンプルを"),a("code",[t._v("cilium/ebpf")]),t._v("を用いて動かしてみるということを行います．")]),t._v(" "),a("p",[a("code",[t._v("dropbox/goebpf/examples/xdp")]),t._v("配下には")]),t._v(" "),a("ul",[a("li",[t._v("packet_counter")]),t._v(" "),a("li",[t._v("xdp_dump")]),t._v(" "),a("li",[t._v("basic_firewall")]),t._v(" "),a("li",[t._v("bpf_redirect_map")])]),t._v(" "),a("p",[t._v("の4つのサンプルがあります．\nこちらのC言語で書かれたXDPプログラムは基本的にそのまま使用します.(一部変更しなければ動作しないものがあるため変更します．)")]),t._v(" "),a("h4",{attrs:{id:"構成"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#構成"}},[t._v("#")]),t._v(" 構成")]),t._v(" "),a("p",[t._v("まずディレクトリ構成について軽く述べます．")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/terassyi/go-xdp-examples",target:"_blank",rel:"noopener noreferrer"}},[a("img",{attrs:{src:"https://gh-card.dev/repos/terassyi/go-xdp-examples.svg",alt:"terassyi/go-xdp-examples - GitHub"}}),a("OutboundLink")],1)]),t._v(" "),a("p",[a("code",[t._v("/header/")]),t._v("配下に"),a("code",[t._v("bpf.h")]),t._v(", "),a("code",[t._v("bpf_helpers.h")]),t._v("を配置しています．これはBPFプログラムを記述するためのhelper関数などが定義されたヘッダファイルで，これらを使用することでBPFプログラム記述の負担が軽減されます．\n今回配置しているのは"),a("code",[t._v("dropbox/goebpf/")]),t._v("に置いてあるものになっています．\n様々なBPFプロジェクトが独自のヘッダファイルを使用している場合があり，微妙に定義が異なることもあるので注意してください．")]),t._v(" "),a("p",[t._v("各サンプルのディレクトリの中の"),a("code",[t._v("bpf/")]),t._v("配下にBPFプログラムを配置しています．\n各サンプルのトップにはGoのプログラムが置いてあります．\nビルドなどはこのディレクトリで行います．")]),t._v(" "),a("h4",{attrs:{id:"ビルド"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ビルド"}},[t._v("#")]),t._v(" ビルド")]),t._v(" "),a("p",[t._v("ビルドに必要なステップは二つです．")]),t._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ go generate\n$ go build "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("p",[a("code",[t._v("go generate")]),t._v("によって"),a("code",[t._v("bpf/")]),t._v("配下のC言語のコードをBPFバイトコードにコンパイルしてGoで扱うためのコードを自動生成します．\nこれは"),a("code",[t._v("bpf2go")]),t._v("("),a("a",{attrs:{href:"https://github.com/cilium/ebpf/tree/master/cmd/bpf2go",target:"_blank",rel:"noopener noreferrer"}},[t._v("github.com/cilium/ebpf/cmd/bpf2go"),a("OutboundLink")],1),t._v(")というツールを使用しています．\n"),a("code",[t._v("main.go")]),t._v("の中に"),a("code",[t._v("//go:generate")]),t._v("という感じで記述しておくことでコードを自動生成してくれます．\nこれが最初はとっつきにくいですが慣れると非常に便利です．")]),t._v(" "),a("p",[t._v("後は普通にビルドすることによってシングルバイナリとしてBPFのプログラムを扱うことができます．")]),t._v(" "),a("h4",{attrs:{id:"packet-counter"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#packet-counter"}},[t._v("#")]),t._v(" packet_counter")]),t._v(" "),a("p",[a("code",[t._v("packet_counter")]),t._v("は指定されたNICが受信したパケットをプロトコルごとにカウントするプログラムです．\n"),a("code",[t._v("main.go")]),t._v("と"),a("code",[t._v("bpf/xdp.c")]),t._v("から構成されます．\nそれぞれに分けてみていきます．")]),t._v(" "),a("h5",{attrs:{id:"xdp-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#xdp-2"}},[t._v("#")]),t._v(" XDP")]),t._v(" "),a("p",[t._v("まずはXDPのコードから見ていきましょう．\n最初はヘッダのインクルードと構造体の定義です．\n"),a("code",[t._v("bpf_helpers.h")]),t._v("をインクルードします．\nさらにパケットを表現する構造体を定義します．\nしかし，これは"),a("code",[t._v("linux/if_ether.h")]),t._v("や"),a("code",[t._v("netinet/ip.h")]),t._v("などを使用してもかまいません．")]),t._v(" "),a("p",[t._v("続いてBPFマップを定義します．\npacket_counterでは"),a("code",[t._v("BPF_MAP_TYPE_PERCPU_ARRAY")]),t._v("を定義しています．")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// eBPF map to store IP proto counters (tcp, udp, etc)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("BPF_MAP_DEF")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("protocols"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("map_type "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" BPF_MAP_TYPE_PERCPU_ARRAY"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("key_size "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sizeof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__u32"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("value_size "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sizeof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__u64"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("max_entries "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("255")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("BPF_MAP_ADD")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("protocols"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br")])]),a("p",[t._v("keyは4byte, valueは8byteで定義しています．\n続いてXDP関数です．")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("SEC")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"xdp"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("packet_count")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("xdp_md")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])]),a("p",[a("code",[t._v("xdp")]),t._v("というセクション名を割り当てた関数がパケットの受信の度に呼び出されることとなります．\nこの関数は"),a("code",[t._v("xdp_md")]),t._v("という構造体を引数に取ります．\nの構造体は受信したパケットなどの情報を保持したコンテキストです．\n定義は"),a("a",{attrs:{href:"https://github.com/terassyi/go-xdp-examples/blob/master/header/bpf_helpers.h",target:"_blank",rel:"noopener noreferrer"}},[t._v("header/bpf_helpers.h"),a("OutboundLink")],1),t._v("にあり，以下のようになっています．")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("xdp_md")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  __u32 data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  __u32 data_end"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  __u32 data_meta"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* Below access go through struct xdp_rxq_info */")]),t._v("\n  __u32 ingress_ifindex"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* rxq->dev->ifindex */")]),t._v("\n  __u32 rx_queue_index"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* rxq->queue_index  */")]),t._v("\n\n  __u32 egress_ifindex"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* txq->dev->ifindex */")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br")])]),a("p",[a("code",[t._v("data")]),t._v("が受信したパケットデータの先頭のポインタ，"),a("code",[t._v("data_end")]),t._v("がそのパケットデータの末尾のポインタとなっています．")]),t._v(" "),a("p",[t._v("それでは"),a("code",[t._v("packet_count")]),t._v("の中身を見ていきましょう．\nパケットデータの先頭，末尾のポインタを移動させながらパケットをパースするのでそのための変数"),a("code",[t._v("data")]),t._v(", "),a("code",[t._v("data_end")]),t._v("を定義します．")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("data_end "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("long")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("ctx"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("data_end"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("data "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("long")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("ctx"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("p",[t._v("続いてethernetヘッダをパースします．")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ethhdr")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("ether "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sizeof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("ether"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" data_end"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" XDP_ABORTED"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])]),a("p",[t._v("今回はIPv4プロトコルのみを扱うので"),a("code",[t._v("ether->h_proto")]),t._v("で分岐し，IPv4にマッチした場合のみ以下の処理を実行します．\n"),a("code",[t._v("data")]),t._v("をethernetヘッダのサイズ分ずらすことでIPv4パケットの先頭にポインタを合わせてパースします．\nその後，先ほど定義した"),a("code",[t._v("protocols")]),t._v("マップからIPプロトコルタイプをキーとして値を取り出しインクリメントすることでパケットをカウントします．")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ether"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("h_proto "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x08U")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// htons(ETH_P_IP) -> 0x08U")]),t._v("\n  data "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sizeof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("ether"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("iphdr")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("ip "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sizeof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("ip"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" data_end"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" XDP_ABORTED"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// Increase counter in "protocols" eBPF map')]),t._v("\n  __u32 proto_index "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ip"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("protocol"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  __u64 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("counter "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("bpf_map_lookup_elem")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("protocols"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("proto_index"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("counter"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("counter"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br")])]),a("p",[t._v("最後にパケットをカーネルに流します．")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" XDP_PASS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("h5",{attrs:{id:"go"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#go"}},[t._v("#")]),t._v(" Go")]),t._v(" "),a("p",[t._v("続いてコントロールプレーンのコードを見ていきます．\n"),a("code",[t._v("main.go")]),t._v("に")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("//go:generate go run github.com/cilium/ebpf/cmd/bpf2go -cc clang XdpProg ./bpf/xdp.c -- -I../header\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("と記述することによって"),a("code",[t._v("bpf2go")]),t._v("を"),a("code",[t._v("go generate")]),t._v("で使えるようにしています．")]),t._v(" "),a("p",[t._v("まずbpfプログラムとマップを保持する構造体を定義します．")]),t._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" Collect "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tProg "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("ebpf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Program "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('`ebpf:"packet_count"`')]),t._v("\n\tProtocols "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("ebpf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Map "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('`ebpf:"protocols"`')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])]),a("p",[t._v("それでは"),a("code",[t._v("main")]),t._v("関数の処理を見ていきましょう．\nコマンドライン引数からXDPプログラムをアタッチするインターフェース名を受け取り，そのインターフェースの情報を取得する処理を最初に行っています．\nインターフェース情報の取得などは"),a("a",{attrs:{href:"https://github.com/vishvananda/netlink",target:"_blank",rel:"noopener noreferrer"}},[t._v("vishvananda/netlink"),a("OutboundLink")],1),t._v("を使用します．")]),t._v(" "),a("p",[t._v("前準備が終わると本命のXDP関連の処理となります．\n"),a("code",[t._v("LoadXdpProg()")]),t._v(", "),a("code",[t._v("LoadAdnAssign()")]),t._v("は"),a("code",[t._v("bpf2go")]),t._v("から自動生成されるコードです．\n自動生成されるコードについては今回は詳しく触れません．\n"),a("code",[t._v("bpf2go")]),t._v("を実行する際に引数として渡す値に基づいて"),a("code",[t._v("Load<Name>()")]),t._v("生成されます．(今回の場合"),a("code",[t._v("XdpProg")]),t._v("という値を渡したので"),a("code",[t._v("LoadXdpProg()")]),t._v(")\nこの処理によってXDPのプログラムとマップをロードして"),a("code",[t._v("Collect")]),t._v("構造体にマッピングします．")]),t._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" collect "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("Collect"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nspec"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("LoadXdpProg")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("panic")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" spec"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("LoadAndAssign")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("collect"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("panic")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br")])]),a("p",[t._v("引き続いてNICへのアタッチです．\n"),a("code",[t._v("cilium/ebpf")]),t._v("にはXDPをNICにアタッチするための関数は用意されていないのでnetlink経由でアタッチします．\nnetlinkにはXDPをアタッチする関数として"),a("a",{attrs:{href:"https://pkg.go.dev/github.com/vishvananda/netlink#LinkSetXdpFd",target:"_blank",rel:"noopener noreferrer"}},[t._v("netlink.LinkSetXdpFd()"),a("OutboundLink")],1),t._v("も用意されています．\n今回は明示的に"),a("code",[t._v("Generic XDP")]),t._v("を指定してアタッチするために"),a("a",{attrs:{href:"https://pkg.go.dev/github.com/vishvananda/netlink#LinkSetXdpFdWithFlags",target:"_blank",rel:"noopener noreferrer"}},[t._v("netlink.LinkSetXdpFdWithFlags"),a("OutboundLink")],1),t._v("を使用しています．\n基本的には"),a("code",[t._v("netlink.LinkSetXdpFd()")]),t._v("でアタッチして問題ありません．\nこちらの記事("),a("a",{attrs:{href:"https://yunazuno.hatenablog.com/entry/2017/06/12/094101#f-f6e9ed6b",target:"_blank",rel:"noopener noreferrer"}},[t._v("Generic XDPを使えばXDP動作環境がお手軽に構築できるようになった"),a("OutboundLink")],1),t._v(")にあるようにデフォルトでは"),a("code",[t._v("Native")]),t._v(", "),a("code",[t._v("Generic")]),t._v("の順にアタッチが試行されるようです．\n以前"),a("code",[t._v("XDP_REDIRECT")]),t._v("を使用する際に明示的に"),a("code",[t._v("Generic XDP")]),t._v("を指定しなければパケット転送が動作しないというバグを踏んだことがあったため念のため明示的に"),a("code",[t._v("Generic XDP")]),t._v("を指定しています．")]),t._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" netlink"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("LinkSetXdpFdWithFlags")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("link"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" collect"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Prog"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("FD")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" nl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("XDP_FLAGS_SKB_MODE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("panic")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("defer")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tnetlink"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("LinkSetXdpFdWithFlags")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("link"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" nl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("XDP_FLAGS_SKB_MODE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br")])]),a("p",[t._v("アタッチ関連の処理の後はXDPと連動したパケットカウント処理となります．\n無限ループと"),a("code",[t._v("ticker")]),t._v("による1秒感覚の定期処理の中で以下のような処理を行います．\n"),a("code",[t._v("collect.Protocols.Lookup()")]),t._v("でBPFマップから値を取り出します．\nこの時引数にkey, valueの変数のポインタを渡してあげる必要があります．\n結果としてマップに値があれば"),a("code",[t._v("v")]),t._v("に値が格納されます．\nkeyに対応する値が存在していなくともerrorは返さないのでこのような記述となっています．\nまた，今回定義したBPFマップが"),a("code",[t._v("BPF_MAP_TYPE_PERCPU_ARRAY")]),t._v("なので"),a("code",[t._v("v")]),t._v("は"),a("code",[t._v("[]uint64")]),t._v("型です．\nCPUごとにインデックスされて値が格納されるため，今回の実験環境では要素2のスライスとして値が格納されるのでこのような記述となっています．")]),t._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" v "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint64")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" i "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint32")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" i "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("32")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" collect"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Protocols"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Lookup")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("i"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("v"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("panic")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" v"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tfmt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Printf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"%s : %v"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getProtoName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("i"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" v"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" v"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tfmt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Printf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"%s : %v"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getProtoName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("i"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" v"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br")])]),a("p",[t._v("以上で"),a("code",[t._v("packet_counter")]),t._v("は完成です．\nパケットをカウントする単純な処理しかしていませんが基本的なXDPのアタッチやマップの定義，参照などは他のプロジェクトでも大体同じ感じです．")]),t._v(" "),a("h5",{attrs:{id:"実行"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#実行"}},[t._v("#")]),t._v(" 実行")]),t._v(" "),a("p",[t._v("ビルドして実行してみます．\n実験環境は"),a("code",[t._v("netns.sh")]),t._v("を使用して作成します．\nネットワーク構成は以下のような感じです．")]),t._v(" "),a("p",[a("img",{attrs:{src:"/img/xdp-example-network-1.png",alt:"xdp-example-network-1"}})]),t._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" ./netns.sh build\n$ go generate\n$ go build "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br")])]),a("p",[t._v("では動かしてみましょう．\nXDPプログラムは"),a("code",[t._v("node1")]),t._v("のnetnsで動かします．")]),t._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ip")]),t._v(" netns "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exec")]),t._v(" node1 ./packet_counter -iface veth1\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("コンソールが返ってこなければ正常に起動しているはずです．\n別のターミナルを起動して"),a("code",[t._v("veth1")]),t._v("のアドレス"),a("code",[t._v("192.168.0.2")]),t._v("に対して"),a("code",[t._v("ping")]),t._v("を飛ばしてみましょう．")]),t._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ping")]),t._v(" -c "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".0.2\nPING "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".0.2 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".0.2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("56")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("84")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" bytes of data.\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v(" bytes from "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".0.2: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("icmp_seq")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ttl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("time")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.052")]),t._v(" ms\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v(" bytes from "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".0.2: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("icmp_seq")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ttl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("time")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.050")]),t._v(" ms\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v(" bytes from "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".0.2: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("icmp_seq")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ttl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("time")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.049")]),t._v(" ms\n\n--- "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".0.2 "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ping")]),t._v(" statistics ---\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" packets transmitted, "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" received, "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("% packet loss, "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("time")]),t._v(" 2033ms\nrtt min/avg/max/mdev "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.049")]),t._v("/0.050/0.052/0.001 ms\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br")])]),a("p",[t._v("このように応答がかえってくるはずです．\nでは"),a("code",[t._v("packet_counter")]),t._v("の画面をみてみます．")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("IPPROTO_ICMP : 3\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("このようにICMPパケットが3つカウントされていることがわかります．\nプロトコルごとにカウントするのでTCPやUDPでも試してみてください．")]),t._v(" "),a("p",[t._v("実験が終了したらnetnsの後片付けをしておきましょう．")]),t._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" ./netns.sh clean\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("h4",{attrs:{id:"xdp-dump"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#xdp-dump"}},[t._v("#")]),t._v(" xdp_dump")]),t._v(" "),a("p",[a("code",[t._v("xdp_dump")]),t._v("はTCPパケットをキャプチャしてダンプするプログラムです．\n"),a("code",[t._v("main.go")]),t._v("と"),a("code",[t._v("bpf/xdp_dump.c")]),t._v("から構成されます．\n先ほどと同様にXDPとGoに分けてみていきましょう．")]),t._v(" "),a("h5",{attrs:{id:"xdp-3"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#xdp-3"}},[t._v("#")]),t._v(" XDP")]),t._v(" "),a("p",[t._v("まずはXDPからです．\nヘッダのインクルードや構造体定義のやり方は"),a("a",{attrs:{href:"#xdp-2"}},[t._v("packet_counter")]),t._v("と同様です．\n今回は"),a("code",[t._v("BPF_MAP_TYPE_PERF_EVENT_ARRAY")]),t._v("を使用します．")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("BPF_MAP_DEF")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("perfmap"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("map_type "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" BPF_MAP_TYPE_PERF_EVENT_ARRAY"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("max_entries "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("128")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("BPF_MAP_ADD")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("perfmap"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br")])]),a("p",[t._v("さらに"),a("code",[t._v("perf_event_item")]),t._v("という"),a("code",[t._v("perfmap")]),t._v("に格納する構造体を定義しておきます．")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("perf_event_item")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  __u32 src_ip"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dst_ip"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  __u16 src_port"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dst_port"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])]),a("p",[t._v("続いてXDP関数の処理を見ていきます．\n"),a("code",[t._v("xdp_dump")]),t._v("という名前で定義しています．\nEthernetヘッダやIPv4ヘッダのパースは"),a("a",{attrs:{href:"#xdp-2"}},[t._v("packet_counter")]),t._v("と同様です．\n今回はTCPヘッダもパースするのでその処理を以下に抜粋します．\n基本的にやり方は変わりませんが，IPv4ヘッダは可変長なので"),a("code",[t._v("ip->ihl * 4")]),t._v("でヘッダ長を計算して加算してあげる必要があります．")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[t._v("data "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),t._v(" ip"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("ihl "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("tcphdr")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("tcp "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sizeof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("tcp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" data_end"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" XDP_ABORTED"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br")])]),a("p",[t._v("その後は"),a("code",[t._v("SYN")]),t._v("フラグがついたパケットのみを対象としてperf eventを発火させます．\n"),a("code",[t._v("packet_size")]),t._v("はあらかじめ"),a("code",[t._v("data - data_end")]),t._v("で求めています．\nプログラム中のコメントにある通り，"),a("code",[t._v("flags")]),t._v("にはCPUのIDと"),a("code",[t._v("ctx(xdp_md struct)")]),t._v("の使用する範囲を指定した値をいれています．")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tcp"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("syn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("perf_event_item")]),t._v(" evt "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("src_ip "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ip"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("saddr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dst_ip "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ip"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("daddr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("src_port "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tcp"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("source"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dst_port "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tcp"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("dest"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// flags for bpf_perf_event_output() actually contain 2 parts (each 32bit long):")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// bits 0-31: either")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// - Just index in eBPF map")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// or")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// - "BPF_F_CURRENT_CPU" kernel will use current CPU_ID as eBPF map index')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// bits 32-63: may be used to tell kernel to amend first N bytes")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// of original packet (ctx) to the end of the data.")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// So total perf event length will be sizeof(evt) + packet_size")]),t._v("\n  __u64 flags "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" BPF_F_CURRENT_CPU "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("packet_size "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("32")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("bpf_perf_event_output")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("perfmap"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" flags"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("evt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sizeof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("evt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br")])]),a("p",[t._v("その後は"),a("code",[t._v("XDP_PASS")]),t._v("して終了です．")]),t._v(" "),a("h5",{attrs:{id:"go-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#go-2"}},[t._v("#")]),t._v(" Go")]),t._v(" "),a("p",[t._v("続いてGoのプログラムを見ていきます．\nコマンドライン引数のパース，XDPプログラムやマップのロード，アタッチは"),a("a",{attrs:{href:"#xdp-2"}},[t._v("packet_counter")]),t._v("と変わらないので省略して"),a("code",[t._v("perf event")]),t._v("の取り扱いを見ていきます．\nXDP側で定義したものと同じフィールドを持つ"),a("code",[t._v("perfEventItem")]),t._v("構造体を定義しておきます．")]),t._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" perfEventItem "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tSrcIp "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint32")]),t._v("\n\tDstIp "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint32")]),t._v("\n\tSrcPort "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint16")]),t._v("\n\tDstPort "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint16")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br")])]),a("p",[t._v("次に"),a("code",[t._v("perf event")]),t._v("を読むためのReaderを生成します．")]),t._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[t._v("perfEvent"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" perf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("NewReader")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("collect"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("PerfMap"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4096")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[a("code",[t._v("goroutine")]),t._v("で起動している部分が"),a("code",[t._v("perf event")]),t._v("をハンドリングする処理部です．\n"),a("code",[t._v("perfEvent.Read()")]),t._v("でeventをpollして読み込みます．\n無事読み込みが終了した場合"),a("code",[t._v("event.RawSample")]),t._v("に格納されたバイト列を"),a("code",[t._v("binary.Read()")]),t._v("で"),a("code",[t._v("perfEventItem")]),t._v("構造体にパースします．\nさらに，"),a("code",[t._v("event.RawSample")]),t._v("が"),a("code",[t._v("perfEventItem")]),t._v("の大きさ(METADATA_SIZE = 12として定義している)よりも大きければパケットデータをダンプしてあげています．")]),t._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("go")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" event perfEventItem\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tevnt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" perfEvent"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Read")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" errors"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Unwrap")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" perf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ErrClosed "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("break")]),t._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("panic")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t\treader "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" bytes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("NewReader")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("evnt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("RawSample"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" binary"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Read")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("reader"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" binary"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("LittleEndian"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("event"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("panic")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t\tfmt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Printf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"TCP: %v:%d -> %v:%d\\n"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("intToIpv4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("event"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("SrcIp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ntohs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("event"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("SrcPort"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("intToIpv4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("event"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DstIp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ntohs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("event"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DstPort"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("len")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("evnt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("RawSample"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" METADATA_SIZE "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\tfmt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Println")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hex"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Dump")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("evnt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("RawSample"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("METADATA_SIZE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t\treceived "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("len")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("evnt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("RawSample"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\tlost "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("int")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("evnt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("LostSamples"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br")])]),a("p",[a("code",[t._v("xdp_dump")]),t._v("では"),a("code",[t._v("perf event")]),t._v("を使用したためイベント駆動で処理することができました．")]),t._v(" "),a("h5",{attrs:{id:"実行-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#実行-2"}},[t._v("#")]),t._v(" 実行")]),t._v(" "),a("p",[t._v("それでは動かしてみます．\n今回も"),a("code",[t._v("netns.sh")]),t._v("で実験環境を作ってプログラムをビルドします．")]),t._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ go generate\n$ go build "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" ./netns.sh build\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br")])]),a("p",[t._v("続いて"),a("code",[t._v("node1")]),t._v("の中で"),a("code",[t._v("xdp_dump")]),t._v("を起動しましょう．\n起動すると以下のようにTCPのSYNパケットを待ちます．")]),t._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ip")]),t._v(" netns "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exec")]),t._v(" node1 ./xdp_dump -iface veth1\nAll new TCP connection requests "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("SYN"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" coming to this "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("host")]),t._v(" will be dumped here.\n\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br")])]),a("p",[t._v("今回はTCPパケットを扱うので別のターミナルでpythonをつかってHTTPサーバを起動してそこにアクセスしてみます．")]),t._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ip")]),t._v(" netns "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exec")]),t._v(" node1 python3 -m http.server "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8888")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("もう一つターミナルを開いて"),a("code",[t._v("curl")]),t._v("でHTTPサーバにアクセスしてみましょう．")]),t._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" http://192.168.0.2:8888\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("通常通りレスポンスが返ってくると思います．\nまた，"),a("code",[t._v("xdp_dump")]),t._v("を動かしているターミナルではTCP(SYN)パケットがダンプされていると思います．")]),t._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("All new TCP connection requests "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("SYN"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" coming to this "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("host")]),t._v(" will be dumped here.\n\nTCP: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".0.3:43910 -"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".0.2:8888\n00000000  e2 f7 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("28")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("dc")]),t._v(" a0 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("65")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),t._v(" 4b  fe 5b "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("20")]),t._v(" 08 00 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("45")]),t._v(" 00  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v("e.K."),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("d "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v("E."),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n00000010  00 3c "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("93")]),t._v(" c9 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("40")]),t._v(" 00 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("40")]),t._v(" 06  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("25")]),t._v(" 9d c0 a8 00 03 c0 a8  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("."),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v("@.@.%"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v("."),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n00000020  00 02 ab "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("86")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("22")]),t._v(" b8 9c "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("36")]),t._v("  ba "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("88")]),t._v(" 00 00 00 00 a0 02  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v('"'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n00000030  fa f0 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("81")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("84")]),t._v(" 00 00 02 04  05 b4 04 02 08 0a f4 c8  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n00000040  ac 0b 00 00 00 00 01 03  03 07 00 00 00 00 00 00  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br")])]),a("p",[t._v("実験が終わったらnetnsを削除しておきましょう．")]),t._v(" "),a("h4",{attrs:{id:"basic-firewall"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#basic-firewall"}},[t._v("#")]),t._v(" basic_firewall")]),t._v(" "),a("p",[t._v("3つめのサンプルは"),a("code",[t._v("basic_firewall")]),t._v("です．\nIPv4ネットワークを入力として与えることで該当した宛先からのパケットをドロップします．\n"),a("code",[t._v("basic_firewall")]),t._v("配下の"),a("code",[t._v("main.go")]),t._v("と"),a("code",[t._v("bpf/xdp_fw.c")]),t._v("から構成されます．\nこれまでと同様にXDPとGoに分けて見ていきましょう．")]),t._v(" "),a("h5",{attrs:{id:"xdp-4"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#xdp-4"}},[t._v("#")]),t._v(" XDP")]),t._v(" "),a("p",[t._v("これまでのサンプルと同様にヘッダのインクルードと構造体の定義を行います．\nその後BPFマップの定義を行います．\n今回はふたつのマップを定義します．タイプはそれぞれ"),a("code",[t._v("BPF_MAP_TYPE_PERCPU_ARRAY")]),t._v(", "),a("code",[t._v("BPF_MAP_TYPE_LPM_TRIE")]),t._v("です．")]),t._v(" "),a("p",[a("code",[t._v("matches")]),t._v("は通常のArrayです．\n入力したルール(IPv4ネットワーク)にマッチしたパケットをカウントするためのマップです．")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("BPF_MAP_DEF")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("matches"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("map_type "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" BPF_MAP_TYPE_PERCPU_ARRAY"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("key_size "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sizeof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__u32"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("value_size "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sizeof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__u64"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("max_entries "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" MAX_RULES"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("BPF_MAP_ADD")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("matches"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br")])]),a("p",[a("code",[t._v("blacklist")]),t._v("は入力されたルールを保持するマップです．\n"),a("code",[t._v("lpm trie")]),t._v("という特殊なマップとして定義します．\n"),a("code",[t._v("lpm trie")]),t._v("は"),a("a",{attrs:{href:"https://www.lewuathe.com/longest-prefix-match-with-trie-tree.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Longest Prefix Match with Trie Tree"),a("OutboundLink")],1),t._v("を意味しています．\nルートテーブルなどを作成する際に使用します．\nIPv4アドレスとプレフィックスをキー，任意の値をバリューとして保存して使用します．")]),t._v(" "),a("p",[t._v("今回マップの定義にて"),a("code",[t._v("BPF_F_NO_PREALLOC")]),t._v("を指定しています．\n"),a("code",[t._v("BPF_F_NO_PREALLOC")]),t._v("はプリアロケーションによるオーバーヘッドを削減するためのフラグです．\n詳細は以下のリンクを参照してください．")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://pingcap.com/blog/tips-and-tricks-for-writing-linux-bpf-applications-with-libbpf#reduce-pre-allocation-overhead",target:"_blank",rel:"noopener noreferrer"}},[t._v("Reduce pre-allocation overhead"),a("OutboundLink")],1)])]),t._v(" "),a("p",[t._v("今回のサンプルではこのフラグを指定しなければBPFマップ作成が"),a("code",[t._v("Invalid argument")]),t._v("で失敗してしまいました．\nこれは"),a("a",{attrs:{href:"https://github.com/dropbox/goebpf/blob/master/examples/xdp/basic_firewall/ebpf_prog/xdp_fw.c#L46",target:"_blank",rel:"noopener noreferrer"}},[t._v("dropbox/goebpfのサンプル"),a("OutboundLink")],1),t._v("では指定されなくても動作していました．\n一方今回"),a("code",[t._v("cilium/ebpf")]),t._v("を使用した際は与える必要がありました．\n同様のエラーに遭遇した方は参考にしてください．")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("BPF_MAP_DEF")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("blacklist"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("map_type "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" BPF_MAP_TYPE_LPM_TRIE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("key_size "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sizeof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__u64"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("value_size "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sizeof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__u32"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("max_entries "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" MAX_RULES"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("map_flags "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" BPF_F_NO_PREALLOC"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("BPF_MAP_ADD")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("blacklist"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br")])]),a("p",[t._v("さて，マップの定義が終わったのでXDP関数の処理を見ていきます．今回は"),a("code",[t._v("firewall")]),t._v("という関数名です．\nまずはこれまで通りEthernet, IPv4パケットのパースを行います．")]),t._v(" "),a("p",[t._v("その後，"),a("code",[t._v("blacklist")]),t._v("を参照するための"),a("code",[t._v("key")]),t._v("を作成します．\n"),a("code",[t._v("key")]),t._v("はプレフィックスとアドレスのフィールドを持っています．")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  __u32 prefixlen"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  __u32 saddr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("prefixlen "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("32")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nkey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("saddr "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ip"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("saddr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br")])]),a("p",[t._v("以下がメインの処理部です．\n先ほど用意した"),a("code",[t._v("key")]),t._v("で"),a("code",[t._v("blacklist")]),t._v("をlookupしてルールにマッチした場合"),a("code",[t._v("matches")]),t._v("からもカウンタを取り出してインクリメントしています．\nその後，"),a("code",[t._v("XDP_DROP")]),t._v("を返すことでパケットをドロップします．\nマッチしなかった場合は単に"),a("code",[t._v("XDP_PASS")]),t._v("を返します．")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[t._v("__u64 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("rule_idx "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("bpf_map_lookup_elem")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("blacklist"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rule_idx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// Matched, increase match counter for matched "rule"')]),t._v("\n  __u32 index "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__u32"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("rule_idx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// make verifier happy")]),t._v("\n  __u64 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("counter "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("bpf_map_lookup_elem")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("matches"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("index"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("counter"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("counter"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" XDP_DROP"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" XDP_PASS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br")])]),a("h5",{attrs:{id:"go-3"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#go-3"}},[t._v("#")]),t._v(" Go")]),t._v(" "),a("p",[t._v("次はコントロールプレーンを見ていきます．\nコマンドライン引数のパースやXDPプログラムのロードとアタッチはこれまでと同様です．\n今回は入力としてドロップするルールを渡します．\nまた，"),a("code",[t._v("lpm trie")]),t._v("を使用するので"),a("code",[t._v("lpmTrieKey")]),t._v("という型を用意しておきます．")]),t._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" lpmTrieKey "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tprefixlen "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint32")]),t._v("\n\taddr "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint32")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])]),a("p",[t._v("この型を使用して入力されたドロップルールを"),a("code",[t._v("blacklist")]),t._v("に挿入します．")]),t._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" index"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ip "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("range")]),t._v(" ipList "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tfmt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Printf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"\\t%s\\n"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ip"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tk "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ipNetToUint64")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("createLPMTrieKey")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ip"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" collect"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Blacklist"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Put")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("k"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uint32")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("index"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("panic")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br")])]),a("p",[t._v("以下はパケットのカウントを表示する部分です"),a("code",[t._v("packet_counter")]),t._v("で出てきたものとほぼ同じです．\n"),a("code",[t._v("ticker")]),t._v("で定期的に処理しています．")]),t._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("select")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<-")]),t._v("ticker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("C"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" v "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint64")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" i "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint32")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" i "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uint32")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("len")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ipList"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" collect"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Matches"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Lookup")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("i"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("v"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("panic")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" v"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t\tfmt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Printf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"%18s\\t%d\\n"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ipList"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("i"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" v"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" v"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t\tfmt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Printf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"%18s\\t%d\\n"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ipList"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("i"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" v"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t\tfmt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Println")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<-")]),t._v("ctrlC"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t\tfmt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Println")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"\\nDetaching program and exit"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br")])]),a("p",[a("code",[t._v("basic_firewall")]),t._v("は"),a("code",[t._v("BPF_MAP_TYPE_LPM_TRIE")]),t._v("を利用することで簡単にIPアドレスがルールにマッチするかどうかを判断することができました．")]),t._v(" "),a("h5",{attrs:{id:"実行-3"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#実行-3"}},[t._v("#")]),t._v(" 実行")]),t._v(" "),a("p",[t._v("それでは動かしてみます．\n今回もこれまでと同様に"),a("code",[t._v("netns")]),t._v("で実験環境を用意します．")]),t._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ go generate\n$ go build "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" ./netns.sh build\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br")])]),a("p",[t._v("では"),a("code",[t._v("basic_firewall")]),t._v("を起動しましょう．今回は以下のように"),a("code",[t._v("192.168.0.0/24")]),t._v("をブロックするように指定して実行します．")]),t._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ip")]),t._v(" netns "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exec")]),t._v(" node1 ./basic_firewall -iface veth1 -drop "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".0.0/24\nBlacklisting IPv4 Addresses"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".0.0/24\n\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])]),a("p",[t._v("それでは別のターミナルから"),a("code",[t._v("ping")]),t._v("を飛ばしてみましょう．\n"),a("code",[t._v("192.168.0.3 -> 192.168.0.2")]),t._v("向けのパケットが飛ぶはずなのでこれは"),a("code",[t._v("basic_firewall")]),t._v("を動かしている間はレスポンスがないはずです．")]),t._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ping")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".0.2\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("というわけで"),a("code",[t._v("basic_firewall")]),t._v("を動かしているターミナルに戻ってみます．")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("Blacklisting IPv4 Addresses...\n        192.168.0.0/24\n\n    192.168.0.0/24      1\n\n    192.168.0.0/24      2\n\n    192.168.0.0/24      3\n\n    192.168.0.0/24      4\n\n    192.168.0.0/24      5\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br")])]),a("p",[t._v("このようにブロックしたパケットをカウントして出力されています．\n"),a("code",[t._v("Crtl + c")]),t._v("でプログラムを終了させると"),a("code",[t._v("ping")]),t._v("の応答が返ってくるようになることを確認してください．")]),t._v(" "),a("p",[t._v("実験が終了したら"),a("code",[t._v("netns")]),t._v("を掃除しておきましょう．")]),t._v(" "),a("h4",{attrs:{id:"bpf-redirect-map"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#bpf-redirect-map"}},[t._v("#")]),t._v(" bpf_redirect_map")]),t._v(" "),a("p",[t._v("4つめのサンプルは"),a("code",[t._v("bpf_redirect_map")]),t._v("です．\nこのサンプルはICPMパケットを対象にICMPパケットの送信者にリダイレクトするというものとなっています．\n"),a("code",[t._v("bpf_redirect_map")]),t._v("配下の"),a("code",[t._v("main.go")]),t._v("と"),a("code",[t._v("bpf/xdp.c")]),t._v("から構成されます．\nこれまでと同様にXDPとGoに分けて見ていきましょう．")]),t._v(" "),a("h5",{attrs:{id:"xdp-5"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#xdp-5"}},[t._v("#")]),t._v(" XDP")]),t._v(" "),a("p",[t._v("これまでのサンプルと同様にヘッダのインクルードと構造体の定義を行います．\nその後BPFマップの定義を行います．")]),t._v(" "),a("p",[t._v("今回は"),a("code",[t._v("BPF_MAP_TYPE_DEVMAP")]),t._v("というタイプのマップを使用します．\nこのマップは"),a("code",[t._v("bpf_redirect()")]),t._v(", "),a("code",[t._v("bpf_redirect_map()")]),t._v("を使用するためにデバイスのインデックスを保持しておくマップです．")]),t._v(" "),a("p",[t._v("こちらも少しハマりどころがあり，"),a("a",{attrs:{href:"https://github.com/dropbox/goebpf/blob/master/examples/xdp/bpf_redirect_map/ebpf_prog/xdp.c#L44",target:"_blank",rel:"noopener noreferrer"}},[t._v("dropbox/goebpfのサンプル"),a("OutboundLink")],1),t._v("では"),a("code",[t._v("max_entries")]),t._v("の値が"),a("code",[t._v("64")]),t._v("となっていますが"),a("code",[t._v("cilium/ebpf")]),t._v("を使用した場合マップに値を入れるときに"),a("code",[t._v("panic: update failed: key too big for map: argument list too long")]),t._v("と怒られます．\nですので今回は"),a("code",[t._v("1024")]),t._v("という大きめの数字を使用しています．")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* XDP enabled TX ports for redirect map */")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("BPF_MAP_DEF")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("if_redirect"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("map_type "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" BPF_MAP_TYPE_DEVMAP"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("key_size "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sizeof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__u32"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("value_size "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sizeof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__u32"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("max_entries "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1024")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("BPF_MAP_ADD")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("if_redirect"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br")])]),a("p",[t._v("次にXDP関数を見ていきます．\n関数名は"),a("code",[t._v("xdp_test")]),t._v("です．\nこれまで通りEthernet, IPv4パケットにパースします．\nさらに，IPパケットのプロトコルをみてICMPでなければPASSします．")]),t._v(" "),a("p",[t._v("続いて，ルートテーブルのlookup処理です．\nXDPではカーネルのルートテーブルを参照することができます．\n参照のためには")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("bpf_fib_lookup"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" plen"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" __u32 flags"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// NOLINT")]),t._v("\n     BPF_FUNC_fib_lookup"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("p",[t._v("という関数を使用します．\nこの"),a("code",[t._v("bpf_fib_lookup()")]),t._v("に渡す"),a("code",[t._v("bpf_fib_lookup")]),t._v("構造体の定義について確認します．")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("bpf_fib_lookup")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* input:  network family for lookup (AF_INET, AF_INET6)\n  * output: network family of egress nexthop\n  */")]),t._v("\n  __u8\tfamily"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* set if lookup is to consider L4 data - e.g., FIB rules */")]),t._v("\n  __u8\tl4_protocol"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  __be16\tsport"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  __be16\tdport"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* total length of packet from network header - used for MTU check */")]),t._v("\n  __u16\ttot_len"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* input: L3 device index for lookup\n  * output: device index from FIB lookup\n  */")]),t._v("\n  __u32\tifindex"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("union")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* inputs to lookup */")]),t._v("\n    __u8\ttos"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* AF_INET  */")]),t._v("\n    __be32\tflowinfo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* AF_INET6, flow_label + priority */")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* output: metric of fib result (IPv4/IPv6 only) */")]),t._v("\n    __u32\trt_metric"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("union")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    __be32\t\tipv4_src"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    __u32\t\tipv6_src"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* in6_addr; network order */")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* input to bpf_fib_lookup, ipv{4,6}_dst is destination address in\n  * network header. output: bpf_fib_lookup sets to gateway address\n  * if FIB lookup returns gateway route\n  */")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("union")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    __be32\t\tipv4_dst"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    __u32\t\tipv6_dst"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* in6_addr; network order */")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* output */")]),t._v("\n  __be16\th_vlan_proto"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  __be16\th_vlan_TCI"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  __u8\tsmac"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("     "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* ETH_ALEN */")]),t._v("\n  __u8\tdmac"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("     "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* ETH_ALEN */")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br"),a("span",{staticClass:"line-number"},[t._v("32")]),a("br"),a("span",{staticClass:"line-number"},[t._v("33")]),a("br"),a("span",{staticClass:"line-number"},[t._v("34")]),a("br"),a("span",{staticClass:"line-number"},[t._v("35")]),a("br"),a("span",{staticClass:"line-number"},[t._v("36")]),a("br"),a("span",{staticClass:"line-number"},[t._v("37")]),a("br"),a("span",{staticClass:"line-number"},[t._v("38")]),a("br"),a("span",{staticClass:"line-number"},[t._v("39")]),a("br"),a("span",{staticClass:"line-number"},[t._v("40")]),a("br"),a("span",{staticClass:"line-number"},[t._v("41")]),a("br"),a("span",{staticClass:"line-number"},[t._v("42")]),a("br"),a("span",{staticClass:"line-number"},[t._v("43")]),a("br"),a("span",{staticClass:"line-number"},[t._v("44")]),a("br"),a("span",{staticClass:"line-number"},[t._v("45")]),a("br"),a("span",{staticClass:"line-number"},[t._v("46")]),a("br"),a("span",{staticClass:"line-number"},[t._v("47")]),a("br"),a("span",{staticClass:"line-number"},[t._v("48")]),a("br")])]),a("p",[t._v("ご覧のようにかなりいろいろなフィールドが定義されています．\nしかし，単なるIPv4ルートテーブルを参照するだけであればそこまで大変ではありません．\nセットするフィールドは以下です．")]),t._v(" "),a("ul",[a("li",[t._v("family")]),t._v(" "),a("li",[t._v("ipv4_src")]),t._v(" "),a("li",[t._v("ipv4_dst")]),t._v(" "),a("li",[t._v("ifindex")])]),t._v(" "),a("p",[t._v("これらのフィールドをIPパケットとingressのifindexをもとにセットし，"),a("code",[t._v("bpf_fib_lookup()")]),t._v("に渡します．\nその結果がfailedでなく"),a("code",[t._v("no neigh")]),t._v("でなければルートが引けたことになるのでその結果が引数として渡した"),a("code",[t._v("fib_params")]),t._v("に格納されます．")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("bpf_fib_lookup")]),t._v(" fib_params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// fill struct with zeroes, so we are sure no data is missing")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("__builtin_memset")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("fib_params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sizeof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fib_params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nfib_params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("family\t"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" AF_INET"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// use daddr as source in the lookup, so we refleect packet back (as if it wcame from us)")]),t._v("\nfib_params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ipv4_src\t"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ip_header"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("daddr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// opposite here, the destination is the source of the icmp packet..remote end")]),t._v("\nfib_params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ipv4_dst\t"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ip_header"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("saddr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nfib_params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ifindex "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ctx"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v("ingress_ifindex"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("bpf_printk")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"doing route lookup dst: %d\\n"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" fib_params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ipv4_dst"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" rc "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("bpf_fib_lookup")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("fib_params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sizeof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fib_params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rc "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" BPF_FIB_LKUP_RET_SUCCESS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rc "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" BPF_FIB_LKUP_RET_NO_NEIGH"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("bpf_printk")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Dropping packet\\n"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" XDP_DROP"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rc "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" BPF_FIB_LKUP_RET_NO_NEIGH"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// here we should let packet pass so we resolve arp.")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("bpf_printk")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Passing packet, lookup returned %d\\n"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" BPF_FIB_LKUP_RET_NO_NEIGH"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" XDP_PASS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br")])]),a("p",[t._v("ルートが引けたらリダイレクト処理を行います．\nIPパケットの宛先と送信元を入れ替えます．\nさらに"),a("code",[t._v("fib_params")]),t._v("に格納された"),a("code",[t._v("dmac")]),t._v("と"),a("code",[t._v("smac")]),t._v("をパケットに上書きします．\nそして，")]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("bpf_redirect_map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" __u32 key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" __u64 flags"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// NOLINT")]),t._v("\n     BPF_FUNC_redirect_map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("p",[t._v("を実行してリダイレクトします．\n引数には定義したDEVMAPである"),a("code",[t._v("if_redirect")]),t._v(", それをlookupするキーとしてのifindex, flagは0です．")]),t._v(" "),a("p",[t._v("これによりICMPパケットを送信元にそのままリダイレクトします．")]),t._v(" "),a("h5",{attrs:{id:"go-4"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#go-4"}},[t._v("#")]),t._v(" Go")]),t._v(" "),a("p",[t._v("続いてGoのコントロールプレーンをみていきます．\nコマンドライン引数のパースやXDPプログラムのロードとアタッチはこれまでと同様です．\n今回はNICを二つ引数として渡してあげます．\n"),a("code",[t._v("bpf2go")]),t._v("で自動生成した関数を用いたプログラムのロードはれまでと同様です．\n今回のリダイレクトのプログラムは二つのNICにアタッチしなければなりません．\nさらに，アタッチするNICのインデックスを"),a("code",[t._v("DEVMAP")]),t._v("に登録する必要があります．\nそこで以下のように"),a("code",[t._v("Attach()")]),t._v("関数を作成して上記の操作をまとめてしまいます．")]),t._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Attach")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("infList "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" prog "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("ebpf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Program"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ifRedirect "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("ebpf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("_")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" inf "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("range")]),t._v(" infList "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tlink"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" netlink"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("LinkByName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("inf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" err\n\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" netlink"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("LinkSetXdpFdWithFlags")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("link"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" prog"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("FD")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" nl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("XDP_FLAGS_SKB_MODE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" err\n\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" ifRedirect"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Put")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uint32")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("link"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Attrs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Index"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uint32")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("link"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Attrs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Index"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" err\n\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br")])]),a("p",[a("code",[t._v("Detach()")]),t._v("も同様に定義しておき"),a("code",[t._v("defer")]),t._v("に渡しておきます．\nそのあとは"),a("code",[t._v("Ctrl + c")]),t._v("での終了処理を行うのみです．")]),t._v(" "),a("div",{staticClass:"language-gov line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('if err := Attach(infList, collect.Prog, collect.IfRedirect); err != nil {\n\t\tpanic(err)\n}\ndefer Detach(infList)\n\nctrlC := make(chan os.Signal, 1)\nsignal.Notify(ctrlC, os.Interrupt)\nfor {\n\tselect {\n\tcase <-ctrlC:\n\t\tfmt.Println("\\nDetaching program and exit")\n\t\treturn\n\t}\n}\n')])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br")])]),a("h5",{attrs:{id:"実行-4"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#実行-4"}},[t._v("#")]),t._v(" 実行")]),t._v(" "),a("p",[t._v("それでは動かしてみましょう．\n今回も"),a("code",[t._v("netns")]),t._v("で実験を行います．")]),t._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ go generate\n$ go build "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" ./netns.sh build\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br")])]),a("p",[t._v("それでは動かしてみます．\n今回は以下のようにこれまでと少し異なる環境を用意しています．\n"),a("img",{attrs:{src:"/img/xdp-example-network-2.png",alt:"xdp-example-network-2.png"}})]),t._v(" "),a("p",[t._v("XDPプログラムは"),a("code",[t._v("node1")]),t._v("で"),a("code",[t._v("veth1")]),t._v("と"),a("code",[t._v("veth2")]),t._v("にアタッチします．")]),t._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ip")]),t._v(" netns "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exec")]),t._v(" node1 ./bpf_redirect_map -iflist veth1,veth2\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("コンソールが返ってこなければ正常に動作しています．\n今回は特に何も出力してくれないので別ターミナルで"),a("code",[t._v("ping")]),t._v("と"),a("code",[t._v("tcpdump")]),t._v("を使って確認します．")]),t._v(" "),a("p",[t._v("それでは"),a("code",[t._v("192.168.1.5")]),t._v("に"),a("code",[t._v("ping")]),t._v("を飛ばしてみます．その様子を"),a("code",[t._v("tcpdump")]),t._v("で確認します．")]),t._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ping")]),t._v(" -c "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".1.5\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("まずは"),a("code",[t._v("bpf_redirect_map")]),t._v("を動かさない状態でパケットを確認します．")]),t._v(" "),a("h6",{attrs:{id:"bpf-redirect-mapなし"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#bpf-redirect-mapなし"}},[t._v("#")]),t._v(" bpf_redirect_mapなし")]),t._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" tcpdump -i veth0 -n -vvv\ntcpdump: listening on veth0, link-type EN10MB "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Ethernet"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(", capture size "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("262144")]),t._v(" bytes\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),t._v(":09:49.160300 IP "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tos 0x0, ttl "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("id")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("19056")]),t._v(", offset "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(", flags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("DF"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(", proto ICMP "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(", length "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("84")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".0.3 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".1.5: ICMP "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" request, "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("id")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("57")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("seq")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(", length "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),t._v(":09:49.160339 IP "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tos 0x0, ttl "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("63")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("id")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("13495")]),t._v(", offset "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(", flags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(", proto ICMP "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(", length "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("84")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".1.5 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".0.3: ICMP "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" reply, "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("id")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("57")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("seq")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(", length "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v("\n^C\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" packets captured\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" packets received by filter\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" packets dropped by kernel\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br")])]),a("p",[t._v("このようにecho request, replyが一往復みられます．")]),t._v(" "),a("p",[t._v("つぎに"),a("code",[t._v("bpf_redirect_map")]),t._v("を動かした状態で同様に"),a("code",[t._v("ping")]),t._v("を飛ばしてみます．")]),t._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ip")]),t._v(" netns "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exec")]),t._v(" node1 ./bpf_redirect_map -iflist veth1,veth2\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("h6",{attrs:{id:"bpf-redirect-mapあり"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#bpf-redirect-mapあり"}},[t._v("#")]),t._v(" bpf_redirect_mapあり")]),t._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" tcpdump -i veth0 -n -vvv\ntcpdump: listening on veth0, link-type EN10MB "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Ethernet"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(", capture size "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("262144")]),t._v(" bytes\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),t._v(":13:10.304324 IP "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tos 0x0, ttl "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("id")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("29369")]),t._v(", offset "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(", flags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("DF"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(", proto ICMP "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(", length "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("84")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".0.3 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".1.5: ICMP "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" request, "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("id")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("58")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("seq")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(", length "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),t._v(":13:10.304357 IP "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tos 0x0, ttl "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("id")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("29369")]),t._v(", offset "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(", flags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("DF"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(", proto ICMP "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(", length "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("84")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".1.5 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".0.3: ICMP "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" request, "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("id")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("58")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("seq")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(", length "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),t._v(":13:10.304493 IP "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tos 0x0, ttl "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("id")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("29370")]),t._v(", offset "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(", flags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(", proto ICMP "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(", length "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("84")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".0.3 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".1.5: ICMP "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" reply, "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("id")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("58")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("seq")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(", length "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),t._v(":13:10.304500 IP "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tos 0x0, ttl "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("id")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("29370")]),t._v(", offset "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(", flags "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(", proto ICMP "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(", length "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("84")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".1.5 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".0.3: ICMP "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" reply, "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("id")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("58")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("seq")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(", length "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v("\n^C\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v(" packets captured\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v(" packets received by filter\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" packets dropped by kernel\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br")])]),a("p",[t._v("今度は4つパケットがキャプチャされています．\nICMPのIDをみてみるとどのパケットも58となっています．\n一方で宛先と送信元が入れ替わっているパケットがみられます．")]),t._v(" "),a("p",[t._v("このようにNICからNICへのリダイレクト処理もXDPで行うことができます．")]),t._v(" "),a("p",[t._v("実験終了後には"),a("code",[t._v("netns")]),t._v("をお掃除しましょう．")]),t._v(" "),a("h2",{attrs:{id:"おわりに"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#おわりに"}},[t._v("#")]),t._v(" おわりに")]),t._v(" "),a("p",[t._v("今回はXDPに入門してみました．\nだいぶ大作な記事になってしまいました．")]),t._v(" "),a("p",[t._v("XDPの概要やXDPを扱うために必要な周辺知識の紹介，実践編と段階的にXDPを理解できるように書きました．\n結構ハマりどころが多い技術なので，私が勉強する際にハマった箇所はできるだけ書き起こしました．\nXDP関連の日本語の記事はあまり多くないため参考になれば幸いです．")]),t._v(" "),a("p",[t._v("XDPでパケット処理しましょう．")]),t._v(" "),a("h2",{attrs:{id:"参考"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[t._v("#")]),t._v(" 参考")]),t._v(" "),a("h3",{attrs:{id:"日本語"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#日本語"}},[t._v("#")]),t._v(" 日本語")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"http://gundam-hathaway.net/mecha.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://gundam-hathaway.net/mecha.html"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://yunazuno.hatenablog.com/entry/2016/10/11/090245",target:"_blank",rel:"noopener noreferrer"}},[t._v("Linuxカーネルの新機能 XDP (eXpress Data Path) を触ってみる"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://atmarkit.itmedia.co.jp/ait/articles/1811/21/news010.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("パケットフィルターでトレーシング？　Linuxで活用が進む「Berkeley Packet Filter（BPF）」とは何か"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://blog.bobuhiro11.net/2020/09-17-xdp.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("XDPメモ（アーキテクチャ、性能、ユースケース）"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://speakerdeck.com/yunazuno/brief-summary-of-xdp-and-use-case-at-line",target:"_blank",rel:"noopener noreferrer"}},[t._v("eXpress Data Path (XDP) の概要とLINEにおける利活用"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://www.janog.gr.jp/meeting/janog45/application/files/1615/7984/1029/008_pktfwd-xdp_kusakabe_00.pdf",target:"_blank",rel:"noopener noreferrer"}},[t._v("パケット処理の独自実装や高速化手法の比較と実践"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://speakerdeck.com/mabuchin/zhuan-binagaramonetutowakuchu-li-wo-sohutoueadezi-zuo-siteikuhua",target:"_blank",rel:"noopener noreferrer"}},[t._v("転びながらもネットワーク処理をソフトウェアで自作していく話"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://yunazuno.hatenablog.com/entry/2017/06/12/094101",target:"_blank",rel:"noopener noreferrer"}},[t._v("Generic XDPを使えばXDP動作環境がお手軽に構築できるようになった"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://takeio.hatenablog.com/entry/2019/12/05/212945",target:"_blank",rel:"noopener noreferrer"}},[t._v("今日から始めるXDPと取り巻く環境について"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://takeio.hatenablog.com/entry/2021/01/26/180129",target:"_blank",rel:"noopener noreferrer"}},[t._v("Go+XDPな開発を始めるときに参考になる記事/janog LT フォローアップ"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://chipa34.hatenadiary.org/entry/20081217/1229479548",target:"_blank",rel:"noopener noreferrer"}},[t._v("ヘッダ構造体メモ"),a("OutboundLink")],1)])]),t._v(" "),a("h3",{attrs:{id:"英語"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#英語"}},[t._v("#")]),t._v(" 英語")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://man7.org/linux/man-pages/man2/bpf.2.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("bpf(2) - Linux manual page - man7.org"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://man7.org/linux/man-pages/man7/bpf-helpers.7.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("bpf-helpers(7) - Linux manual page - man7.org"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://www.iovisor.org/technology/xdp",target:"_blank",rel:"noopener noreferrer"}},[t._v("XDP - IO Visor Project"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://www.linuxplumbersconf.org/event/2/contributions/71/attachments/17/9/presentation-lpc2018-xdp-tutorial.pdf",target:"_blank",rel:"noopener noreferrer"}},[t._v("A practical introduction to XDP"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://blog.cloudflare.com/l4drop-xdp-ebpf-based-ddos-mitigations/",target:"_blank",rel:"noopener noreferrer"}},[t._v("L4Drop: XDP DDoS Mitigations"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://engineering.fb.com/2018/05/22/open-source/open-sourcing-katran-a-scalable-network-load-balancer/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Open-sourcing Katran, a scalable network load balancer"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://prototype-kernel.readthedocs.io/en/latest/networking/XDP/implementation/xdp_actions.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("XDP Actions"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://blogs.oracle.com/linux/post/bpf-in-depth-communicating-with-userspace",target:"_blank",rel:"noopener noreferrer"}},[t._v("BPF In Depth: Communicating with Userspace"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://docs.cilium.io/en/stable/bpf/#llvm",target:"_blank",rel:"noopener noreferrer"}},[t._v("cilium docs bpf #llvm"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://medium.com/@christina.jacob.koikara/how-to-compile-a-kernel-with-xdp-support-c245ed3460f1",target:"_blank",rel:"noopener noreferrer"}},[t._v("How to compile a kernel with XDP support"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://pingcap.com/blog/tips-and-tricks-for-writing-linux-bpf-applications-with-libbpf#reduce-pre-allocation-overhead",target:"_blank",rel:"noopener noreferrer"}},[t._v("Reduce pre-allocation overhead"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://github.com/cilium/ebpf",target:"_blank",rel:"noopener noreferrer"}},[t._v("cilium/ebpf"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://github.com/dropbox/goebpf",target:"_blank",rel:"noopener noreferrer"}},[t._v("dropbox/goebpf"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://github.com/vishvananda/netlink",target:"_blank",rel:"noopener noreferrer"}},[t._v("vishvananda/netlink"),a("OutboundLink")],1)])])],1)}),[],!1,null,null,null);s.default=r.exports}}]);